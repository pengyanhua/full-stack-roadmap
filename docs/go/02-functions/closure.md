# closure.go

::: info æ–‡ä»¶ä¿¡æ¯
- ğŸ“„ åŸæ–‡ä»¶ï¼š`04_closure.go`
- ğŸ”¤ è¯­è¨€ï¼šgo
:::

## å®Œæ•´ä»£ç 

```go
package main

import "fmt"

// ============================================================
//                      åŒ¿åå‡½æ•°ä¸é—­åŒ…
// ============================================================
// åŒ¿åå‡½æ•°ï¼šæ²¡æœ‰åå­—çš„å‡½æ•°ï¼Œå¯ä»¥åœ¨éœ€è¦æ—¶å®šä¹‰
// é—­åŒ…ï¼šå¯ä»¥è®¿é—®å…¶å¤–éƒ¨ä½œç”¨åŸŸå˜é‡çš„å‡½æ•°
//
// ã€æ ¸å¿ƒæ¦‚å¿µã€‘é—­åŒ… = å‡½æ•° + å¼•ç”¨ç¯å¢ƒ
// é—­åŒ…ä¼š"æ•è·"å¤–éƒ¨å˜é‡ï¼Œå³ä½¿å¤–éƒ¨å‡½æ•°å·²è¿”å›

func main04() {
	fmt.Println("\n==================== 04_closure ====================")
	fmt.Println("=== åŒ¿åå‡½æ•° ===")

	// ----------------------------------------------------------
	// å®šä¹‰å¹¶ç«‹å³è°ƒç”¨
	// ----------------------------------------------------------
	// è¯­æ³•: func(å‚æ•°) è¿”å›ç±»å‹ { å‡½æ•°ä½“ }(å®å‚)
	result := func(a, b int) int {
		return a + b
	}(3, 4) // ç«‹å³è°ƒç”¨

	fmt.Println("ç«‹å³è°ƒç”¨åŒ¿åå‡½æ•°: 3 + 4 =", result)

	// ----------------------------------------------------------
	// èµ‹å€¼ç»™å˜é‡
	// ----------------------------------------------------------
	// åŒ¿åå‡½æ•°å¯ä»¥èµ‹å€¼ç»™å˜é‡ï¼Œä¹‹åé€šè¿‡å˜é‡è°ƒç”¨
	multiply := func(a, b int) int {
		return a * b
	}

	fmt.Println("multiply(5, 6) =", multiply(5, 6))
	fmt.Println("multiply(7, 8) =", multiply(7, 8))

	// å¯ä»¥é‡æ–°èµ‹å€¼
	multiply = func(a, b int) int {
		return a * b * 2 // ä¸åŒçš„å®ç°
	}
	fmt.Println("æ–° multiply(5, 6) =", multiply(5, 6))

	// ----------------------------------------------------------
	// é—­åŒ…ï¼šæ•è·å¤–éƒ¨å˜é‡
	// ----------------------------------------------------------
	fmt.Println("\n=== é—­åŒ…åŸºç¡€ ===")

	// å¤–éƒ¨å˜é‡
	counter := 0

	// é—­åŒ…æ•è· counter
	increment := func() {
		counter++ // è®¿é—®å¹¶ä¿®æ”¹å¤–éƒ¨å˜é‡
		fmt.Println("counter =", counter)
	}

	increment() // counter = 1
	increment() // counter = 2
	increment() // counter = 3

	fmt.Println("å¤–éƒ¨ counter =", counter) // 3

	// ----------------------------------------------------------
	// é—­åŒ…å·¥å‚ï¼šè¿”å›é—­åŒ…
	// ----------------------------------------------------------
	fmt.Println("\n=== é—­åŒ…å·¥å‚ ===")

	// æ¯æ¬¡è°ƒç”¨ makeCounter éƒ½åˆ›å»ºæ–°çš„è®¡æ•°å™¨
	counter1 := makeCounter()
	counter2 := makeCounter()

	fmt.Println("counter1:", counter1()) // 1
	fmt.Println("counter1:", counter1()) // 2
	fmt.Println("counter1:", counter1()) // 3

	fmt.Println("counter2:", counter2()) // 1ï¼ˆç‹¬ç«‹çš„è®¡æ•°å™¨ï¼‰
	fmt.Println("counter2:", counter2()) // 2

	fmt.Println("counter1:", counter1()) // 4ï¼ˆç»§ç»­è‡ªå·±çš„è®¡æ•°ï¼‰

	// ----------------------------------------------------------
	// å¸¦å‚æ•°çš„é—­åŒ…å·¥å‚
	// ----------------------------------------------------------
	fmt.Println("\n=== å¸¦å‚æ•°çš„é—­åŒ…å·¥å‚ ===")

	addFive := makeAdder(5)
	addTen := makeAdder(10)

	fmt.Println("addFive(3) =", addFive(3))   // 8
	fmt.Println("addTen(3) =", addTen(3))     // 13
	fmt.Println("addFive(10) =", addFive(10)) // 15

	// ----------------------------------------------------------
	// é—­åŒ…é™·é˜±ï¼šå¾ªç¯å˜é‡
	// ----------------------------------------------------------
	fmt.Println("\n=== é—­åŒ…é™·é˜±ï¼šå¾ªç¯å˜é‡ ===")

	// ã€é”™è¯¯ç¤ºä¾‹ã€‘
	fmt.Println("é”™è¯¯æ–¹å¼:")
	var funcsWrong []func()
	for i := 0; i < 3; i++ {
		funcsWrong = append(funcsWrong, func() {
			fmt.Println("  i =", i) // æ•è·çš„æ˜¯åŒä¸€ä¸ª i
		})
	}
	for _, f := range funcsWrong {
		f() // å…¨éƒ¨è¾“å‡º 3ï¼
	}

	// ã€æ­£ç¡®ç¤ºä¾‹1ã€‘ä½¿ç”¨å‚æ•°ä¼ é€’
	fmt.Println("æ­£ç¡®æ–¹å¼1ï¼ˆå‚æ•°ä¼ é€’ï¼‰:")
	var funcsRight1 []func()
	for i := 0; i < 3; i++ {
		funcsRight1 = append(funcsRight1, func(n int) func() {
			return func() {
				fmt.Println("  n =", n)
			}
		}(i)) // ç«‹å³ä¼ é€’å½“å‰å€¼
	}
	for _, f := range funcsRight1 {
		f()
	}

	// ã€æ­£ç¡®ç¤ºä¾‹2ã€‘åˆ›å»ºå±€éƒ¨å˜é‡ï¼ˆGo 1.22+ å¾ªç¯å˜é‡å·²æ”¹è¿›ï¼‰
	fmt.Println("æ­£ç¡®æ–¹å¼2ï¼ˆå±€éƒ¨å˜é‡ï¼‰:")
	var funcsRight2 []func()
	for i := 0; i < 3; i++ {
		i := i // åˆ›å»ºæ–°çš„å±€éƒ¨å˜é‡
		funcsRight2 = append(funcsRight2, func() {
			fmt.Println("  i =", i)
		})
	}
	for _, f := range funcsRight2 {
		f()
	}

	// ----------------------------------------------------------
	// é—­åŒ…ç”¨é€”ï¼šå»¶è¿Ÿæ‰§è¡Œ
	// ----------------------------------------------------------
	fmt.Println("\n=== é—­åŒ…ç”¨é€”ï¼šdefer ===")

	demoDefer()

	// ----------------------------------------------------------
	// é—­åŒ…ç”¨é€”ï¼šå›è°ƒå‡½æ•°
	// ----------------------------------------------------------
	fmt.Println("\n=== é—­åŒ…ç”¨é€”ï¼šå›è°ƒ ===")

	numbers := []int{1, 2, 3, 4, 5, 6, 7, 8, 9, 10}

	// ä½¿ç”¨é—­åŒ…ä½œä¸ºè¿‡æ»¤æ¡ä»¶
	evens := filter(numbers, func(n int) bool {
		return n%2 == 0
	})
	fmt.Println("å¶æ•°:", evens)

	// ä½¿ç”¨é—­åŒ…ä½œä¸ºæ˜ å°„å‡½æ•°
	doubled := mapSlice(numbers, func(n int) int {
		return n * 2
	})
	fmt.Println("ç¿»å€:", doubled)

	// ----------------------------------------------------------
	// é—­åŒ…ç”¨é€”ï¼šçŠ¶æ€å°è£…
	// ----------------------------------------------------------
	fmt.Println("\n=== é—­åŒ…ç”¨é€”ï¼šçŠ¶æ€å°è£… ===")

	// ç±»ä¼¼äºé¢å‘å¯¹è±¡çš„ç§æœ‰çŠ¶æ€
	acc := makeAccumulator(100)
	fmt.Println("åˆå§‹ä½™é¢: 100")
	fmt.Println("å­˜æ¬¾ 50:", acc(50))
	fmt.Println("å–æ¬¾ -30:", acc(-30))
	fmt.Println("å­˜æ¬¾ 20:", acc(20))

	// ----------------------------------------------------------
	// é—­åŒ… vs ç»“æ„ä½“æ–¹æ³•
	// ----------------------------------------------------------
	fmt.Println("\n=== é—­åŒ… vs ç»“æ„ä½“ ===")

	// é—­åŒ…æ–¹å¼
	fib := makeFibonacci()
	fmt.Print("æ–æ³¢é‚£å¥‘ï¼ˆé—­åŒ…ï¼‰: ")
	for i := 0; i < 10; i++ {
		fmt.Print(fib(), " ")
	}
	fmt.Println()

	// ç»“æ„ä½“æ–¹å¼ï¼ˆè§ 05_methods.goï¼‰
}

// ============================================================
//                      é—­åŒ…å‡½æ•°å®šä¹‰
// ============================================================

// ----------------------------------------------------------
// é—­åŒ…å·¥å‚ï¼šè®¡æ•°å™¨
// ----------------------------------------------------------
// æ¯æ¬¡è°ƒç”¨è¿”å›ä¸€ä¸ªæ–°çš„è®¡æ•°å™¨å‡½æ•°
// æ¯ä¸ªè®¡æ•°å™¨æœ‰è‡ªå·±ç‹¬ç«‹çš„ count å˜é‡
func makeCounter() func() int {
	count := 0 // è¿™ä¸ªå˜é‡è¢«é—­åŒ…æ•è·
	return func() int {
		count++
		return count
	}
}

// ----------------------------------------------------------
// é—­åŒ…å·¥å‚ï¼šåŠ æ³•å™¨
// ----------------------------------------------------------
// è¿”å›ä¸€ä¸ª"åŠ  n"çš„å‡½æ•°
func makeAdder(n int) func(int) int {
	// n è¢«é—­åŒ…æ•è·
	return func(x int) int {
		return x + n
	}
}

// ----------------------------------------------------------
// é—­åŒ…å·¥å‚ï¼šç´¯åŠ å™¨
// ----------------------------------------------------------
func makeAccumulator(initial int) func(int) int {
	balance := initial
	return func(amount int) int {
		balance += amount
		return balance
	}
}

// ----------------------------------------------------------
// é—­åŒ…å·¥å‚ï¼šæ–æ³¢é‚£å¥‘ç”Ÿæˆå™¨
// ----------------------------------------------------------
func makeFibonacci() func() int {
	a, b := 0, 1
	return func() int {
		result := a
		a, b = b, a+b
		return result
	}
}

// ----------------------------------------------------------
// defer ä¸­çš„é—­åŒ…
// ----------------------------------------------------------
func demoDefer() {
	x := 10

	// æ–¹å¼1: ç›´æ¥ä¼ å€¼ï¼ˆå€¼åœ¨ defer æ—¶ç¡®å®šï¼‰
	defer fmt.Printf("  defer ä¼ å€¼: x = %d\n", x)

	// æ–¹å¼2: é—­åŒ…æ•è·ï¼ˆå€¼åœ¨æ‰§è¡Œæ—¶ç¡®å®šï¼‰
	defer func() {
		fmt.Printf("  defer é—­åŒ…: x = %d\n", x)
	}()

	x = 20
	fmt.Println("  å‡½æ•°ä¸­: x =", x)
}

// ----------------------------------------------------------
// é«˜é˜¶å‡½æ•°ï¼šè¿‡æ»¤
// ----------------------------------------------------------
func filter(nums []int, predicate func(int) bool) []int {
	result := []int{}
	for _, n := range nums {
		if predicate(n) {
			result = append(result, n)
		}
	}
	return result
}

// ----------------------------------------------------------
// é«˜é˜¶å‡½æ•°ï¼šæ˜ å°„
// ----------------------------------------------------------
func mapSlice(nums []int, mapper func(int) int) []int {
	result := make([]int, len(nums))
	for i, n := range nums {
		result[i] = mapper(n)
	}
	return result
}

// ============================================================
//                      é‡è¦æ³¨æ„äº‹é¡¹
// ============================================================
//
// 1. ã€é—­åŒ…æ•è·å˜é‡çš„å¼•ç”¨ï¼Œä¸æ˜¯å€¼ã€‘
//    å¤–éƒ¨å˜é‡æ”¹å˜ï¼Œé—­åŒ…çœ‹åˆ°çš„å€¼ä¹Ÿå˜
//    é—­åŒ…ä¿®æ”¹å˜é‡ï¼Œå¤–éƒ¨ä¹Ÿèƒ½çœ‹åˆ°
//
// 2. ã€å¾ªç¯å˜é‡é™·é˜±ã€‘
//    Go 1.22 ä¹‹å‰ï¼Œå¾ªç¯å˜é‡æ˜¯å…±äº«çš„
//    Go 1.22+ï¼Œæ¯æ¬¡è¿­ä»£åˆ›å»ºæ–°å˜é‡
//    å»ºè®®ï¼šæ€»æ˜¯æ˜¾å¼åˆ›å»ºå±€éƒ¨å˜é‡
//
// 3. ã€å†…å­˜è€ƒè™‘ã€‘
//    é—­åŒ…ä¼šæŒæœ‰å¤–éƒ¨å˜é‡çš„å¼•ç”¨
//    å¯èƒ½å¯¼è‡´å˜é‡æ— æ³•è¢«åƒåœ¾å›æ”¶
//    é•¿æœŸè¿è¡Œçš„é—­åŒ…è¦æ³¨æ„å†…å­˜æ³„æ¼
//
// 4. ã€é—­åŒ… vs æ–¹æ³•ã€‘
//    é—­åŒ…ï¼šé€‚åˆç®€å•çŠ¶æ€ã€ä¸´æ—¶ä½¿ç”¨
//    æ–¹æ³•ï¼šé€‚åˆå¤æ‚çŠ¶æ€ã€éœ€è¦å¤šä¸ªæ“ä½œ
//
// 5. ã€å¸¸è§ç”¨é€”ã€‘
//    - å»¶è¿Ÿè®¡ç®—
//    - å›è°ƒå‡½æ•°
//    - çŠ¶æ€å°è£…
//    - å·¥å‚å‡½æ•°
//    - è£…é¥°å™¨æ¨¡å¼
//
// 6. ã€è°ƒè¯•å›°éš¾ã€‘
//    é—­åŒ…æ²¡æœ‰åå­—ï¼Œè°ƒè¯•æ—¶æ ˆä¿¡æ¯ä¸æ¸…æ™°
//    å¤æ‚åœºæ™¯è€ƒè™‘ä½¿ç”¨å‘½åå‡½æ•°æˆ–æ–¹æ³•
```
