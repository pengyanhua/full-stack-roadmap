# borrowing.rs

::: info æ–‡ä»¶ä¿¡æ¯
- ğŸ“„ åŸæ–‡ä»¶ï¼š`02_borrowing.rs`
- ğŸ”¤ è¯­è¨€ï¼šrust
:::

## å®Œæ•´ä»£ç 

```rust
// ============================================================
//                      å€Ÿç”¨ä¸å¼•ç”¨ï¼ˆBorrowing & Referencesï¼‰
// ============================================================
// å€Ÿç”¨æ˜¯ Rust ä¸­ä¸è½¬ç§»æ‰€æœ‰æƒå°±èƒ½ä½¿ç”¨æ•°æ®çš„æœºåˆ¶
// å¼•ç”¨ï¼ˆ&Tï¼‰å°±åƒæŒ‡é’ˆï¼Œä½†ä¿è¯æœ‰æ•ˆï¼ˆä¸ä¼šæ‚¬å‚ï¼‰
//
// å€Ÿç”¨è§„åˆ™ï¼ˆRust ç¼–è¯‘å™¨å¼ºåˆ¶æ‰§è¡Œï¼‰ï¼š
// 1. åœ¨ä»»æ„æ—¶åˆ»ï¼Œè¦ä¹ˆåªèƒ½æœ‰ä¸€ä¸ªå¯å˜å¼•ç”¨ï¼ˆ&mut Tï¼‰ï¼Œ
//    è¦ä¹ˆå¯ä»¥æœ‰å¤šä¸ªä¸å¯å˜å¼•ç”¨ï¼ˆ&Tï¼‰
// 2. å¼•ç”¨å¿…é¡»å§‹ç»ˆæœ‰æ•ˆï¼ˆä¸èƒ½æ‚¬å‚ï¼‰
//
// ã€è®°å¿†å£è¯€ã€‘"å¯ä»¥æœ‰å¾ˆå¤šè¯»è€…ï¼Œæˆ–è€…ä¸€ä¸ªå†™è€…ï¼Œä½†ä¸èƒ½åŒæ—¶"

fn main() {
    println!("=== å€Ÿç”¨ä¸å¼•ç”¨ ===");

    // ----------------------------------------------------------
    // 1. ä¸å¯å˜å¼•ç”¨ï¼ˆ&Tï¼‰
    // ----------------------------------------------------------
    // ä½¿ç”¨ & åˆ›å»ºå¼•ç”¨ï¼Œä¸è·å–æ‰€æœ‰æƒ
    // å¯ä»¥åŒæ—¶æœ‰å¤šä¸ªä¸å¯å˜å¼•ç”¨

    let s1 = String::from("hello");
    let len = calculate_length(&s1);  // å€Ÿç”¨ s1ï¼Œä¸ç§»åŠ¨
    println!("'{}' çš„é•¿åº¦æ˜¯ {}", s1, len);  // s1 ä»ç„¶æœ‰æ•ˆ

    // å¤šä¸ªä¸å¯å˜å¼•ç”¨ â€” OK
    let r1 = &s1;
    let r2 = &s1;
    println!("å¤šä¸ªä¸å¯å˜å¼•ç”¨: {}, {}", r1, r2);

    // ----------------------------------------------------------
    // 2. å¯å˜å¼•ç”¨ï¼ˆ&mut Tï¼‰
    // ----------------------------------------------------------
    // ä½¿ç”¨ &mut åˆ›å»ºå¯å˜å¼•ç”¨ï¼Œå¯ä»¥ä¿®æ”¹å€Ÿç”¨çš„æ•°æ®
    // ã€é™åˆ¶ã€‘åŒä¸€æ—¶åˆ»åªèƒ½æœ‰ä¸€ä¸ªå¯å˜å¼•ç”¨

    let mut s2 = String::from("hello");
    change(&mut s2);
    println!("ä¿®æ”¹å: {}", s2);

    // åŒä¸€ä½œç”¨åŸŸä¸­åªèƒ½æœ‰ä¸€ä¸ªå¯å˜å¼•ç”¨
    let mut s = String::from("hello");
    let r1 = &mut s;
    // let r2 = &mut s;  // é”™è¯¯ï¼ä¸èƒ½åŒæ—¶æœ‰ä¸¤ä¸ªå¯å˜å¼•ç”¨
    r1.push_str(" world");
    println!("å¯å˜å¼•ç”¨: {}", r1);

    // ã€åŸå› ã€‘é˜²æ­¢æ•°æ®ç«äº‰ï¼ˆdata raceï¼‰
    // æ•°æ®ç«äº‰å‘ç”Ÿåœ¨ä»¥ä¸‹ä¸‰ä¸ªæ¡ä»¶åŒæ—¶æ»¡è¶³æ—¶ï¼š
    // 1. ä¸¤ä¸ªæˆ–æ›´å¤šæŒ‡é’ˆåŒæ—¶è®¿é—®åŒä¸€æ•°æ®
    // 2. è‡³å°‘ä¸€ä¸ªæŒ‡é’ˆç”¨äºå†™å…¥
    // 3. æ²¡æœ‰åŒæ­¥æœºåˆ¶

    // ----------------------------------------------------------
    // 3. ä¸å¯å˜å¼•ç”¨å’Œå¯å˜å¼•ç”¨ä¸èƒ½å…±å­˜
    // ----------------------------------------------------------
    let mut s = String::from("hello");

    let r1 = &s;     // OKï¼šä¸å¯å˜å¼•ç”¨
    let r2 = &s;     // OKï¼šå¯ä»¥æœ‰å¤šä¸ªä¸å¯å˜å¼•ç”¨
    println!("ä¸å¯å˜å¼•ç”¨: {}, {}", r1, r2);
    // r1 å’Œ r2 åœ¨è¿™ä¹‹åä¸å†ä½¿ç”¨ï¼ˆNLL: Non-Lexical Lifetimesï¼‰

    let r3 = &mut s;  // OKï¼šå› ä¸º r1, r2 å·²ç»ä¸å†ä½¿ç”¨
    r3.push_str(" world");
    println!("å¯å˜å¼•ç”¨: {}", r3);

    // ã€NLL (Non-Lexical Lifetimes)ã€‘
    // Rust 2018 ä¹‹åï¼Œå¼•ç”¨çš„ç”Ÿå‘½å‘¨æœŸåœ¨æœ€åä¸€æ¬¡ä½¿ç”¨æ—¶ç»“æŸï¼ˆä¸æ˜¯ä½œç”¨åŸŸç»“æŸï¼‰
    // è¿™è®©å€Ÿç”¨è§„åˆ™æ›´çµæ´»ï¼Œä¸Šé¢çš„ä»£ç å› æ­¤å¯ä»¥ç¼–è¯‘

    // ----------------------------------------------------------
    // 4. æ‚¬å‚å¼•ç”¨ï¼ˆDangling Referenceï¼‰
    // ----------------------------------------------------------
    // Rust ç¼–è¯‘å™¨ä¿è¯å¼•ç”¨æ°¸è¿œä¸ä¼šæ‚¬å‚
    // å¦‚æœä½ æœ‰ä¸€ä¸ªå¼•ç”¨ï¼Œç¼–è¯‘å™¨ç¡®ä¿æ•°æ®åœ¨å¼•ç”¨ä¹‹å‰ä¸ä¼šç¦»å¼€ä½œç”¨åŸŸ

    // fn dangle() -> &String {  // é”™è¯¯ï¼
    //     let s = String::from("hello");
    //     &s  // s åœ¨å‡½æ•°ç»“æŸæ—¶è¢«é‡Šæ”¾ï¼Œå¼•ç”¨å°†æ‚¬å‚
    // }

    // æ­£ç¡®åšæ³•ï¼šè¿”å›æ‰€æœ‰æƒ
    fn no_dangle() -> String {
        let s = String::from("hello");
        s  // ç§»åŠ¨æ‰€æœ‰æƒç»™è°ƒç”¨è€…
    }
    let s = no_dangle();
    println!("æ— æ‚¬å‚: {}", s);

    // ----------------------------------------------------------
    // 5. åˆ‡ç‰‡å¼•ç”¨ï¼ˆSlicesï¼‰
    // ----------------------------------------------------------
    // åˆ‡ç‰‡æ˜¯å¯¹é›†åˆçš„éƒ¨åˆ†å¼•ç”¨ï¼Œæ²¡æœ‰æ‰€æœ‰æƒ
    // ã€ç±»å‹ã€‘&str æ˜¯å­—ç¬¦ä¸²åˆ‡ç‰‡ï¼Œ&[T] æ˜¯æ•°ç»„åˆ‡ç‰‡

    // å­—ç¬¦ä¸²åˆ‡ç‰‡
    let s = String::from("hello world");
    let hello = &s[0..5];   // æˆ– &s[..5]
    let world = &s[6..11];  // æˆ– &s[6..]
    let whole = &s[..];     // æ•´ä¸ªå­—ç¬¦ä¸²
    println!("åˆ‡ç‰‡: '{}' '{}' '{}'", hello, world, whole);

    // ã€æ³¨æ„ã€‘å­—ç¬¦ä¸²åˆ‡ç‰‡çš„ç´¢å¼•æ˜¯å­—èŠ‚ä½ç½®ï¼Œä¸æ˜¯å­—ç¬¦ä½ç½®
    // å¯¹äº UTF-8 ä¸­æ–‡å­—ç¬¦ï¼ˆ3å­—èŠ‚ï¼‰ï¼Œå¿…é¡»åœ¨å­—ç¬¦è¾¹ç•Œåˆ‡å‰²
    let chinese = String::from("ä½ å¥½ä¸–ç•Œ");
    let ni_hao = &chinese[0..6];  // "ä½ å¥½"ï¼ˆæ¯ä¸ªä¸­æ–‡3å­—èŠ‚ï¼‰
    println!("ä¸­æ–‡åˆ‡ç‰‡: {}", ni_hao);
    // let bad = &chinese[0..1];  // panicï¼ä¸åœ¨å­—ç¬¦è¾¹ç•Œä¸Š

    // æ•°ç»„åˆ‡ç‰‡
    let arr = [1, 2, 3, 4, 5];
    let slice = &arr[1..3];  // [2, 3]
    println!("æ•°ç»„åˆ‡ç‰‡: {:?}", slice);

    // ã€å®ç”¨ã€‘first_word ç¤ºä¾‹
    let sentence = String::from("hello world");
    let word = first_word(&sentence);
    println!("ç¬¬ä¸€ä¸ªå•è¯: {}", word);

    // åˆ‡ç‰‡ç¡®ä¿äº†å¼•ç”¨çš„æœ‰æ•ˆæ€§
    // let mut s = String::from("hello world");
    // let word = first_word(&s);  // ä¸å¯å˜å€Ÿç”¨
    // s.clear();  // é”™è¯¯ï¼ä¸èƒ½ä¿®æ”¹ï¼Œå› ä¸º word è¿˜åœ¨ä½¿ç”¨ä¸å¯å˜å¼•ç”¨
    // println!("{}", word);

    // ----------------------------------------------------------
    // 6. å€Ÿç”¨çš„å®é™…åº”ç”¨æ¨¡å¼
    // ----------------------------------------------------------
    println!("\n=== å®é™…åº”ç”¨ ===");

    // æ¨¡å¼1: åªè¯»è®¿é—®ç”¨ä¸å¯å˜å¼•ç”¨
    let data = vec![1, 2, 3, 4, 5];
    let sum = sum_vec(&data);
    let max = max_vec(&data);
    println!("data={:?}, sum={}, max={}", data, sum, max);

    // æ¨¡å¼2: éœ€è¦ä¿®æ”¹ç”¨å¯å˜å¼•ç”¨
    let mut scores = vec![85, 92, 78, 96, 88];
    add_bonus(&mut scores, 5);
    println!("åŠ åˆ†å: {:?}", scores);

    // æ¨¡å¼3: æ–¹æ³•ä¸­çš„å€Ÿç”¨
    let text = String::from("Hello, Rust! Welcome to Rust programming.");
    let stats = TextStats::new(&text);
    println!("å­—ç¬¦æ•°={}, å•è¯æ•°={}, è¡Œæ•°={}", stats.chars, stats.words, stats.lines);

    println!("\n=== å€Ÿç”¨ä¸å¼•ç”¨ç»“æŸ ===");
}

// ----------------------------------------------------------
// ä¸å¯å˜å€Ÿç”¨å‚æ•°
// ----------------------------------------------------------
fn calculate_length(s: &String) -> usize {
    s.len()
} // s åªæ˜¯å¼•ç”¨ï¼Œç¦»å¼€ä½œç”¨åŸŸä¸ä¼šé‡Šæ”¾æ•°æ®

// ----------------------------------------------------------
// å¯å˜å€Ÿç”¨å‚æ•°
// ----------------------------------------------------------
fn change(s: &mut String) {
    s.push_str(", world");
}

// ----------------------------------------------------------
// è¿”å›åˆ‡ç‰‡å¼•ç”¨
// ----------------------------------------------------------
fn first_word(s: &str) -> &str {
    // ã€æŠ€å·§ã€‘å‚æ•°ç±»å‹ç”¨ &str è€Œä¸æ˜¯ &String
    // è¿™æ · String å’Œ &str éƒ½èƒ½ä¼ å…¥ï¼ˆæ›´çµæ´»ï¼‰
    let bytes = s.as_bytes();
    for (i, &byte) in bytes.iter().enumerate() {
        if byte == b' ' {
            return &s[..i];
        }
    }
    s  // æ²¡æœ‰ç©ºæ ¼ï¼Œè¿”å›æ•´ä¸ªå­—ç¬¦ä¸²
}

// ----------------------------------------------------------
// å®é™…åº”ç”¨å‡½æ•°
// ----------------------------------------------------------
fn sum_vec(v: &Vec<i32>) -> i32 {
    v.iter().sum()
}

fn max_vec(v: &Vec<i32>) -> i32 {
    *v.iter().max().unwrap()
}

fn add_bonus(scores: &mut Vec<i32>, bonus: i32) {
    for score in scores.iter_mut() {
        *score += bonus;
    }
}

// ----------------------------------------------------------
// ç»“æ„ä½“ä¸­çš„å€Ÿç”¨æ¨¡å¼
// ----------------------------------------------------------
struct TextStats {
    chars: usize,
    words: usize,
    lines: usize,
}

impl TextStats {
    fn new(text: &str) -> TextStats {
        TextStats {
            chars: text.chars().count(),
            words: text.split_whitespace().count(),
            lines: text.lines().count(),
        }
    }
}
```
