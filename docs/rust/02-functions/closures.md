# closures.rs

::: info æ–‡ä»¶ä¿¡æ¯
- ğŸ“„ åŸæ–‡ä»¶ï¼š`02_closures.rs`
- ğŸ”¤ è¯­è¨€ï¼šrust
:::

## å®Œæ•´ä»£ç 

```rust
// ============================================================
//                      é—­åŒ…ï¼ˆClosuresï¼‰
// ============================================================
// é—­åŒ…æ˜¯å¯ä»¥æ•è·æ‰€åœ¨ç¯å¢ƒå˜é‡çš„åŒ¿åå‡½æ•°
// è¯­æ³•: |å‚æ•°| è¡¨è¾¾å¼  æˆ–  |å‚æ•°| { ä»£ç å— }
// ã€ä¸å‡½æ•°çš„åŒºåˆ«ã€‘
//   1. é—­åŒ…å¯ä»¥æ•è·å¤–éƒ¨å˜é‡
//   2. é—­åŒ…å‚æ•°å’Œè¿”å›å€¼ç±»å‹å¯ä»¥æ¨æ–­ï¼ˆå‡½æ•°ä¸è¡Œï¼‰
//   3. é—­åŒ…æœ‰ä¸‰ç§ traitï¼šFnã€FnMutã€FnOnce

fn main() {
    println!("=== é—­åŒ… ===");

    // ----------------------------------------------------------
    // 1. é—­åŒ…åŸºæœ¬è¯­æ³•
    // ----------------------------------------------------------
    // æœ€ç®€è¯­æ³•ï¼ˆå•è¡¨è¾¾å¼ï¼Œè‡ªåŠ¨æ¨æ–­ç±»å‹ï¼‰
    let add_one = |x| x + 1;
    println!("add_one(5) = {}", add_one(5));

    // å¸¦ç±»å‹æ ‡æ³¨
    let add = |a: i32, b: i32| -> i32 { a + b };
    println!("add(3, 4) = {}", add(3, 4));

    // å¤šè¡Œé—­åŒ…
    let calculate = |x: i32, y: i32| {
        let sum = x + y;
        let product = x * y;
        (sum, product)  // è¿”å›å…ƒç»„
    };
    let (sum, product) = calculate(3, 4);
    println!("sum={}, product={}", sum, product);

    // æ— å‚æ•°é—­åŒ…
    let say_hi = || println!("å—¨ï¼");
    say_hi();

    // ----------------------------------------------------------
    // 2. æ•è·ç¯å¢ƒå˜é‡
    // ----------------------------------------------------------
    // é—­åŒ…ä¼šè‡ªåŠ¨æ•è·å¤–éƒ¨å˜é‡ï¼Œæœ‰ä¸‰ç§æ•è·æ–¹å¼ï¼š
    // 1. ä¸å¯å˜å€Ÿç”¨ï¼ˆ&Tï¼‰  â†’ å®ç° Fn
    // 2. å¯å˜å€Ÿç”¨ï¼ˆ&mut Tï¼‰â†’ å®ç° FnMut
    // 3. è·å–æ‰€æœ‰æƒï¼ˆTï¼‰   â†’ å®ç° FnOnce

    // ä¸å¯å˜å€Ÿç”¨ï¼ˆé»˜è®¤ä¼˜å…ˆé€‰æ‹©ï¼‰
    let name = String::from("Rust");
    let greet = || println!("ä½ å¥½, {}!", name);  // å€Ÿç”¨ name
    greet();
    println!("name ä»ç„¶å¯ç”¨: {}", name);  // name è¿˜åœ¨

    // å¯å˜å€Ÿç”¨
    let mut count = 0;
    let mut increment = || {
        count += 1;  // å¯å˜å€Ÿç”¨ count
        println!("è®¡æ•°: {}", count);
    };
    increment();
    increment();
    increment();
    // ã€æ³¨æ„ã€‘increment æŒæœ‰ count çš„å¯å˜å€Ÿç”¨ï¼Œ
    //        åœ¨ increment ä¸å†ä½¿ç”¨åæ‰èƒ½å†è®¿é—® count
    println!("æœ€ç»ˆè®¡æ•°: {}", count);

    // è·å–æ‰€æœ‰æƒï¼ˆä½¿ç”¨ move å…³é”®å­—ï¼‰
    let data = vec![1, 2, 3];
    let print_data = move || {
        println!("data: {:?}", data);  // data çš„æ‰€æœ‰æƒè¢«ç§»å…¥é—­åŒ…
    };
    print_data();
    // println!("{:?}", data);  // é”™è¯¯ï¼data å·²è¢«ç§»å…¥é—­åŒ…

    // ã€é€‚ç”¨åœºæ™¯ã€‘move åœ¨å¤šçº¿ç¨‹ä¸­éå¸¸å¸¸ç”¨
    // å› ä¸ºé—­åŒ…éœ€è¦åœ¨å¦ä¸€ä¸ªçº¿ç¨‹ä¸­æ‰§è¡Œï¼Œå¿…é¡»æ‹¥æœ‰æ•°æ®

    // ----------------------------------------------------------
    // 3. é—­åŒ…ä½œä¸ºå‡½æ•°å‚æ•°
    // ----------------------------------------------------------
    // ä½¿ç”¨æ³›å‹ + trait bound æˆ– impl trait

    // æ–¹å¼1: æ³›å‹ï¼ˆæ¨èï¼Œå¯ä»¥å†…è”ä¼˜åŒ–ï¼‰
    let result = apply_to_5(|x| x * 3);
    println!("apply_to_5(|x| x * 3) = {}", result);

    // æ–¹å¼2: ä½œä¸º trait å¯¹è±¡ï¼ˆè¿è¡Œæ—¶å¤šæ€ï¼Œæœ‰é¢å¤–å¼€é”€ï¼‰
    let ops: Vec<Box<dyn Fn(i32) -> i32>> = vec![
        Box::new(|x| x + 1),
        Box::new(|x| x * 2),
        Box::new(|x| x * x),
    ];
    for (i, op) in ops.iter().enumerate() {
        println!("ops[{}](5) = {}", i, op(5));
    }

    // ----------------------------------------------------------
    // 4. é—­åŒ…ä½œä¸ºè¿”å›å€¼
    // ----------------------------------------------------------
    let adder = make_adder(10);
    println!("make_adder(10)(5) = {}", adder(5));

    let multiplier = make_multiplier(3);
    println!("make_multiplier(3)(7) = {}", multiplier(7));

    // ----------------------------------------------------------
    // 5. Fn, FnMut, FnOnce çš„åŒºåˆ«
    // ----------------------------------------------------------
    // Fn:     å¯ä»¥å¤šæ¬¡è°ƒç”¨ï¼Œä¸ä¿®æ”¹æ•è·çš„å˜é‡ï¼ˆ&selfï¼‰
    // FnMut:  å¯ä»¥å¤šæ¬¡è°ƒç”¨ï¼Œå¯ä»¥ä¿®æ”¹æ•è·çš„å˜é‡ï¼ˆ&mut selfï¼‰
    // FnOnce: åªèƒ½è°ƒç”¨ä¸€æ¬¡ï¼Œå¯ä»¥æ¶ˆè€—æ•è·çš„å˜é‡ï¼ˆselfï¼‰
    //
    // ç»§æ‰¿å…³ç³»: Fn : FnMut : FnOnce
    // æ‰€æœ‰ Fn éƒ½æ˜¯ FnMutï¼Œæ‰€æœ‰ FnMut éƒ½æ˜¯ FnOnce

    // Fn ç¤ºä¾‹ï¼šä¸ä¿®æ”¹æ•è·çš„å˜é‡
    let x = 10;
    let fn_closure = || println!("Fn: x = {}", x);
    call_fn(&fn_closure);
    call_fn(&fn_closure);  // å¯ä»¥å¤šæ¬¡è°ƒç”¨

    // FnMut ç¤ºä¾‹ï¼šä¿®æ”¹æ•è·çš„å˜é‡
    let mut total = 0;
    let mut fn_mut_closure = || {
        total += 1;
        println!("FnMut: total = {}", total);
    };
    call_fn_mut(&mut fn_mut_closure);
    call_fn_mut(&mut fn_mut_closure);

    // FnOnce ç¤ºä¾‹ï¼šæ¶ˆè€—æ•è·çš„å˜é‡
    let data = String::from("ä¸€æ¬¡æ€§æ•°æ®");
    let fn_once_closure = || {
        let _moved = data;  // è·å–æ‰€æœ‰æƒ
        println!("FnOnce: æ•°æ®å·²æ¶ˆè€—");
    };
    call_fn_once(fn_once_closure);
    // call_fn_once(fn_once_closure);  // é”™è¯¯ï¼åªèƒ½è°ƒç”¨ä¸€æ¬¡

    // ----------------------------------------------------------
    // 6. å®ç”¨ç¤ºä¾‹
    // ----------------------------------------------------------
    println!("\n=== å®ç”¨ç¤ºä¾‹ ===");

    // è¿‡æ»¤
    let numbers = vec![1, 2, 3, 4, 5, 6, 7, 8, 9, 10];
    let evens: Vec<&i32> = numbers.iter().filter(|&&x| x % 2 == 0).collect();
    println!("å¶æ•°: {:?}", evens);

    // æ˜ å°„
    let doubled: Vec<i32> = numbers.iter().map(|&x| x * 2).collect();
    println!("ç¿»å€: {:?}", doubled);

    // æŠ˜å ï¼ˆç±»ä¼¼ reduceï¼‰
    let sum: i32 = numbers.iter().fold(0, |acc, &x| acc + x);
    println!("æ€»å’Œ: {}", sum);

    // æ’åºï¼ˆè‡ªå®šä¹‰æ¯”è¾ƒï¼‰
    let mut words = vec!["banana", "apple", "cherry", "date"];
    words.sort_by(|a, b| a.len().cmp(&b.len()));  // æŒ‰é•¿åº¦æ’åº
    println!("æŒ‰é•¿åº¦æ’åº: {:?}", words);

    // ç»„åˆè¿­ä»£å™¨æ“ä½œï¼ˆé“¾å¼è°ƒç”¨ï¼‰
    let result: Vec<String> = (1..=5)
        .map(|x| x * x)
        .filter(|&x| x > 5)
        .map(|x| format!("{}Â²", (x as f64).sqrt() as i32))
        .collect();
    println!("é“¾å¼æ“ä½œ: {:?}", result);

    println!("\n=== é—­åŒ…ç»“æŸ ===");
}

// ----------------------------------------------------------
// æ¥å— Fn é—­åŒ…ä½œä¸ºå‚æ•°
// ----------------------------------------------------------
fn apply_to_5<F: Fn(i32) -> i32>(f: F) -> i32 {
    f(5)
}

// ----------------------------------------------------------
// è¿”å›é—­åŒ…ï¼ˆå¿…é¡»ä½¿ç”¨ impl Fn æˆ– Box<dyn Fn>ï¼‰
// ----------------------------------------------------------
fn make_adder(x: i32) -> impl Fn(i32) -> i32 {
    move |y| x + y  // move è·å– x çš„æ‰€æœ‰æƒ
}

fn make_multiplier(factor: i32) -> Box<dyn Fn(i32) -> i32> {
    Box::new(move |x| x * factor)
}

// ----------------------------------------------------------
// Fn / FnMut / FnOnce å‚æ•°ç¤ºä¾‹
// ----------------------------------------------------------
fn call_fn(f: &dyn Fn()) {
    f();
}

fn call_fn_mut(f: &mut dyn FnMut()) {
    f();
}

fn call_fn_once<F: FnOnce()>(f: F) {
    f();
}
```
