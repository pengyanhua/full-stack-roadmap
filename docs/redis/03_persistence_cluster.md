# persistence cluster

::: info æ–‡ä»¶ä¿¡æ¯
- ğŸ“„ åŸæ–‡ä»¶ï¼š`03_persistence_cluster.redis`
- ğŸ”¤ ç±»å‹ï¼šRedis Commands
:::

## Redis å‘½ä»¤

```redis
-- ============================================================
--                    Redis æŒä¹…åŒ–ä¸é›†ç¾¤
-- ============================================================
-- åŒ…å«ï¼šRDBã€AOFã€ä¸»ä»å¤åˆ¶ã€å“¨å…µã€é›†ç¾¤
-- ============================================================

-- ============================================================
--                    ä¸€ã€RDB æŒä¹…åŒ–
-- ============================================================

-- RDBï¼ˆRedis Databaseï¼‰ï¼šå°†å†…å­˜æ•°æ®å¿«ç…§ä¿å­˜åˆ°ç£ç›˜

-- æ‰‹åŠ¨è§¦å‘ RDB
SAVE                            -- åŒæ­¥ä¿å­˜ï¼ˆé˜»å¡ï¼‰
BGSAVE                          -- åå°ä¿å­˜ï¼ˆfork å­è¿›ç¨‹ï¼‰

-- æŸ¥çœ‹æœ€åä¸€æ¬¡ä¿å­˜æ—¶é—´
LASTSAVE

-- RDB é…ç½®ï¼ˆredis.confï¼‰
/*
# ä¿å­˜ç­–ç•¥ï¼š900 ç§’å†…æœ‰ 1 æ¬¡ä¿®æ”¹åˆ™ä¿å­˜
save 900 1
save 300 10
save 60 10000

# ç¦ç”¨ RDB
# save ""

# RDB æ–‡ä»¶å
dbfilename dump.rdb

# RDB æ–‡ä»¶è·¯å¾„
dir /var/lib/redis/

# RDB å‹ç¼©
rdbcompression yes

# RDB æ ¡éªŒ
rdbchecksum yes

# å­è¿›ç¨‹å†™å…¥å¤±è´¥æ—¶æ˜¯å¦åœæ­¢æ¥æ”¶å†™å…¥
stop-writes-on-bgsave-error yes
*/

-- RDB ä¼˜ç‚¹ï¼š
-- 1. ç´§å‡‘çš„äºŒè¿›åˆ¶æ–‡ä»¶ï¼Œé€‚åˆå¤‡ä»½
-- 2. æ¢å¤é€Ÿåº¦å¿«
-- 3. å¯¹æ€§èƒ½å½±å“å°ï¼ˆfork å­è¿›ç¨‹ï¼‰

-- RDB ç¼ºç‚¹ï¼š
-- 1. å¯èƒ½ä¸¢å¤±æœ€åä¸€æ¬¡å¿«ç…§åçš„æ•°æ®
-- 2. fork æ—¶å¯èƒ½é€ æˆçŸ­æš‚åœé¡¿ï¼ˆæ•°æ®é‡å¤§æ—¶ï¼‰

-- ============================================================
--                    äºŒã€AOF æŒä¹…åŒ–
-- ============================================================

-- AOFï¼ˆAppend Only Fileï¼‰ï¼šè®°å½•æ¯ä¸ªå†™æ“ä½œå‘½ä»¤

-- AOF é…ç½®ï¼ˆredis.confï¼‰
/*
# å¼€å¯ AOF
appendonly yes

# AOF æ–‡ä»¶å
appendfilename "appendonly.aof"

# åŒæ­¥ç­–ç•¥
# always: æ¯æ¬¡å†™å…¥éƒ½åŒæ­¥ï¼ˆæœ€å®‰å…¨ï¼Œæœ€æ…¢ï¼‰
# everysec: æ¯ç§’åŒæ­¥ä¸€æ¬¡ï¼ˆé»˜è®¤ï¼Œæ¨èï¼‰
# no: ç”±æ“ä½œç³»ç»Ÿå†³å®šï¼ˆæœ€å¿«ï¼Œå¯èƒ½ä¸¢å¤±æ•°æ®ï¼‰
appendfsync everysec

# é‡å†™æ—¶æ˜¯å¦åŒæ­¥
no-appendfsync-on-rewrite no

# è‡ªåŠ¨é‡å†™è§¦å‘æ¡ä»¶
auto-aof-rewrite-percentage 100    # æ¯”ä¸Šæ¬¡é‡å†™åå¤§ 100%
auto-aof-rewrite-min-size 64mb     # æœ€å° 64MB æ‰é‡å†™

# AOF åŠ è½½æ—¶æ˜¯å¦å¿½ç•¥é”™è¯¯
aof-load-truncated yes

# ä½¿ç”¨ RDB+AOF æ··åˆæŒä¹…åŒ–ï¼ˆRedis 4.0+ï¼‰
aof-use-rdb-preamble yes
*/

-- æ‰‹åŠ¨è§¦å‘ AOF é‡å†™
BGREWRITEAOF

-- AOF æ–‡ä»¶ä¿®å¤
-- redis-check-aof --fix appendonly.aof

-- AOF ä¼˜ç‚¹ï¼š
-- 1. æ•°æ®å®‰å…¨æ€§é«˜ï¼ˆæœ€å¤šä¸¢å¤± 1 ç§’æ•°æ®ï¼‰
-- 2. æ–‡ä»¶å¯è¯»ï¼Œä¾¿äºç†è§£å’Œæ¢å¤
-- 3. è‡ªåŠ¨é‡å†™å‹ç¼©

-- AOF ç¼ºç‚¹ï¼š
-- 1. æ–‡ä»¶ä½“ç§¯æ¯” RDB å¤§
-- 2. æ¢å¤é€Ÿåº¦æ¯” RDB æ…¢
-- 3. å†™å…¥æ€§èƒ½ç•¥ä½äº RDB

-- ============================================================
--                    ä¸‰ã€æ··åˆæŒä¹…åŒ–ï¼ˆRedis 4.0+ï¼‰
-- ============================================================

-- æ··åˆæŒä¹…åŒ–ç»“åˆ RDB å’Œ AOF çš„ä¼˜ç‚¹
-- AOF é‡å†™æ—¶ï¼Œå…ˆå†™å…¥ RDB æ ¼å¼çš„æ•°æ®ï¼Œå†è¿½åŠ é‡å†™æœŸé—´çš„å¢é‡ AOF

/*
é…ç½®ï¼š
aof-use-rdb-preamble yes
*/

-- æ–‡ä»¶ç»“æ„ï¼š
-- [RDB æ ¼å¼çš„å…¨é‡æ•°æ®][AOF æ ¼å¼çš„å¢é‡æ•°æ®]

-- ä¼˜ç‚¹ï¼š
-- 1. æ¢å¤é€Ÿåº¦å¿«ï¼ˆå¤§éƒ¨åˆ†æ˜¯ RDBï¼‰
-- 2. æ•°æ®å®‰å…¨ï¼ˆAOF è®°å½•å¢é‡ï¼‰

-- ============================================================
--                    å››ã€ä¸»ä»å¤åˆ¶
-- ============================================================

-- è®¾ç½®ä¸»ä»å…³ç³»ï¼ˆåœ¨ä»èŠ‚ç‚¹æ‰§è¡Œï¼‰
REPLICAOF 192.168.1.100 6379    -- Redis 5.0+ æ–°å‘½ä»¤
-- æˆ–
SLAVEOF 192.168.1.100 6379      -- æ—§å‘½ä»¤ï¼ˆä»å¯ç”¨ï¼‰

-- å–æ¶ˆä¸»ä»å…³ç³»
REPLICAOF NO ONE

-- æŸ¥çœ‹å¤åˆ¶çŠ¶æ€
INFO replication

-- ä»èŠ‚ç‚¹é…ç½®ï¼ˆredis.confï¼‰
/*
# ä¸»èŠ‚ç‚¹åœ°å€
replicaof 192.168.1.100 6379

# ä¸»èŠ‚ç‚¹å¯†ç 
masterauth your_password

# ä»èŠ‚ç‚¹åªè¯»
replica-read-only yes

# ä»èŠ‚ç‚¹æ˜¯å¦å“åº”è¿‡æœŸæ•°æ®ï¼ˆç­‰å¾…ä¸»èŠ‚ç‚¹åˆ é™¤å‘½ä»¤ï¼‰
replica-serve-stale-data yes

# å¤åˆ¶ç§¯å‹ç¼“å†²åŒºå¤§å°
repl-backlog-size 1mb

# æ— ç›˜å¤åˆ¶ï¼ˆç›´æ¥é€šè¿‡ç½‘ç»œä¼ è¾“ RDBï¼‰
repl-diskless-sync no
repl-diskless-sync-delay 5
*/

-- ä¸»ä»å¤åˆ¶åŸç†ï¼š
-- 1. å…¨é‡å¤åˆ¶ï¼ˆåˆæ¬¡è¿æ¥æˆ–ç§¯å‹ç¼“å†²åŒºä¸è¶³ï¼‰
--    - ä¸»èŠ‚ç‚¹ BGSAVE ç”Ÿæˆ RDB
--    - å‘é€ RDB åˆ°ä»èŠ‚ç‚¹
--    - ä»èŠ‚ç‚¹åŠ è½½ RDB
--    - ä¸»èŠ‚ç‚¹å‘é€ç§¯å‹ç¼“å†²åŒºçš„å‘½ä»¤
--
-- 2. å¢é‡å¤åˆ¶ï¼ˆæ­£å¸¸è¿è¡Œæ—¶ï¼‰
--    - ä¸»èŠ‚ç‚¹å°†å†™å‘½ä»¤å‘é€åˆ°ä»èŠ‚ç‚¹
--    - ä»èŠ‚ç‚¹æ‰§è¡Œå‘½ä»¤

-- å¤åˆ¶åç§»é‡
-- ä¸»ä»èŠ‚ç‚¹å„è‡ªç»´æŠ¤åç§»é‡ï¼ˆoffsetï¼‰
-- ç”¨äºæ–­çº¿é‡è¿æ—¶çš„å¢é‡åŒæ­¥

-- ============================================================
--                    äº”ã€å“¨å…µï¼ˆSentinelï¼‰
-- ============================================================

-- å“¨å…µç”¨äºç›‘æ§ä¸»ä»é›†ç¾¤ï¼Œå®ç°è‡ªåŠ¨æ•…éšœè½¬ç§»

-- å“¨å…µé…ç½®ï¼ˆsentinel.confï¼‰
/*
# ç›‘æ§çš„ä¸»èŠ‚ç‚¹
sentinel monitor mymaster 192.168.1.100 6379 2

# ä¸»èŠ‚ç‚¹å¯†ç 
sentinel auth-pass mymaster your_password

# ä¸»èŠ‚ç‚¹å¤šä¹…æ— å“åº”åˆ¤å®šä¸ºä¸»è§‚ä¸‹çº¿
sentinel down-after-milliseconds mymaster 30000

# æ•…éšœè½¬ç§»è¶…æ—¶æ—¶é—´
sentinel failover-timeout mymaster 180000

# åŒæ—¶åŒæ­¥çš„ä»èŠ‚ç‚¹æ•°é‡
sentinel parallel-syncs mymaster 1
*/

-- å¯åŠ¨å“¨å…µ
-- redis-sentinel /path/to/sentinel.conf
-- æˆ–
-- redis-server /path/to/sentinel.conf --sentinel

-- å“¨å…µå‘½ä»¤
SENTINEL MASTER mymaster        -- ä¸»èŠ‚ç‚¹ä¿¡æ¯
SENTINEL SLAVES mymaster        -- ä»èŠ‚ç‚¹ä¿¡æ¯
SENTINEL SENTINELS mymaster     -- å…¶ä»–å“¨å…µä¿¡æ¯
SENTINEL GET-MASTER-ADDR-BY-NAME mymaster  -- è·å–ä¸»èŠ‚ç‚¹åœ°å€
SENTINEL FAILOVER mymaster      -- æ‰‹åŠ¨æ•…éšœè½¬ç§»

-- å“¨å…µå·¥ä½œåŸç†ï¼š
-- 1. ç›‘æ§ï¼šå®šæœŸ PING ä¸»ä»èŠ‚ç‚¹
-- 2. é€šçŸ¥ï¼šå‘ç°æ•…éšœæ—¶é€šçŸ¥ç®¡ç†å‘˜
-- 3. è‡ªåŠ¨æ•…éšœè½¬ç§»ï¼š
--    - ä¸»è§‚ä¸‹çº¿ï¼šå•ä¸ªå“¨å…µè®¤ä¸ºèŠ‚ç‚¹ä¸‹çº¿
--    - å®¢è§‚ä¸‹çº¿ï¼šå¤šæ•°å“¨å…µï¼ˆquorumï¼‰åŒæ„
--    - é€‰ä¸¾é¢†å¯¼è€…å“¨å…µæ‰§è¡Œæ•…éšœè½¬ç§»
--    - é€‰æ‹©æ–°ä¸»èŠ‚ç‚¹ï¼ˆä¼˜å…ˆçº§ã€åç§»é‡ã€runidï¼‰
--    - é€šçŸ¥ä»èŠ‚ç‚¹å¤åˆ¶æ–°ä¸»èŠ‚ç‚¹
--    - æ›´æ–°é…ç½®

-- ============================================================
--                    å…­ã€Redis Cluster
-- ============================================================

-- Redis Cluster æ˜¯å®˜æ–¹çš„åˆ†å¸ƒå¼è§£å†³æ–¹æ¡ˆ
-- ç‰¹ç‚¹ï¼šæ•°æ®åˆ†ç‰‡ã€å»ä¸­å¿ƒåŒ–ã€è‡ªåŠ¨æ•…éšœè½¬ç§»

-- é›†ç¾¤é…ç½®ï¼ˆredis.confï¼‰
/*
# å¼€å¯é›†ç¾¤æ¨¡å¼
cluster-enabled yes

# é›†ç¾¤é…ç½®æ–‡ä»¶
cluster-config-file nodes.conf

# èŠ‚ç‚¹è¶…æ—¶æ—¶é—´
cluster-node-timeout 15000

# ä»èŠ‚ç‚¹æœ‰æ•ˆå› å­
cluster-replica-validity-factor 10

# æ˜¯å¦è¦æ±‚æ‰€æœ‰æ§½éƒ½æœ‰èŠ‚ç‚¹æ‰èƒ½æœåŠ¡
cluster-require-full-coverage yes
*/

-- åˆ›å»ºé›†ç¾¤ï¼ˆRedis 5.0+ ä½¿ç”¨ redis-cliï¼‰
-- redis-cli --cluster create 192.168.1.1:6379 192.168.1.2:6379 192.168.1.3:6379 192.168.1.4:6379 192.168.1.5:6379 192.168.1.6:6379 --cluster-replicas 1

-- é›†ç¾¤å‘½ä»¤
CLUSTER INFO                    -- é›†ç¾¤çŠ¶æ€
CLUSTER NODES                   -- èŠ‚ç‚¹åˆ—è¡¨
CLUSTER SLOTS                   -- æ§½åˆ†é…æƒ…å†µ
CLUSTER KEYSLOT mykey           -- è®¡ç®—é”®çš„æ§½ä½

-- æ§½ä½ç®¡ç†
CLUSTER ADDSLOTS 0 1 2 3        -- åˆ†é…æ§½ä½
CLUSTER DELSLOTS 0 1 2 3        -- åˆ é™¤æ§½ä½
CLUSTER SETSLOT 100 NODE nodeid -- å°†æ§½åˆ†é…ç»™æŒ‡å®šèŠ‚ç‚¹
CLUSTER SETSLOT 100 MIGRATING nodeid  -- è¿ç§»ä¸­
CLUSTER SETSLOT 100 IMPORTING nodeid  -- å¯¼å…¥ä¸­
CLUSTER SETSLOT 100 STABLE      -- ç»“æŸè¿ç§»

-- èŠ‚ç‚¹ç®¡ç†
CLUSTER MEET 192.168.1.7 6379   -- æ·»åŠ èŠ‚ç‚¹
CLUSTER FORGET nodeid           -- ç§»é™¤èŠ‚ç‚¹
CLUSTER REPLICATE nodeid        -- è®¾ä¸ºä»èŠ‚ç‚¹
CLUSTER FAILOVER                -- æ‰‹åŠ¨æ•…éšœè½¬ç§»

-- æ·»åŠ æ–°èŠ‚ç‚¹
-- redis-cli --cluster add-node 192.168.1.7:6379 192.168.1.1:6379
-- æ·»åŠ ä¸ºä»èŠ‚ç‚¹
-- redis-cli --cluster add-node 192.168.1.8:6379 192.168.1.1:6379 --cluster-slave --cluster-master-id nodeid

-- é‡æ–°åˆ†ç‰‡
-- redis-cli --cluster reshard 192.168.1.1:6379

-- æ£€æŸ¥é›†ç¾¤
-- redis-cli --cluster check 192.168.1.1:6379

-- ä¿®å¤é›†ç¾¤
-- redis-cli --cluster fix 192.168.1.1:6379

-- ============================================================
--                    ä¸ƒã€Cluster æ•°æ®åˆ†ç‰‡
-- ============================================================

-- Redis Cluster ä½¿ç”¨å“ˆå¸Œæ§½ï¼ˆHash Slotï¼‰åˆ†ç‰‡
-- å…± 16384 ä¸ªæ§½ï¼ˆ0-16383ï¼‰
-- æ¯ä¸ªé”®é€šè¿‡ CRC16(key) % 16384 è®¡ç®—æ§½ä½

-- æ§½ä½è®¡ç®—
CLUSTER KEYSLOT user:1001       -- è¿”å›æ§½ä½å·

-- å“ˆå¸Œæ ‡ç­¾ï¼ˆHash Tagï¼‰
-- ä½¿ç”¨ {} æŒ‡å®šç”¨äºè®¡ç®—æ§½ä½çš„éƒ¨åˆ†
-- ç¡®ä¿ç›¸å…³çš„é”®åœ¨åŒä¸€ä¸ªæ§½
SET user:{1001}:name "Alice"
SET user:{1001}:age "25"
-- ä¸¤ä¸ªé”®éƒ½æ ¹æ® "1001" è®¡ç®—æ§½ä½ï¼Œä¼šåœ¨åŒä¸€ä¸ªèŠ‚ç‚¹

-- è·¨æ§½æ“ä½œé™åˆ¶
-- å¤šé”®æ“ä½œåªèƒ½åœ¨åŒä¸€ä¸ªæ§½å†…æ‰§è¡Œ
MGET key1 key2 key3             -- å¦‚æœä¸åœ¨åŒä¸€ä¸ªæ§½ä¼šæŠ¥é”™

-- ä½¿ç”¨å“ˆå¸Œæ ‡ç­¾è§£å†³
MGET {user}:key1 {user}:key2 {user}:key3  -- åŒä¸€ä¸ªæ§½

-- ============================================================
--                    å…«ã€Cluster æ•…éšœè½¬ç§»
-- ============================================================

-- è‡ªåŠ¨æ•…éšœè½¬ç§»æµç¨‹ï¼š
-- 1. èŠ‚ç‚¹ A æ— æ³•è”ç³»ä¸»èŠ‚ç‚¹ B
-- 2. A æ ‡è®° B ä¸º PFAILï¼ˆå¯èƒ½å¤±è´¥ï¼‰
-- 3. A å‘å…¶ä»–èŠ‚ç‚¹å¹¿æ’­ PFAIL
-- 4. å½“å¤šæ•°ä¸»èŠ‚ç‚¹éƒ½æ ‡è®° B ä¸º PFAIL æ—¶ï¼Œæ ‡è®°ä¸º FAIL
-- 5. B çš„ä»èŠ‚ç‚¹å¼€å§‹æ•…éšœè½¬ç§»
-- 6. ä»èŠ‚ç‚¹é€šè¿‡ Raft é€‰ä¸¾æˆä¸ºæ–°ä¸»èŠ‚ç‚¹
-- 7. æ–°ä¸»èŠ‚ç‚¹å¹¿æ’­ PONGï¼Œå®£å¸ƒæ¥ç®¡

-- æ‰‹åŠ¨æ•…éšœè½¬ç§»ï¼ˆåœ¨ä»èŠ‚ç‚¹æ‰§è¡Œï¼‰
CLUSTER FAILOVER                -- ä¼˜é›…åˆ‡æ¢
CLUSTER FAILOVER FORCE          -- å¼ºåˆ¶åˆ‡æ¢ï¼ˆä¸ç­‰å¾…ä¸»èŠ‚ç‚¹ï¼‰
CLUSTER FAILOVER TAKEOVER       -- å¼ºåˆ¶æ¥ç®¡ï¼ˆä¸éœ€è¦é€‰ä¸¾ï¼‰

-- ============================================================
--                    ä¹ã€ç”Ÿäº§ç¯å¢ƒå»ºè®®
-- ============================================================

/*
1. æŒä¹…åŒ–ç­–ç•¥
   - ç”Ÿäº§ç¯å¢ƒåŒæ—¶å¼€å¯ RDB å’Œ AOF
   - ä½¿ç”¨æ··åˆæŒä¹…åŒ–ï¼ˆRedis 4.0+ï¼‰
   - AOF ä½¿ç”¨ everysec åŒæ­¥ç­–ç•¥

2. å†…å­˜ç®¡ç†
   - è®¾ç½® maxmemory é™åˆ¶
   - é€‰æ‹©åˆé€‚çš„æ·˜æ±°ç­–ç•¥
   - ç›‘æ§å†…å­˜ä½¿ç”¨

3. é«˜å¯ç”¨æ¶æ„
   - å•æœºï¼šä¸»ä» + å“¨å…µï¼ˆè‡³å°‘ 3 ä¸ªå“¨å…µï¼‰
   - é›†ç¾¤ï¼šè‡³å°‘ 3 ä¸» 3 ä»

4. å®‰å…¨é…ç½®
   - è®¾ç½®å¯†ç ï¼ˆrequirepassï¼‰
   - ç»‘å®šå†…ç½‘ IPï¼ˆbindï¼‰
   - ç¦ç”¨å±é™©å‘½ä»¤ï¼ˆrename-commandï¼‰
   - å¯ç”¨ TLS/SSL

5. ç›‘æ§å‘Šè­¦
   - ç›‘æ§å†…å­˜ä½¿ç”¨
   - ç›‘æ§è¿æ¥æ•°
   - ç›‘æ§æ…¢æŸ¥è¯¢
   - ç›‘æ§å¤åˆ¶å»¶è¿Ÿ

6. å¤‡ä»½ç­–ç•¥
   - å®šæœŸå¤‡ä»½ RDB æ–‡ä»¶
   - å¼‚åœ°å¤‡ä»½
   - å®šæœŸæ¢å¤æµ‹è¯•
*/

-- ============================================================
--                    åã€é…ç½®å‚æ•°é€ŸæŸ¥
-- ============================================================

/*
# ç½‘ç»œ
bind 127.0.0.1
port 6379
timeout 0
tcp-keepalive 300
protected-mode yes

# é€šç”¨
daemonize yes
pidfile /var/run/redis_6379.pid
loglevel notice
logfile /var/log/redis/redis.log
databases 16

# å®‰å…¨
requirepass your_password
rename-command FLUSHALL ""
rename-command CONFIG ""

# å†…å­˜
maxmemory 4gb
maxmemory-policy allkeys-lru
maxmemory-samples 5

# RDB
save 900 1
save 300 10
save 60 10000
stop-writes-on-bgsave-error yes
rdbcompression yes
rdbchecksum yes
dbfilename dump.rdb
dir /var/lib/redis/

# AOF
appendonly yes
appendfilename "appendonly.aof"
appendfsync everysec
no-appendfsync-on-rewrite no
auto-aof-rewrite-percentage 100
auto-aof-rewrite-min-size 64mb
aof-use-rdb-preamble yes

# å¤åˆ¶
replicaof <masterip> <masterport>
masterauth <master-password>
replica-read-only yes
repl-backlog-size 1mb
repl-backlog-ttl 3600

# é›†ç¾¤
cluster-enabled yes
cluster-config-file nodes.conf
cluster-node-timeout 15000
cluster-require-full-coverage yes

# æ…¢æŸ¥è¯¢
slowlog-log-slower-than 10000
slowlog-max-len 128

# å®¢æˆ·ç«¯
maxclients 10000
client-output-buffer-limit normal 0 0 0
client-output-buffer-limit replica 256mb 64mb 60
client-output-buffer-limit pubsub 32mb 8mb 60

# Lua
lua-time-limit 5000
*/

```
