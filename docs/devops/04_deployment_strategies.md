# éƒ¨ç½²ç­–ç•¥

## ç›®å½•
- [éƒ¨ç½²ç­–ç•¥æ¦‚è§ˆ](#éƒ¨ç½²ç­–ç•¥æ¦‚è§ˆ)
- [è“ç»¿éƒ¨ç½²](#è“ç»¿éƒ¨ç½²)
- [é‡‘ä¸é›€å‘å¸ƒ](#é‡‘ä¸é›€å‘å¸ƒ)
- [æ»šåŠ¨æ›´æ–°](#æ»šåŠ¨æ›´æ–°)

---

## éƒ¨ç½²ç­–ç•¥æ¦‚è§ˆ

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚          éƒ¨ç½²ç­–ç•¥å¯¹æ¯”                                â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚  ç­–ç•¥        â”‚  é£é™©  â”‚  é€Ÿåº¦   â”‚  æˆæœ¬              â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ é‡å»º(Recreate)â”‚  é«˜    â”‚  å¿«     â”‚  ä½               â”‚
â”‚ æ»šåŠ¨(Rolling) â”‚  ä¸­    â”‚  ä¸­     â”‚  ä½               â”‚
â”‚ è“ç»¿(Blue/Green)â”‚ ä½   â”‚  å¿«     â”‚  é«˜(åŒå€èµ„æº)     â”‚
â”‚ é‡‘ä¸é›€(Canary)â”‚  ä½    â”‚  æ…¢     â”‚  ä¸­               â”‚
â”‚ A/Bæµ‹è¯•      â”‚  ä½    â”‚  æ…¢     â”‚  ä¸­               â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

## è“ç»¿éƒ¨ç½²

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚              è“ç»¿éƒ¨ç½²æµç¨‹                          â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                    â”‚
â”‚  æ­¥éª¤1: åˆå§‹çŠ¶æ€                                   â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                                     â”‚
â”‚  â”‚ è´Ÿè½½å‡è¡¡ â”‚ â”€â”€100%â”€â”€â–¶ è“ç¯å¢ƒ (v1.0)            â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                                     â”‚
â”‚                                                    â”‚
â”‚  æ­¥éª¤2: éƒ¨ç½²æ–°ç‰ˆæœ¬                                 â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                                     â”‚
â”‚  â”‚ è´Ÿè½½å‡è¡¡ â”‚ â”€â”€100%â”€â”€â–¶ è“ç¯å¢ƒ (v1.0)            â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                                     â”‚
â”‚                        ç»¿ç¯å¢ƒ (v2.0) éƒ¨ç½²ä¸­...     â”‚
â”‚                                                    â”‚
â”‚  æ­¥éª¤3: åˆ‡æ¢æµé‡                                   â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                                     â”‚
â”‚  â”‚ è´Ÿè½½å‡è¡¡ â”‚ â”€â”€â”€0%â”€â”€â”€â–¶ è“ç¯å¢ƒ (v1.0)            â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                                     â”‚
â”‚              â””â”€100%â”€â”€â–¶ ç»¿ç¯å¢ƒ (v2.0) âœ…           â”‚
â”‚                                                    â”‚
â”‚  æ­¥éª¤4: å›æ»š (å¦‚æœéœ€è¦)                            â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                                     â”‚
â”‚  â”‚ è´Ÿè½½å‡è¡¡ â”‚ â”€â”€100%â”€â”€â–¶ è“ç¯å¢ƒ (v1.0) â—€å›æ»š      â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                                     â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### Kuberneteså®ç°

```yaml
# blue-deployment.yaml
apiVersion: apps/v1
kind: Deployment
metadata:
  name: myapp-blue
  labels:
    app: myapp
    version: blue
spec:
  replicas: 3
  selector:
    matchLabels:
      app: myapp
      version: blue
  template:
    metadata:
      labels:
        app: myapp
        version: blue
    spec:
      containers:
      - name: app
        image: myapp:1.0
        ports:
        - containerPort: 8080

---
# green-deployment.yaml
apiVersion: apps/v1
kind: Deployment
metadata:
  name: myapp-green
  labels:
    app: myapp
    version: green
spec:
  replicas: 3
  selector:
    matchLabels:
      app: myapp
      version: green
  template:
    metadata:
      labels:
        app: myapp
        version: green
    spec:
      containers:
      - name: app
        image: myapp:2.0
        ports:
        - containerPort: 8080

---
# service.yaml - åˆ‡æ¢ç‰ˆæœ¬åªéœ€ä¿®æ”¹selector
apiVersion: v1
kind: Service
metadata:
  name: myapp
spec:
  selector:
    app: myapp
    version: green  # ä¿®æ”¹è¿™é‡Œå®ç°åˆ‡æ¢
  ports:
  - port: 80
    targetPort: 8080
```

### åˆ‡æ¢è„šæœ¬

```bash
#!/bin/bash
# blue-green-deploy.sh

# éƒ¨ç½²ç»¿ç¯å¢ƒ
kubectl apply -f green-deployment.yaml

# ç­‰å¾…ç»¿ç¯å¢ƒå°±ç»ª
kubectl rollout status deployment/myapp-green

# è¿è¡ŒçƒŸé›¾æµ‹è¯•
curl http://myapp-green-service/health

# åˆ‡æ¢æµé‡åˆ°ç»¿ç¯å¢ƒ
kubectl patch service myapp -p '{"spec":{"selector":{"version":"green"}}}'

echo "âœ… éƒ¨ç½²å®Œæˆï¼è“ç¯å¢ƒä¿ç•™10åˆ†é’Ÿä»¥å¤‡å›æ»š"

# 10åˆ†é’Ÿååˆ é™¤è“ç¯å¢ƒ
sleep 600
kubectl delete deployment myapp-blue
```

## é‡‘ä¸é›€å‘å¸ƒ

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚              é‡‘ä¸é›€å‘å¸ƒæµç¨‹                        â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                    â”‚
â”‚  é˜¶æ®µ1: 5% æµé‡                                    â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                                     â”‚
â”‚  â”‚ è´Ÿè½½å‡è¡¡ â”‚ â”€â”€ 95% â”€â”€â–¶ v1.0 (ç¨³å®šç‰ˆ)           â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                                     â”‚
â”‚              â””â”€  5% â”€â”€â–¶ v2.0 (é‡‘ä¸é›€) ğŸ¤          â”‚
â”‚                                                    â”‚
â”‚  é˜¶æ®µ2: è§‚å¯ŸæŒ‡æ ‡,é€æ­¥å¢åŠ                           â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                                     â”‚
â”‚  â”‚ è´Ÿè½½å‡è¡¡ â”‚ â”€â”€ 50% â”€â”€â–¶ v1.0                    â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                                     â”‚
â”‚              â””â”€ 50% â”€â”€â–¶ v2.0                      â”‚
â”‚                                                    â”‚
â”‚  é˜¶æ®µ3: å…¨é‡åˆ‡æ¢                                   â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                                     â”‚
â”‚  â”‚ è´Ÿè½½å‡è¡¡ â”‚ â”€â”€100% â”€â”€â–¶ v2.0 âœ…                 â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                                     â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### Istioå®ç°

```yaml
# virtualservice.yaml
apiVersion: networking.istio.io/v1beta1
kind: VirtualService
metadata:
  name: myapp
spec:
  hosts:
  - myapp
  http:
  - match:
    - headers:
        canary:
          exact: "true"
    route:
    - destination:
        host: myapp
        subset: v2
      weight: 100
  - route:
    - destination:
        host: myapp
        subset: v1
      weight: 95
    - destination:
        host: myapp
        subset: v2
      weight: 5  # é‡‘ä¸é›€æµé‡

---
# destinationrule.yaml
apiVersion: networking.istio.io/v1beta1
kind: DestinationRule
metadata:
  name: myapp
spec:
  host: myapp
  subsets:
  - name: v1
    labels:
      version: v1
  - name: v2
    labels:
      version: v2
```

### è‡ªåŠ¨åŒ–é‡‘ä¸é›€

```python
# canary_controller.py
import time
import requests
from kubernetes import client, config

class CanaryController:
    def __init__(self):
        config.load_kube_config()
        self.api = client.CustomObjectsApi()

    def promote_canary(self, stages=[5, 25, 50, 100]):
        """æ¸è¿›å¼é‡‘ä¸é›€å‘å¸ƒ"""

        for weight in stages:
            # æ›´æ–°æµé‡æƒé‡
            self.update_traffic_weight(weight)

            # è§‚å¯Ÿ10åˆ†é’Ÿ
            time.sleep(600)

            # æ£€æŸ¥æŒ‡æ ‡
            metrics = self.check_metrics()

            if not metrics['healthy']:
                print(f"âŒ æŒ‡æ ‡å¼‚å¸¸,å›æ»šåˆ°0%")
                self.update_traffic_weight(0)
                return False

            print(f"âœ… {weight}% æµé‡å¥åº·,ç»§ç»­æ¨è¿›")

        print("ğŸ‰ é‡‘ä¸é›€å‘å¸ƒå®Œæˆ!")
        return True

    def check_metrics(self):
        """æ£€æŸ¥å…³é”®æŒ‡æ ‡"""
        # é”™è¯¯ç‡
        error_rate = self.query_prometheus(
            'sum(rate(http_requests_total{status=~"5.."}[5m])) / sum(rate(http_requests_total[5m]))'
        )

        # å»¶è¿Ÿ
        p99_latency = self.query_prometheus(
            'histogram_quantile(0.99, rate(http_request_duration_seconds_bucket[5m]))'
        )

        return {
            'healthy': error_rate < 0.01 and p99_latency < 1.0
        }
```

## æ€»ç»“

é€‰æ‹©éƒ¨ç½²ç­–ç•¥è€ƒè™‘å› ç´ ï¼š
1. é£é™©å®¹å¿åº¦
2. èµ„æºæˆæœ¬
3. å›æ»šé€Ÿåº¦
4. ä¸šåŠ¡å½±å“

æ¨èï¼šç”Ÿäº§ç¯å¢ƒä½¿ç”¨è“ç»¿æˆ–é‡‘ä¸é›€
