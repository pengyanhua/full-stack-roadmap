# 数据链路层协议

## 一、以太网 (Ethernet)

### 以太网帧结构

```
以太网 II 帧格式 (最常用):

┌─────────────────────────────────────────────────────────────┐
│                      以太网帧                                │
├────────┬───────┬───────┬──────┬──────────────┬──────────────┤
│ 前导码 │ SFD   │目标MAC│源MAC │ 类型/长度    │   数据       │
│ (7B)   │ (1B)  │ (6B)  │ (6B) │   (2B)       │ (46-1500B)   │
├────────┴───────┴───────┴──────┴──────────────┴──────────────┤
│                           FCS (4B)                           │
└──────────────────────────────────────────────────────────────┘

字段详解:
┌──────────────┬────────┬────────────────────────────────┐
│    字段      │  大小  │            说明                │
├──────────────┼────────┼────────────────────────────────┤
│ 前导码       │ 7 字节 │ 10101010... 用于同步           │
│ (Preamble)   │        │                                │
├──────────────┼────────┼────────────────────────────────┤
│ SFD          │ 1 字节 │ 10101011 帧开始定界符          │
│(Start Frame) │        │                                │
├──────────────┼────────┼────────────────────────────────┤
│ 目标 MAC     │ 6 字节 │ 目标主机的 MAC 地址            │
│              │        │ FF:FF:FF:FF:FF:FF = 广播       │
├──────────────┼────────┼────────────────────────────────┤
│ 源 MAC       │ 6 字节 │ 源主机的 MAC 地址              │
├──────────────┼────────┼────────────────────────────────┤
│ 类型/长度    │ 2 字节 │ ≥1536: 类型 (0x0800=IPv4)     │
│              │        │ ≤1500: 长度                    │
├──────────────┼────────┼────────────────────────────────┤
│ 数据         │46-1500 │ 上层协议数据 (IP包)            │
│              │  字节  │ 最小 46 字节 (不足填充)        │
├──────────────┼────────┼────────────────────────────────┤
│ FCS          │ 4 字节 │ 帧校验序列 (CRC-32)            │
│(Frame Check) │        │ 用于错误检测                   │
└──────────────┴────────┴────────────────────────────────┘

常见以太网类型字段:
├─ 0x0800  IPv4
├─ 0x0806  ARP
├─ 0x86DD  IPv6
├─ 0x8100  VLAN (802.1Q)
└─ 0x88CC  LLDP

帧大小限制:
├─ 最小帧: 64 字节 (包含 FCS)
│  数据最小: 46 字节 (不足填充 Padding)
│
├─ 最大帧 (标准): 1518 字节
│  数据最大: 1500 字节 (MTU)
│
└─ 巨型帧 (Jumbo Frame): 最大 9000 字节
   用于数据中心,减少 CPU 开销
```

### MAC 地址

```
MAC 地址 (Media Access Control Address):

格式: 48 位 = 6 字节 = 12 个十六进制数
示例: 00:1A:2B:3C:4D:5E

表示方法:
├─ 冒号分隔: 00:1A:2B:3C:4D:5E (Linux/Unix)
├─ 连字符:   00-1A-2B-3C-4D-5E (Windows)
└─ 点分隔:   001A.2B3C.4D5E   (Cisco)

MAC 地址结构:
┌──────────────────────────┬──────────────────────────┐
│   OUI (24位)             │   厂商分配 (24位)        │
│   组织唯一标识符         │   设备唯一序列号         │
├──────────────────────────┼──────────────────────────┤
│   00:1A:2B               │   3C:4D:5E               │
└──────────────────────────┴──────────────────────────┘

第一个字节的最低两位:
┌─────────────────────────────────────────────────────┐
│  00:1A:2B:3C:4D:5E                                  │
│  ↓↓                                                 │
│  00 = 00000000 (二进制)                             │
│        ↑    ↑                                       │
│        │    └─ 第1位 (I/G): 0=单播, 1=组播/广播    │
│        └────── 第2位 (U/L): 0=全球, 1=本地管理     │
└─────────────────────────────────────────────────────┘

特殊 MAC 地址:
├─ 单播 (Unicast):
│  00:00:00:00:00:00 ~ 7F:FF:FF:FF:FF:FF
│  目标是单个设备
│
├─ 组播 (Multicast):
│  01:00:5E:xx:xx:xx (IPv4 组播)
│  33:33:xx:xx:xx:xx (IPv6 组播)
│  第一字节最低位为 1
│
└─ 广播 (Broadcast):
   FF:FF:FF:FF:FF:FF
   所有设备都会接收

常见厂商 OUI:
├─ 00:50:56  VMware
├─ 00:0C:29  VMware
├─ 08:00:27  VirtualBox
├─ 00:1C:42  Parallels
├─ 00:15:5D  Microsoft Hyper-V
├─ 3C:07:54  Raspberry Pi
└─ 查询 OUI: https://maclookup.app/

查看 MAC 地址:
# Linux
ip link show
ifconfig

# Windows
ipconfig /all
getmac

# 查看 ARP 缓存 (IP-MAC 映射)
arp -a
ip neigh show
```

### CSMA/CD

```
CSMA/CD (Carrier Sense Multiple Access with Collision Detection)
载波侦听多路访问/冲突检测

工作原理 (半双工以太网):
┌─────────────────────────────────────────────────────────────┐
│  1. 监听信道 (Carrier Sense)                                │
│     ├─ 信道空闲 → 发送数据                                  │
│     └─ 信道忙 → 等待                                        │
│                                                              │
│  2. 边发送边检测 (Collision Detection)                      │
│     ├─ 检测到冲突 → 停止发送                                │
│     └─ 未检测到冲突 → 继续发送                              │
│                                                              │
│  3. 冲突处理                                                 │
│     ├─ 发送 Jam 信号 (告诉其他站点发生冲突)                │
│     ├─ 等待随机退避时间 (Binary Exponential Backoff)       │
│     └─ 重试 (最多 16 次)                                    │
└─────────────────────────────────────────────────────────────┘

冲突检测示例:
    A 站                      B 站
    │                         │
    │──► 开始发送             │
    │                         │──► 开始发送
    │                         │
    │    ◄──── 冲突! ────►    │
    │                         │
    │ 发送 Jam 信号           │ 发送 Jam 信号
    │                         │
    │ 等待随机时间            │ 等待随机时间
    │                         │
    │──► 重新发送             │
    │                    成功 │
    └─────────────────────────┘

最小帧长度:
├─ 为了检测冲突,帧必须足够长
├─ 发送站在发送完最后一位前必须能检测到冲突
├─ 10Mbps 以太网,最小帧 64 字节
└─ 现代交换式以太网使用全双工,无需 CSMA/CD

现代以太网:
├─ 交换机代替集线器
├─ 全双工通信 (同时收发)
├─ 无冲突
└─ 不需要 CSMA/CD
```

## 二、ARP 协议

### ARP 工作原理

```
ARP (Address Resolution Protocol) 地址解析协议
功能: IP 地址 → MAC 地址

ARP 请求/响应流程:
┌─────────────────────────────────────────────────────────────┐
│  主机 A (192.168.1.10) 想要与主机 B (192.168.1.20) 通信    │
└─────────────────────────────────────────────────────────────┘

1. ARP 请求 (广播):
┌──────────────┐                              ┌──────────────┐
│   主机 A     │                              │   主机 B     │
│192.168.1.10  │                              │192.168.1.20  │
│AA:AA:AA:AA:AA│                              │BB:BB:BB:BB:BB│
└──────┬───────┘                              └──────▲───────┘
       │                                             │
       │ ARP 请求 (广播):                            │
       │ "谁是 192.168.1.20? 请告诉 192.168.1.10"   │
       │ 目标 MAC: FF:FF:FF:FF:FF:FF                 │
       │─────────────────────────────────────────────┘
       │
       │  其他主机 (192.168.1.30, etc.) 收到后忽略
       │

2. ARP 响应 (单播):
┌──────────────┐                              ┌──────────────┐
│   主机 A     │◄─────────────────────────────│   主机 B     │
│192.168.1.10  │                              │192.168.1.20  │
│AA:AA:AA:AA:AA│                              │BB:BB:BB:BB:BB│
└──────────────┘                              └──────────────┘
       │                                             │
       │ ARP 响应 (单播):                            │
       │ "我是 192.168.1.20, MAC: BB:BB:BB:BB:BB"   │
       │ 目标 MAC: AA:AA:AA:AA:AA                    │
       └─────────────────────────────────────────────┘

ARP 数据包格式:
┌──────────────────────────────────────────────────────────┐
│  以太网头部                                               │
│  ├─ 目标 MAC: FF:FF:FF:FF:FF:FF (请求) / 具体MAC (响应) │
│  ├─ 源 MAC: 发送者 MAC                                   │
│  └─ 类型: 0x0806 (ARP)                                   │
├──────────────────────────────────────────────────────────┤
│  ARP 数据                                                 │
│  ├─ 硬件类型: 1 (以太网)                                │
│  ├─ 协议类型: 0x0800 (IPv4)                             │
│  ├─ 硬件地址长度: 6                                      │
│  ├─ 协议地址长度: 4                                      │
│  ├─ 操作码: 1=请求, 2=响应                              │
│  ├─ 发送者 MAC 地址                                      │
│  ├─ 发送者 IP 地址                                       │
│  ├─ 目标 MAC 地址 (请求时为 0)                          │
│  └─ 目标 IP 地址                                         │
└──────────────────────────────────────────────────────────┘

ARP 缓存:
├─ 系统维护一个 ARP 缓存表
├─ 存储 IP → MAC 映射
├─ 减少 ARP 请求次数
└─ 条目有超时时间 (通常 2-20 分钟)

查看 ARP 缓存:
# Linux
arp -a
ip neigh show

# Windows
arp -a

# 输出示例:
# 192.168.1.1    ether   aa:bb:cc:dd:ee:ff   C     eth0
# 192.168.1.20   ether   11:22:33:44:55:66   C     eth0

操作 ARP 缓存:
# 添加静态 ARP 条目
arp -s 192.168.1.100 aa:bb:cc:dd:ee:ff

# 删除 ARP 条目
arp -d 192.168.1.100

# 清空 ARP 缓存
ip neigh flush all
```

### ARP 攻击

```
ARP 欺骗 (ARP Spoofing) / ARP 中毒 (ARP Poisoning):

正常通信:
┌─────────┐                 ┌─────────┐                 ┌─────────┐
│ 主机 A  │────────────────►│  网关   │────────────────►│ 互联网  │
│192.168  │                 │192.168  │                 │         │
│  .1.10  │                 │  .1.1   │                 │         │
└─────────┘                 └─────────┘                 └─────────┘

ARP 欺骗攻击:
┌─────────┐                 ┌─────────┐                 ┌─────────┐
│ 主机 A  │────────┐        │  网关   │                 │ 互联网  │
│192.168  │        │        │192.168  │                 │         │
│  .1.10  │        │        │  .1.1   │                 │         │
└─────────┘        │        └────▲────┘                 └─────────┘
                   │             │
                   ▼             │
              ┌─────────┐        │
              │ 攻击者  │────────┘
              │192.168  │ 伪装成网关
              │  .1.50  │ 转发流量
              └─────────┘

攻击步骤:
1. 攻击者发送虚假 ARP 响应
   "我是 192.168.1.1 (网关), MAC: 攻击者MAC"
2. 主机 A 更新 ARP 缓存
3. 主机 A 的流量发送到攻击者
4. 攻击者可以:
   ├─ 窃听流量 (中间人攻击)
   ├─ 修改数据包
   └─ 丢弃数据包 (DoS)

防御措施:
├─ 静态 ARP 条目
├─ 动态 ARP 检测 (DAI) - 交换机功能
├─ ARP 监控工具 (arpwatch, ARPon)
├─ 使用加密协议 (HTTPS, SSH)
└─ 端口安全 (Port Security)

检测 ARP 欺骗:
# 监控 ARP 变化
arpwatch

# 检查 ARP 缓存异常
arp -a | grep "192.168.1.1"
# 如果同一 IP 有多个 MAC,可能被攻击

# 使用 arp-scan
arp-scan --interface=eth0 --localnet
```

### RARP/InARP

```
RARP (Reverse ARP) 反向地址解析协议:
功能: MAC 地址 → IP 地址
用途: 无盘工作站获取 IP
现状: 已被 DHCP/BOOTP 取代

InARP (Inverse ARP):
功能: 在已知链路层地址时获取网络层地址
用途: 帧中继等 NBMA 网络
```

## 三、交换机

### 交换机工作原理

```
交换机 (Switch) 工作在数据链路层:

MAC 地址表 (CAM表):
┌──────────────────┬──────────┬──────┐
│    MAC 地址      │   端口   │ 老化 │
├──────────────────┼──────────┼──────┤
│ AA:AA:AA:AA:AA   │    1     │ 300s │
│ BB:BB:BB:BB:BB   │    2     │ 300s │
│ CC:CC:CC:CC:CC   │    3     │ 300s │
│ DD:DD:DD:DD:DD   │    4     │ 300s │
└──────────────────┴──────────┴──────┘

工作流程:
1. 学习 (Learning):
   └─ 记录源 MAC 地址和入端口

2. 转发 (Forwarding):
   ├─ 查找目标 MAC 在 CAM 表中
   ├─ 已知 → 单播转发到对应端口
   └─ 未知 → 泛洪 (除入端口外的所有端口)

3. 过滤 (Filtering):
   └─ 目标 MAC 在同一端口 → 不转发

4. 老化 (Aging):
   └─ 超时未更新的条目被删除 (默认 300秒)

示例:
┌─────────────────────────────────────────────────────────┐
│                     交换机                               │
│  ┌──────────────────────────────────────────────────┐   │
│  │ CAM 表:                                          │   │
│  │ AA:AA → 端口1, BB:BB → 端口2                    │   │
│  └──────────────────────────────────────────────────┘   │
│                                                          │
│   端口1      端口2      端口3      端口4                │
│     │         │          │          │                   │
└─────┼─────────┼──────────┼──────────┼───────────────────┘
      │         │          │          │
   ┌──┴──┐   ┌──┴──┐   ┌──┴──┐   ┌──┴──┐
   │PC-A │   │PC-B │   │PC-C │   │PC-D │
   │AA:AA│   │BB:BB│   │CC:CC│   │DD:DD│
   └─────┘   └─────┘   └─────┘   └─────┘

PC-A 发送帧给 PC-B:
1. 帧到达端口1,交换机学习: AA:AA → 端口1
2. 查找目标 BB:BB → 端口2 (已知)
3. 从端口2 单播转发

PC-A 发送帧给 PC-C (MAC 未知):
1. 帧到达端口1
2. 查找目标 CC:CC → 未知
3. 泛洪到端口 2, 3, 4

交换机 vs 集线器:
┌────────────┬────────────────┬────────────────┐
│   特性     │    集线器      │    交换机      │
├────────────┼────────────────┼────────────────┤
│ OSI 层     │ 物理层         │ 数据链路层     │
│ 转发方式   │ 广播           │ 单播/组播/广播 │
│ 冲突域     │ 所有端口共享   │ 每端口独立     │
│ 带宽       │ 共享           │ 独享           │
│ 智能       │ 无             │ MAC 地址学习   │
│ 使用       │ 已淘汰         │ 广泛使用       │
└────────────┴────────────────┴────────────────┘
```

### VLAN

```
VLAN (Virtual LAN) 虚拟局域网:

作用:
├─ 分隔广播域
├─ 提高安全性
├─ 灵活的网络管理
└─ 节省 IP 地址

VLAN 类型:
1. 基于端口 (Port-based VLAN):
   └─ 最常用,每个端口属于一个 VLAN

2. 基于 MAC (MAC-based VLAN):
   └─ 根据 MAC 地址分配

3. 基于协议 (Protocol-based VLAN):
   └─ 根据协议类型分配

VLAN 示例:
┌─────────────────────────────────────────────────────────────┐
│                       交换机                                 │
│  ┌────────────────────┬──────────────────────┐              │
│  │   VLAN 10 (销售)   │   VLAN 20 (技术)     │              │
│  │   端口 1-10        │   端口 11-20         │              │
│  └────────────────────┴──────────────────────┘              │
│                                                              │
│   端口1   端口2   端口11  端口12   Trunk端口24              │
│     │      │       │       │          │                     │
└─────┼──────┼───────┼───────┼──────────┼─────────────────────┘
      │      │       │       │          │
    PC-A   PC-B    PC-C    PC-D      另一台交换机
   (VLAN10)(VLAN10)(VLAN20)(VLAN20)

VLAN 间通信:
├─ 同一 VLAN: 直接通信
├─ 不同 VLAN: 需要三层设备 (路由器/三层交换机)
└─ VLAN 间路由 (Inter-VLAN Routing)

802.1Q 帧格式 (VLAN 标签):
┌──────────────────────────────────────────────────────────┐
│  以太网头部 (原始)                                        │
│  ├─ 目标 MAC (6B)                                        │
│  ├─ 源 MAC (6B)                                          │
├──────────────────────────────────────────────────────────┤
│  802.1Q 标签 (插入 4 字节)                               │
│  ├─ TPID (2B): 0x8100 (标识为 VLAN 帧)                  │
│  ├─ TCI (2B):                                            │
│  │   ├─ PCP (3 bits): 优先级                            │
│  │   ├─ DEI (1 bit): 丢弃指示                           │
│  │   └─ VID (12 bits): VLAN ID (1-4094)                 │
├──────────────────────────────────────────────────────────┤
│  类型/长度 (2B)                                          │
│  数据                                                     │
│  FCS (4B)                                                │
└──────────────────────────────────────────────────────────┘

Trunk 链路:
├─ 连接交换机之间的链路
├─ 承载多个 VLAN 的流量
├─ 使用 802.1Q 标签
└─ Native VLAN: 不打标签的 VLAN (默认 VLAN 1)

配置示例 (Cisco):
# 创建 VLAN
Switch(config)# vlan 10
Switch(config-vlan)# name Sales

# 分配端口到 VLAN
Switch(config)# interface fa0/1
Switch(config-if)# switchport mode access
Switch(config-if)# switchport access vlan 10

# 配置 Trunk
Switch(config)# interface gi0/1
Switch(config-if)# switchport mode trunk
Switch(config-if)# switchport trunk allowed vlan 10,20,30
```

### STP

```
STP (Spanning Tree Protocol) 生成树协议:

作用:
├─ 防止交换网络中的环路
├─ 提供冗余链路
└─ 自动阻塞冗余路径

网络环路问题:
┌─────────┐
│ Switch1 │───────┐
└────┬────┘       │
     │            │
     │            │
┌────┴────┐  ┌────┴────┐
│ Switch2 │──│ Switch3 │
└─────────┘  └─────────┘

问题:
├─ 广播风暴: 广播帧无限循环
├─ MAC 表抖动: MAC 地址在多个端口间变化
└─ 多帧复制: 同一帧被多次接收

STP 工作原理:
1. 选举根桥 (Root Bridge)
   └─ 最小的 Bridge ID (优先级 + MAC)

2. 选择根端口 (Root Port)
   └─ 每个非根桥上到根桥最短路径的端口

3. 选择指定端口 (Designated Port)
   └─ 每个网段上到根桥最短路径的端口

4. 阻塞其他端口 (Blocking Port)
   └─ 防止环路

端口状态:
┌────────────┬────────────────────────────────────┐
│   状态     │              说明                  │
├────────────┼────────────────────────────────────┤
│ Disabled   │ 管理性关闭                         │
├────────────┼────────────────────────────────────┤
│ Blocking   │ 不转发数据,只接收 BPDU             │
│            │ (防止环路)                         │
├────────────┼────────────────────────────────────┤
│ Listening  │ 过渡状态,学习网络拓扑 (15秒)       │
│            │ 不学习 MAC,不转发数据              │
├────────────┼────────────────────────────────────┤
│ Learning   │ 学习 MAC 地址 (15秒)               │
│            │ 不转发数据                         │
├────────────┼────────────────────────────────────┤
│ Forwarding │ 正常转发数据,学习 MAC              │
└────────────┴────────────────────────────────────┘

收敛时间:
Blocking → Listening (0s) → Learning (15s) → Forwarding (15s)
总计: 30-50 秒

STP 变种:
┌──────────┬────────────────┬──────────────────┐
│   协议   │    标准        │     收敛时间     │
├──────────┼────────────────┼──────────────────┤
│ STP      │ 802.1D         │ 30-50 秒         │
├──────────┼────────────────┼──────────────────┤
│ RSTP     │ 802.1w         │ 1-2 秒           │
│(快速STP) │                │ (快速收敛)       │
├──────────┼────────────────┼──────────────────┤
│ MSTP     │ 802.1s         │ 快速             │
│(多生成树)│                │ (支持多VLAN)     │
├──────────┼────────────────┼──────────────────┤
│ PVST+    │ Cisco 私有     │ 每VLAN一棵树     │
└──────────┴────────────────┴──────────────────┘

配置示例:
# 启用 RSTP
Switch(config)# spanning-tree mode rapid-pvst

# 设置根桥
Switch(config)# spanning-tree vlan 1 root primary

# 查看 STP 状态
Switch# show spanning-tree
```

这是数据链路层协议教程,涵盖了以太网、ARP、交换机和VLAN等核心内容。