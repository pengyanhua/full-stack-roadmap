# 网络层协议

## 一、IP 协议 (Internet Protocol)

### IPv4 数据包格式

```
IPv4 数据包头部 (20-60 字节):

 0                   1                   2                   3
 0 1 2 3 4 5 6 7 8 9 0 1 2 3 4 5 6 7 8 9 0 1 2 3 4 5 6 7 8 9 0 1
+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+
|版本 |头部长度|  服务类型(TOS) |          总长度                |
|(4位)| (4位)  |   (8位)        |         (16位)                |
+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+
|           标识 (16位)          |标志|    片偏移 (13位)         |
|                                |(3位)|                         |
+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+
|  生存时间(TTL) |    协议(8位)   |         头部校验和            |
|    (8位)       |                |          (16位)              |
+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+
|                       源 IP 地址 (32位)                        |
+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+
|                      目标 IP 地址 (32位)                       |
+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+
|                    选项 (可变长度,0-40字节)                    |
+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+
|                          数据                                  |
+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+

字段详解:
├─ 版本 (4位): IPv4 = 4
├─ 头部长度 (4位): 头部长度/4 (最小5,最大15)
├─ 服务类型 (8位):
│  ├─ DSCP (6位): 区分服务
│  └─ ECN (2位): 显式拥塞通知
├─ 总长度 (16位): 整个IP包的长度 (最大65535字节)
├─ 标识 (16位): 用于分片重组
├─ 标志 (3位):
│  ├─ 保留位: 0
│  ├─ DF (Don't Fragment): 不分片
│  └─ MF (More Fragments): 还有更多片
├─ 片偏移 (13位): 分片在原始数据中的位置
├─ TTL (8位): 生存时间 (跳数限制)
├─ 协议 (8位): 上层协议 (6=TCP, 17=UDP, 1=ICMP)
├─ 头部校验和 (16位): 只校验头部
├─ 源/目标 IP: 32位地址
└─ 选项: 可选字段 (如记录路由、时间戳)

TTL (Time To Live):
├─ 每经过一个路由器减 1
├─ TTL=0 时丢弃数据包
├─ 防止数据包在网络中无限循环
├─ 默认值:
│  ├─ Linux: 64
│  ├─ Windows: 128
│  └─ Cisco: 255
└─ traceroute 利用 TTL 追踪路径

协议字段常见值:
├─ 1   ICMP (Internet Control Message Protocol)
├─ 2   IGMP (Internet Group Management Protocol)
├─ 6   TCP (Transmission Control Protocol)
├─ 17  UDP (User Datagram Protocol)
├─ 41  IPv6 (IPv6 封装)
├─ 47  GRE (Generic Routing Encapsulation)
└─ 50  ESP (Encapsulating Security Payload, IPSec)
```

### IP 分片

```
IP 分片 (Fragmentation):

原因: 数据包大于 MTU (Maximum Transmission Unit)

分片示例:
原始数据包 (3000 字节):
┌────────────────────────────────────────────────────────────┐
│ IP头(20B) │          数据 (2980 字节)                      │
└────────────────────────────────────────────────────────────┘

MTU = 1500 字节,需要分片:

分片1:
┌────────────────────────────────────────────────────────────┐
│ IP头(20B) │ 数据(1480B) │ 标识=100, MF=1, 偏移=0         │
└────────────────────────────────────────────────────────────┘

分片2:
┌────────────────────────────────────────────────────────────┐
│ IP头(20B) │ 数据(1480B) │ 标识=100, MF=1, 偏移=185       │
└────────────────────────────────────────────────────────────┘
                          ↑ 偏移 = 1480/8 = 185

分片3:
┌────────────────────────────────────────────────────────────┐
│ IP头(20B) │ 数据(20B)   │ 标识=100, MF=0, 偏移=370       │
└────────────────────────────────────────────────────────────┘

分片字段:
├─ 标识: 所有分片相同
├─ MF (More Fragments): 最后一片为 0
├─ 片偏移: 以 8 字节为单位
└─ 总长度: 每个分片的实际长度

重组:
├─ 由目标主机负责重组
├─ 根据标识、源IP、目标IP 识别分片
├─ 按偏移量排序重组
└─ 丢失任何一个分片,整个包作废

Path MTU Discovery (PMTUD):
├─ 发送时设置 DF (Don't Fragment) 标志
├─ 如果路径上有更小的 MTU,收到 ICMP "需要分片" 消息
├─ 发送方调整包大小
└─ 避免分片,提高效率

常见 MTU 值:
├─ 以太网: 1500
├─ PPPoE: 1492 (1500 - 8)
├─ VPN: 1400-1450
├─ Jumbo Frame: 9000
└─ 互联网最小: 576 (保证不分片)

查看 MTU:
# Linux
ip link show eth0
ifconfig eth0

# Windows
netsh interface ipv4 show subinterfaces

# 设置 MTU
sudo ip link set eth0 mtu 1400
```

### IPv6

```
IPv6 数据包格式:

IPv6 固定头部 (40 字节):
 0                   1                   2                   3
 0 1 2 3 4 5 6 7 8 9 0 1 2 3 4 5 6 7 8 9 0 1 2 3 4 5 6 7 8 9 0 1
+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+
|版本 | 流量类别 |           流标签 (20位)                      |
|(4位)| (8位)    |                                             |
+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+
|        载荷长度 (16位)         |下一个头部(8位)|跳数限制(8位)|
+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+
|                                                                |
+                                                               +
|                                                                |
+                        源 IPv6 地址 (128位)                   +
|                                                                |
+                                                               +
|                                                                |
+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+
|                                                                |
+                                                               +
|                                                                |
+                       目标 IPv6 地址 (128位)                  +
|                                                                |
+                                                               +
|                                                                |
+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+

IPv6 改进:
├─ 地址空间: 128位 (340万亿亿亿亿个地址)
├─ 固定头部: 简化处理,提高路由效率
├─ 无头部校验和: 由上层协议负责
├─ 分片: 只在源端进行
├─ 无广播: 使用组播代替
├─ 自动配置: SLAAC (无状态地址自动配置)
├─ 内置 IPSec: 强制安全
└─ 服务质量: 流标签支持 QoS

IPv6 扩展头部:
├─ 逐跳选项 (Hop-by-Hop Options)
├─ 路由 (Routing)
├─ 分片 (Fragment)
├─ 目标选项 (Destination Options)
├─ 认证 (Authentication Header, AH)
└─ 封装安全载荷 (ESP)

IPv6 地址类型:
├─ 单播 (Unicast):
│  ├─ 全球单播: 2000::/3
│  ├─ 链路本地: fe80::/10
│  └─ 唯一本地: fc00::/7
├─ 组播 (Multicast): ff00::/8
│  ├─ 所有节点: ff02::1
│  └─ 所有路由器: ff02::2
└─ 任播 (Anycast): 与单播相同格式

IPv4 vs IPv6 对比:
┌────────────────┬────────────┬────────────────┐
│      特性      │   IPv4     │     IPv6       │
├────────────────┼────────────┼────────────────┤
│   地址长度     │  32位      │   128位        │
│   头部长度     │  20-60字节 │   40字节(固定) │
│   校验和       │  有        │   无           │
│   分片         │  路由器    │   源端         │
│   广播         │  有        │   无(用组播)   │
│   配置         │  DHCP/手动 │   自动/DHCPv6  │
│   安全         │  可选      │   内置IPSec    │
└────────────────┴────────────┴────────────────┘
```

## 二、ICMP 协议

### ICMP 消息类型

```
ICMP (Internet Control Message Protocol) 控制报文协议:

ICMP 报文格式:
 0                   1                   2                   3
 0 1 2 3 4 5 6 7 8 9 0 1 2 3 4 5 6 7 8 9 0 1 2 3 4 5 6 7 8 9 0 1
+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+
|     类型 (8位)  |    代码 (8位)  |        校验和 (16位)        |
+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+
|                       消息内容 (可变)                          |
+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+

常见 ICMP 消息:
┌──────┬──────┬────────────────────────────────────────┐
│ 类型 │ 代码 │              说明                      │
├──────┼──────┼────────────────────────────────────────┤
│  0   │  0   │ Echo Reply (ping 响应)                 │
├──────┼──────┼────────────────────────────────────────┤
│  3   │      │ Destination Unreachable (目标不可达)   │
│      │  0   │   - 网络不可达                         │
│      │  1   │   - 主机不可达                         │
│      │  2   │   - 协议不可达                         │
│      │  3   │   - 端口不可达                         │
│      │  4   │   - 需要分片但设置了 DF                │
├──────┼──────┼────────────────────────────────────────┤
│  4   │  0   │ Source Quench (源抑制,已弃用)          │
├──────┼──────┼────────────────────────────────────────┤
│  5   │      │ Redirect (重定向)                      │
│      │  0   │   - 网络重定向                         │
│      │  1   │   - 主机重定向                         │
├──────┼──────┼────────────────────────────────────────┤
│  8   │  0   │ Echo Request (ping 请求)               │
├──────┼──────┼────────────────────────────────────────┤
│  9   │  0   │ Router Advertisement (路由器通告)      │
├──────┼──────┼────────────────────────────────────────┤
│ 10   │  0   │ Router Solicitation (路由器请求)       │
├──────┼──────┼────────────────────────────────────────┤
│ 11   │      │ Time Exceeded (超时)                   │
│      │  0   │   - TTL 超时 (traceroute 利用)         │
│      │  1   │   - 分片重组超时                       │
├──────┼──────┼────────────────────────────────────────┤
│ 12   │  0   │ Parameter Problem (参数问题)           │
└──────┴──────┴────────────────────────────────────────┘
```

### ping 工作原理

```
ping 命令:

工作流程:
主机 A (192.168.1.10)              主机 B (192.168.1.20)
     │                                    │
     │ ICMP Echo Request (类型=8)         │
     │ 序列号=1, 数据="hello"             │
     │────────────────────────────────────►│
     │                                    │
     │ ICMP Echo Reply (类型=0)           │
     │ 序列号=1, 数据="hello"             │
     │◄────────────────────────────────────│
     │                                    │
     │ ICMP Echo Request (类型=8)         │
     │ 序列号=2, 数据="hello"             │
     │────────────────────────────────────►│
     │                                    │
     │ ICMP Echo Reply (类型=0)           │
     │ 序列号=2, 数据="hello"             │
     │◄────────────────────────────────────│

ping 输出解析:
$ ping -c 4 google.com
PING google.com (142.250.185.46): 56 data bytes
64 bytes from 142.250.185.46: icmp_seq=0 ttl=118 time=15.2 ms
64 bytes from 142.250.185.46: icmp_seq=1 ttl=118 time=14.8 ms
64 bytes from 142.250.185.46: icmp_seq=2 ttl=118 time=15.1 ms
64 bytes from 142.250.185.46: icmp_seq=3 ttl=118 time=15.0 ms

--- google.com ping statistics ---
4 packets transmitted, 4 packets received, 0% packet loss
round-trip min/avg/max/stddev = 14.8/15.0/15.2/0.2 ms

字段说明:
├─ 64 bytes: ICMP 包大小 (含 IP 头)
├─ icmp_seq: 序列号
├─ ttl: 剩余跳数 (原始值 - 已经过的跳数)
├─ time: 往返时间 (RTT)
└─ 统计: 发送、接收、丢包率、RTT 范围

ping 选项:
# 指定次数
ping -c 4 google.com

# 指定间隔
ping -i 0.5 google.com       # 0.5秒一次

# 指定包大小
ping -s 1000 google.com      # 1000字节数据

# 快速ping (flood,需要root)
sudo ping -f google.com

# 记录路由 (最多9跳)
ping -R google.com

# IPv6
ping6 google.com

# 指定源地址
ping -I eth0 google.com

# 安静模式 (只显示统计)
ping -q -c 10 google.com
```

### traceroute 工作原理

```
traceroute 追踪路由路径:

原理: 利用 ICMP 超时消息和递增的 TTL

工作流程:
主机 A                路由器1           路由器2           目标 B
  │                     │                 │                │
  │ TTL=1               │                 │                │
  │─────────────────────►                 │                │
  │                     │ TTL减为0        │                │
  │ ICMP Time Exceeded  │                 │                │
  │◄─────────────────────                 │                │
  │                     │                 │                │
  │ TTL=2               │                 │                │
  │─────────────────────►                 │                │
  │                     │ TTL=1           │                │
  │                     │─────────────────►                │
  │                     │                 │ TTL减为0       │
  │                     │ ICMP Time Exceeded                │
  │◄──────────────────────────────────────│                │
  │                     │                 │                │
  │ TTL=3               │                 │                │
  │─────────────────────►                 │                │
  │                     │ TTL=2           │                │
  │                     │─────────────────►                │
  │                     │                 │ TTL=1          │
  │                     │                 │────────────────►│
  │                     │                 │                │ 到达目标
  │                     │                 │ ICMP Echo Reply│
  │◄──────────────────────────────────────────────────────│

traceroute 输出:
$ traceroute google.com
traceroute to google.com (142.250.185.46), 30 hops max, 60 byte packets
 1  192.168.1.1 (192.168.1.1)  1.234 ms  1.123 ms  1.089 ms
 2  10.0.0.1 (10.0.0.1)  5.456 ms  5.234 ms  5.123 ms
 3  172.16.0.1 (172.16.0.1)  10.789 ms  10.567 ms  10.456 ms
 4  * * *
 5  142.250.185.46 (142.250.185.46)  15.234 ms  15.123 ms  15.089 ms

字段说明:
├─ 跳数: 路由器跳数
├─ IP/主机名: 路由器地址
├─ 三个时间: 三次探测的 RTT
└─ * * *: 该路由器不响应或防火墙阻止

traceroute 实现差异:
Linux:
├─ 默认使用 UDP (端口 33434+)
├─ 目标主机返回 ICMP "端口不可达"
└─ 选项: -I (使用 ICMP), -T (使用 TCP)

Windows (tracert):
├─ 使用 ICMP Echo Request
└─ 目标主机返回 ICMP Echo Reply

traceroute 选项:
# 使用 ICMP
traceroute -I google.com

# 使用 TCP (端口80)
traceroute -T -p 80 google.com

# 指定最大跳数
traceroute -m 15 google.com

# 不解析主机名
traceroute -n google.com

# 指定探测包数
traceroute -q 5 google.com

# mtr (更好的 traceroute)
mtr google.com                # 实时显示
mtr -r -c 10 google.com       # 报告模式,10次
```

## 三、IGMP 协议

```
IGMP (Internet Group Management Protocol) 组管理协议:

作用:
├─ 管理多播组成员
├─ 主机通知路由器加入/离开多播组
└─ 路由器查询哪些主机在多播组中

IGMP 版本:
├─ IGMPv1: 基本功能
├─ IGMPv2: 添加离开组消息
└─ IGMPv3: 支持源特定多播 (SSM)

IGMP 消息类型:
├─ 成员查询 (Membership Query): 路由器 → 主机
├─ 成员报告 (Membership Report): 主机 → 路由器
└─ 离开组 (Leave Group): 主机 → 路由器 (v2+)

多播地址:
├─ 224.0.0.0/4 (D 类地址)
├─ 224.0.0.0 - 224.0.0.255: 本地链路 (不转发)
│  ├─ 224.0.0.1: 所有主机
│  ├─ 224.0.0.2: 所有路由器
│  └─ 224.0.0.5: OSPF 路由器
├─ 224.0.1.0 - 238.255.255.255: 全球范围
└─ 239.0.0.0 - 239.255.255.255: 管理范围

应用场景:
├─ IPTV
├─ 视频会议
├─ 股票行情推送
└─ 软件分发
```

## 四、路由协议详解

### RIP (Routing Information Protocol)

```
RIP 特点:
├─ 距离矢量路由协议
├─ 使用跳数作为度量 (最大15跳)
├─ 每30秒广播完整路由表
├─ 简单但收敛慢
└─ 适合小型网络

RIP 版本:
┌────────┬────────────────────────────────────────┐
│  版本  │               特点                     │
├────────┼────────────────────────────────────────┤
│ RIPv1  │ 有类路由,广播更新,无认证               │
├────────┼────────────────────────────────────────┤
│ RIPv2  │ 无类路由,组播更新(224.0.0.9),支持认证 │
├────────┼────────────────────────────────────────┤
│ RIPng  │ IPv6 版本                              │
└────────┴────────────────────────────────────────┘

RIP 计时器:
├─ 更新定时器 (Update): 30秒
├─ 无效定时器 (Invalid): 180秒 (未收到更新)
├─ 保持定时器 (Holddown): 180秒
└─ 刷新定时器 (Flush): 240秒 (删除路由)

防止路由环路:
├─ 最大跳数 (16 = 无穷大)
├─ 水平分割 (不向学习路由的接口发回)
├─ 毒性逆转 (向源接口发送不可达信息)
└─ 触发更新 (路由变化立即通知)

配置示例 (Cisco):
router rip
 version 2                  # 使用 RIPv2
 network 192.168.1.0        # 宣告网络
 network 10.0.0.0
 no auto-summary            # 关闭自动汇总
 passive-interface gi0/0    # 被动接口(不发送更新)
```

### OSPF (Open Shortest Path First)

```
OSPF 特点:
├─ 链路状态路由协议
├─ 使用 Dijkstra 算法计算最短路径
├─ 支持 VLSM 和 CIDR
├─ 快速收敛
├─ 无跳数限制
└─ 企业网络首选

OSPF 区域:
┌────────────────────────────────────────────────────────────┐
│                     Area 0 (骨干区域)                       │
│  ┌──────────┐         ┌──────────┐         ┌──────────┐   │
│  │ 路由器1  │────────│ 路由器2  │────────│ 路由器3  │   │
│  └──────────┘         └────┬─────┘         └────┬─────┘   │
└───────────────────────────┼────────────────────┼──────────┘
                            │                    │
          ┌─────────────────┴──┐    ┌───────────┴────────┐
          │     Area 1         │    │      Area 2        │
          │  (标准区域)         │    │   (标准区域)        │
          └────────────────────┘    └────────────────────┘

区域类型:
├─ 骨干区域 (Area 0): 必须存在,其他区域必须连接到骨干
├─ 标准区域: 接受所有类型的 LSA
├─ 末梢区域 (Stub): 不接受外部路由
├─ 完全末梢 (Totally Stub): 只有默认路由
└─ NSSA (Not-So-Stubby): 允许部分外部路由

OSPF 邻居状态:
Down → Init → 2-Way → ExStart → Exchange → Loading → Full

OSPF 报文类型:
├─ Hello: 发现邻居,维持邻居关系
├─ DBD (Database Description): 数据库描述
├─ LSR (Link State Request): 链路状态请求
├─ LSU (Link State Update): 链路状态更新
└─ LSAck: 链路状态确认

度量值计算:
Cost = 参考带宽 / 接口带宽
├─ 参考带宽默认 100Mbps
├─ FastEthernet (100Mbps): Cost = 1
├─ Ethernet (10Mbps): Cost = 10
└─ Serial (1.544Mbps): Cost = 64

配置示例:
router ospf 1                    # 进程ID
 router-id 1.1.1.1               # 路由器ID
 network 192.168.1.0 0.0.0.255 area 0
 network 10.0.0.0 0.255.255.255 area 1
 passive-interface gi0/0
 auto-cost reference-bandwidth 10000  # 参考带宽10Gbps
```

### BGP (Border Gateway Protocol)

```
BGP 特点:
├─ 路径矢量协议
├─ 互联网核心路由协议
├─ 使用 TCP 端口 179
├─ 基于策略的路由选择
└─ AS (自治系统) 间路由

AS 号:
├─ 16位: 1-65535
│  ├─ 公有 AS: 1-64511
│  └─ 私有 AS: 64512-65535
└─ 32位: 1-4294967295 (扩展)

BGP 类型:
├─ eBGP (External BGP): AS 间
│  └─ TTL = 1 (直连)
└─ iBGP (Internal BGP): AS 内
    └─ TTL = 255

BGP 消息类型:
├─ Open: 建立邻居关系
├─ Update: 路由更新
├─ Keepalive: 保活 (60秒)
├─ Notification: 错误通知
└─ Route-refresh: 路由刷新

BGP 路径选择:
1. Weight (Cisco私有,最高优先)
2. Local Preference (本地优先级)
3. 本地起源
4. AS Path (最短)
5. Origin (IGP > EGP > Incomplete)
6. MED (Multi-Exit Discriminator)
7. eBGP > iBGP
8. IGP 度量值
9. Router ID

配置示例:
router bgp 65001                 # AS 号
 bgp router-id 1.1.1.1
 neighbor 2.2.2.2 remote-as 65002  # eBGP 邻居
 neighbor 3.3.3.3 remote-as 65001  # iBGP 邻居
 neighbor 3.3.3.3 update-source Loopback0
 network 192.168.1.0 mask 255.255.255.0  # 宣告网络

AS Path 属性:
├─ 路由经过的 AS 序列
├─ 防止路由环路
└─ 影响路径选择

示例: AS Path = 65001 65002 65003
表示: 从 AS 65003 → 65002 → 65001
```

这是网络层协议教程,涵盖了IP、ICMP、IGMP和主要路由协议。
