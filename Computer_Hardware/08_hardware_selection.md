# 硬件选型与性能评估

## 课程概述

本教程全面讲解硬件选型策略，从性能基准测试到容量规划，从服务器配置案例到云vs自建TCO对比，帮助你掌握科学的硬件选型方法和成本优化策略。

**学习目标**：
- 掌握硬件选型决策框架
- 理解Benchmark工具的使用方法
- 学会针对不同场景的服务器配置
- 掌握容量规划的科学方法
- 理解云vs自建的TCO对比

---

## 1. 硬件选型决策树

### 1.1 选型框架

```
┌─────────────────────────────────────────────────────────────┐
│              硬件选型决策流程                                 │
└─────────────────────────────────────────────────────────────┘

┌──────────────────────────────────────────────────────────┐
│  第1步：明确工作负载特征                                  │
│  ┌────────────────────────────────────────────────────┐  │
│  │  计算密集型                                         │  │
│  │  - CPU核心数量优先                                  │  │
│  │  - 高主频（单线程性能）                             │  │
│  │  - 示例：科学计算、编译、加密                        │  │
│  ├────────────────────────────────────────────────────┤  │
│  │  内存密集型                                         │  │
│  │  - 大容量内存（128GB+）                             │  │
│  │  - 高带宽内存                                       │  │
│  │  - 示例：数据库、缓存、内存分析                      │  │
│  ├────────────────────────────────────────────────────┤  │
│  │  I/O密集型                                          │  │
│  │  - 高速存储（NVMe）                                 │  │
│  │  - 网络带宽                                         │  │
│  │  - 示例：Web服务器、文件服务器                       │  │
│  ├────────────────────────────────────────────────────┤  │
│  │  GPU加速型                                          │  │
│  │  - 高性能GPU                                        │  │
│  │  - PCIe通道数量                                     │  │
│  │  - 示例：AI训练、渲染、科学计算                      │  │
│  └────────────────────────────────────────────────────┘  │
└──────────────────────────────────────────────────────────┘

┌──────────────────────────────────────────────────────────┐
│  第2步：性能vs成本权衡                                    │
│  ┌────────────────────────────────────────────────────┐  │
│  │  性能曲线（边际收益递减）                           │  │
│  │                                                    │  │
│  │  性能                                              │  │
│  │   ▲                                               │  │
│  │   │           ╭─────────────                      │  │
│  │   │        ╭──╯  边际收益递减                     │  │
│  │   │     ╭──╯                                      │  │
│  │   │  ╭──╯                                         │  │
│  │   │╭─╯                                            │  │
│  │   └──────────────────────────►                    │  │
│  │                              成本                 │  │
│  │                                                    │  │
│  │  甜点区域：                                         │  │
│  │  - CPU：中高端主流型号（非旗舰）                    │  │
│  │  - 内存：DDR4-3200（非超频）                        │  │
│  │  - SSD：主流NVMe（非旗舰PCIe 5.0）                 │  │
│  └────────────────────────────────────────────────────┘  │
└──────────────────────────────────────────────────────────┘

┌──────────────────────────────────────────────────────────┐
│  第3步：扩展性考虑                                        │
│  ┌────────────────────────────────────────────────────┐  │
│  │  垂直扩展（Scale-Up）                               │  │
│  │  ┌──────────────────────────────────────────────┐ │  │
│  │  │  单机性能提升                                 │ │  │
│  │  │  - 更多CPU核心                                │ │  │
│  │  │  - 更大内存                                   │ │  │
│  │  │  - 更快存储                                   │ │  │
│  │  │                                              │ │  │
│  │  │  优势：简单、低延迟                           │ │  │
│  │  │  劣势：有上限、单点故障                        │ │  │
│  │  └──────────────────────────────────────────────┘ │  │
│  │                                                    │  │
│  │  水平扩展（Scale-Out）                              │  │
│  │  ┌──────────────────────────────────────────────┐ │  │
│  │  │  增加节点数量                                 │ │  │
│  │  │  [节点1] [节点2] [节点3] ...                  │ │  │
│  │  │                                              │ │  │
│  │  │  优势：无限扩展、高可用                        │ │  │
│  │  │  劣势：复杂、网络开销                         │ │  │
│  │  └──────────────────────────────────────────────┘ │  │
│  └────────────────────────────────────────────────────┘  │
└──────────────────────────────────────────────────────────┘

┌──────────────────────────────────────────────────────────┐
│  第4步：可靠性要求                                        │
│  ┌────────────────────────────────────────────────────┐  │
│  │  可用性等级                                         │  │
│  │  ┌──────────────┬──────────┬──────────────────┐   │  │
│  │  │ 等级         │ SLA      │ 年故障时间        │   │  │
│  │  ├──────────────┼──────────┼──────────────────┤   │  │
│  │  │ 2个9 (99%)   │          │ 3.65天           │   │  │
│  │  │ 3个9 (99.9%) │          │ 8.76小时         │   │  │
│  │  │ 4个9 (99.99%)│          │ 52.56分钟        │   │  │
│  │  │ 5个9 (99.999%)│         │ 5.26分钟         │   │  │
│  │  └──────────────┴──────────┴──────────────────┘   │  │
│  │                                                    │  │
│  │  冗余配置：                                         │  │
│  │  - 电源冗余（1+1）                                  │  │
│  │  - 网络冗余（双路）                                 │  │
│  │  - 存储RAID                                        │  │
│  │  - ECC内存                                         │  │
│  └────────────────────────────────────────────────────┘  │
└──────────────────────────────────────────────────────────┘
```

### 1.2 关键硬件参数矩阵

```
┌─────────────────────────────────────────────────────────────┐
│              硬件参数优先级矩阵                               │
└─────────────────────────────────────────────────────────────┘

应用场景 vs 硬件参数重要性（★越多越重要）：
┌──────────┬────┬────┬────┬────┬────┬────┐
│ 场景     │CPU │内存 │存储│网络│GPU │电源│
├──────────┼────┼────┼────┼────┼────┼────┤
│ Web服务器│ ★★ │ ★★★│ ★★ │★★★★│ ☆  │ ★★ │
│ 数据库   │★★★★│★★★★│★★★★│ ★★ │ ☆  │★★★★│
│ AI训练   │ ★★ │★★★★│ ★★ │★★★ │★★★★│★★★★│
│ AI推理   │ ★★ │ ★★★│★★★ │★★★ │★★★★│ ★★ │
│ 大数据   │★★★ │★★★★│★★★★│★★★★│ ★  │★★★ │
│ 虚拟化   │★★★★│★★★★│★★★ │ ★★ │ ☆  │★★★ │
│ 文件服务 │ ★★ │ ★★ │★★★★│★★★★│ ☆  │ ★★ │
│ 游戏服务 │★★★★│ ★★★│ ★★ │★★★ │ ☆  │ ★★ │
│ 编译构建 │★★★★│ ★★★│★★★ │ ★  │ ☆  │ ★★ │
└──────────┴────┴────┴────┴────┴────┴────┘

CPU选型参数：
┌──────────────────────────────────────┐
│  核心数 vs 频率                       │
│  ┌────────────────────────────────┐ │
│  │  多线程任务：优先核心数         │ │
│  │  - Web服务器：16-32核           │ │
│  │  - 数据库：8-16核（中核高频）   │ │
│  │  - 虚拟化：32-128核             │ │
│  │                                │ │
│  │  单线程任务：优先频率           │ │
│  │  - 游戏服务器：4.5GHz+          │ │
│  │  - 实时应用：高睿频             │ │
│  └────────────────────────────────┘ │
│                                      │
│  缓存大小：                           │
│  - L3缓存：2-4MB/核                  │
│  - 数据库受益于大缓存                 │
│                                      │
│  指令集：                             │
│  - AVX-512：科学计算、AI             │
│  - SHA扩展：加密应用                 │
└──────────────────────────────────────┘

内存选型参数：
┌──────────────────────────────────────┐
│  容量：                               │
│  - 虚拟化：每VM 4-8GB                 │
│  - 数据库：数据集25-50%                │
│  - 缓存：数据集100%+                  │
│                                      │
│  速度：                               │
│  - DDR4-3200：主流甜点                │
│  - DDR5-4800：新平台                  │
│                                      │
│  通道：                               │
│  - 双通道：桌面/工作站                 │
│  - 四通道：服务器                     │
│  - 八通道：高性能计算                  │
│                                      │
│  ECC：                                │
│  - 企业级必选                         │
│  - 消费级可选                         │
└──────────────────────────────────────┘

存储选型参数：
┌──────────────────────────────────────┐
│  类型：                               │
│  - NVMe SSD：数据库、虚拟化           │
│  - SATA SSD：通用服务器               │
│  - HDD：归档、冷数据                  │
│                                      │
│  IOPS：                               │
│  - 数据库：100K+ IOPS                 │
│  - Web：10K-50K IOPS                  │
│  - 文件：顺序带宽优先                  │
│                                      │
│  耐久性：                             │
│  - TLC：通用（1 DWPD）                │
│  - MLC：写密集（3 DWPD）              │
│  - 企业级：5-10 DWPD                  │
└──────────────────────────────────────┘
```

---

## 2. 服务器配置案例

### 2.1 Web服务器配置

```
┌─────────────────────────────────────────────────────────────┐
│              Web服务器配置案例                                │
└─────────────────────────────────────────────────────────────┘

小型Web服务器（<1万并发）：
┌──────────────────────────────────────┐
│  配置清单                             │
│  ┌────────────────────────────────┐ │
│  │ CPU:  Intel Xeon E-2388G      │ │
│  │       8核16线程 @ 3.2GHz       │ │
│  │       ~$600                    │ │
│  │                                │ │
│  │ 内存: 64GB DDR4-3200 ECC       │ │
│  │       (4×16GB)                 │ │
│  │       ~$250                    │ │
│  │                                │ │
│  │ 存储: 1TB NVMe SSD (系统+缓存) │ │
│  │       2TB SATA SSD (数据)      │ │
│  │       ~$200                    │ │
│  │                                │ │
│  │ 网卡: 双口10GbE                │ │
│  │       ~$150                    │ │
│  │                                │ │
│  │ 电源: 550W 80+ Gold            │ │
│  │       ~$100                    │ │
│  │                                │ │
│  │ 总计: ~$1,300                  │ │
│  └────────────────────────────────┘ │
│                                      │
│  性能指标：                           │
│  - 并发连接：10,000                  │
│  - QPS：20,000                       │
│  - 响应时间：<10ms                   │
│  - 网络吞吐：10Gbps                  │
└──────────────────────────────────────┘

大型Web服务器（10万+并发）：
┌──────────────────────────────────────┐
│  配置清单                             │
│  ┌────────────────────────────────┐ │
│  │ CPU:  AMD EPYC 7543            │ │
│  │       32核64线程 @ 2.8GHz      │ │
│  │       ~$3,500                  │ │
│  │                                │ │
│  │ 内存: 256GB DDR4-3200 ECC      │ │
│  │       (8×32GB)                 │ │
│  │       ~$1,200                  │ │
│  │                                │ │
│  │ 存储: 2×2TB NVMe SSD (RAID1)   │ │
│  │       ~$600                    │ │
│  │                                │ │
│  │ 网卡: 双口100GbE (SmartNIC)    │ │
│  │       ~$2,000                  │ │
│  │                                │ │
│  │ 电源: 1200W 80+ Platinum 冗余  │ │
│  │       ~$400                    │ │
│  │                                │ │
│  │ 总计: ~$7,700                  │ │
│  └────────────────────────────────┘ │
│                                      │
│  性能指标：                           │
│  - 并发连接：100,000+                │
│  - QPS：200,000+                     │
│  - 响应时间：<5ms                    │
│  - 网络吞吐：100Gbps                 │
│                                      │
│  优化配置：                           │
│  - RSS多队列绑定CPU                  │
│  - DPDK用户态网络栈                  │
│  - Nginx worker绑核                  │
└──────────────────────────────────────┘
```

### 2.2 数据库服务器配置

```
┌─────────────────────────────────────────────────────────────┐
│              数据库服务器配置案例                             │
└─────────────────────────────────────────────────────────────┘

OLTP数据库（MySQL/PostgreSQL）：
┌──────────────────────────────────────┐
│  配置清单                             │
│  ┌────────────────────────────────┐ │
│  │ CPU:  Intel Xeon Gold 6338     │ │
│  │       32核64线程 @ 2.0GHz      │ │
│  │       ~$2,500                  │ │
│  │       (L3缓存：48MB)           │ │
│  │                                │ │
│  │ 内存: 512GB DDR4-3200 ECC      │ │
│  │       (16×32GB)                │ │
│  │       ~$2,500                  │ │
│  │       (四通道优化)             │ │
│  │                                │ │
│  │ 存储: 4×2TB NVMe SSD (RAID10)  │ │
│  │       ~$1,200                  │ │
│  │       (数据文件)               │ │
│  │                                │ │
│  │       2×500GB NVMe (RAID1)     │ │
│  │       ~$200                    │ │
│  │       (日志文件)               │ │
│  │                                │ │
│  │ 网卡: 双口25GbE                │ │
│  │       ~$400                    │ │
│  │                                │ │
│  │ 电源: 1000W 80+ Platinum 冗余  │ │
│  │       ~$350                    │ │
│  │                                │ │
│  │ UPS:  2000VA在线式             │ │
│  │       ~$500                    │ │
│  │                                │ │
│  │ 总计: ~$7,650                  │ │
│  └────────────────────────────────┘ │
│                                      │
│  性能指标：                           │
│  - TPS：50,000                       │
│  - QPS：200,000                      │
│  - 查询延迟：<1ms                    │
│  - 内存命中率：>95%                  │
│                                      │
│  优化配置：                           │
│  - InnoDB buffer pool：384GB        │
│  - 日志文件分离盘                     │
│  - NUMA绑定                          │
│  - huge pages                        │
└──────────────────────────────────────┘

OLAP数据仓库（ClickHouse/Greenplum）：
┌──────────────────────────────────────┐
│  配置清单（单节点）                   │
│  ┌────────────────────────────────┐ │
│  │ CPU:  AMD EPYC 7763            │ │
│  │       64核128线程 @ 2.45GHz    │ │
│  │       ~$7,000                  │ │
│  │       (L3缓存：256MB)          │ │
│  │                                │ │
│  │ 内存: 1TB DDR4-3200 ECC        │ │
│  │       (16×64GB)                │ │
│  │       ~$5,000                  │ │
│  │       (八通道)                 │ │
│  │                                │ │
│  │ 存储: 12×8TB NVMe SSD          │ │
│  │       ~$12,000                 │
│  │       (单盘JBOD，软件RAID)      │ │
│  │                                │ │
│  │ 网卡: 双口100GbE               │ │
│  │       ~$2,000                  │ │
│  │                                │ │
│  │ 电源: 2000W 80+ Platinum 冗余  │ │
│  │       ~$600                    │ │
│  │                                │ │
│  │ 总计: ~$26,600                 │ │
│  └────────────────────────────────┘ │
│                                      │
│  集群规模：                           │
│  - 3-10个节点                        │
│  - 总存储：300TB+                    │
│  - 总内存：3-10TB                    │
│                                      │
│  性能指标：                           │
│  - 查询QPS：100-1000                 │
│  - 扫描速度：10GB/s/节点             │
│  - 并行度：数千线程                   │
└──────────────────────────────────────┘
```

### 2.3 AI训练服务器配置

```
┌─────────────────────────────────────────────────────────────┐
│              AI训练服务器配置（DGX风格）                      │
└─────────────────────────────────────────────────────────────┘

深度学习训练站（单机8卡）：
┌──────────────────────────────────────┐
│  配置清单                             │
│  ┌────────────────────────────────┐ │
│  │ CPU:  AMD Threadripper PRO     │ │
│  │       64核128线程 @ 2.7GHz     │ │
│  │       ~$4,500                  │ │
│  │       (PCIe 4.0 128通道)       │ │
│  │                                │ │
│  │ 内存: 512GB DDR4-3200 ECC      │ │
│  │       (8×64GB)                 │ │
│  │       ~$2,500                  │ │
│  │                                │ │
│  │ GPU:  8× NVIDIA A100 80GB      │ │
│  │       ~$80,000                 │ │
│  │       (NVLink互联)             │ │
│  │                                │ │
│  │ 存储: 2×4TB NVMe SSD (RAID0)   │ │
│  │       ~$1,000                  │ │
│  │       (数据集缓存)             │ │
│  │                                │ │
│  │ 网络: 双口200GbE (RDMA)        │ │
│  │       ~$4,000                  │ │
│  │       (分布式训练)             │ │
│  │                                │ │
│  │ 电源: 3×2000W 80+ Titanium     │ │
│  │       ~$1,800                  │ │
│  │       (冗余+负载均衡)          │ │
│  │                                │ │
│  │ 散热: 定制液冷系统              │ │
│  │       ~$3,000                  │ │
│  │                                │ │
│  │ 总计: ~$96,800                 │ │
│  └────────────────────────────────┘ │
│                                      │
│  功耗：                               │
│  - 峰值：5000W                       │
│  - 平均：4000W                       │
│  - 年耗电：35,040 kWh                │
│  - 电费：$3,504/年 (@$0.10/kWh)     │
│                                      │
│  性能指标：                           │
│  - FP16算力：5 PetaFLOPS            │
│  - GPU内存：640GB                    │
│  - GPU-GPU带宽：600GB/s (NVLink)    │
│  - 训练吞吐：~1000 images/s (ResNet)│
│                                      │
│  软件栈：                             │
│  - Ubuntu 22.04 LTS                 │
│  - CUDA 12.x                        │
│  - PyTorch / TensorFlow             │
│  - Horovod (分布式)                 │
└──────────────────────────────────────┘

AI推理服务器（边缘部署）：
┌──────────────────────────────────────┐
│  配置清单                             │
│  ┌────────────────────────────────┐ │
│  │ CPU:  Intel Xeon D-2776NT      │ │
│  │       16核32线程 @ 2.1GHz      │ │
│  │       ~$2,000                  │ │
│  │       (低功耗设计)             │ │
│  │                                │ │
│  │ 内存: 128GB DDR4-3200 ECC      │ │
│  │       ~$600                    │ │
│  │                                │ │
│  │ GPU:  4× NVIDIA T4             │ │
│  │       ~$4,000                  │ │
│  │       (推理优化)               │ │
│  │                                │ │
│  │ 存储: 1TB NVMe SSD             │ │
│  │       ~$120                    │ │
│  │                                │ │
│  │ 网卡: 双口10GbE                │ │
│  │       ~$150                    │ │
│  │                                │ │
│  │ 电源: 800W 80+ Platinum        │ │
│  │       ~$200                    │ │
│  │                                │ │
│  │ 总计: ~$7,070                  │ │
│  └────────────────────────────────┘ │
│                                      │
│  性能指标：                           │
│  - 推理吞吐：10,000 images/s        │
│  - 延迟：<5ms                        │
│  - INT8算力：1000 TOPS              │
│  - 功耗：400W                        │
│                                      │
│  优化技术：                           │
│  - TensorRT量化                     │
│  - 动态批处理                        │
│  - 模型融合                          │
└──────────────────────────────────────┘
```

---

## 3. Benchmark工具

### 3.1 综合性能测试

```bash
#!/bin/bash
# 综合性能基准测试脚本

echo "========== 系统信息 =========="
echo "CPU: $(lscpu | grep 'Model name' | cut -d ':' -f 2 | xargs)"
echo "内存: $(free -h | grep Mem | awk '{print $2}')"
echo "存储: $(lsblk -o NAME,SIZE,TYPE | grep disk)"
echo "GPU: $(nvidia-smi --query-gpu=name --format=csv,noheader 2>/dev/null || echo 'N/A')"

echo -e "\n========== CPU性能测试（Sysbench）=========="
# 单线程
echo "单线程整数运算："
sysbench cpu --cpu-max-prime=20000 --threads=1 run | grep "events per second"

# 多线程
CORES=$(nproc)
echo "多线程整数运算（$CORES线程）："
sysbench cpu --cpu-max-prime=20000 --threads=$CORES run | grep "events per second"

echo -e "\n========== 内存性能测试 =========="
# 内存带宽
sysbench memory --memory-block-size=1M --memory-total-size=10G run | \
    grep -E "transferred|total time"

echo -e "\n========== 存储性能测试（fio）=========="
# 随机4K读写
fio --name=rand-rw --ioengine=libaio --iodepth=32 --rw=randrw \
    --rwmixread=70 --bs=4k --direct=1 --size=1G --numjobs=4 \
    --runtime=30 --group_reporting | grep -E "IOPS|BW"

# 顺序读写
fio --name=seq-rw --ioengine=libaio --iodepth=32 --rw=rw \
    --rwmixread=50 --bs=1M --direct=1 --size=5G --numjobs=1 \
    --runtime=30 --group_reporting | grep -E "IOPS|BW"

echo -e "\n========== 网络性能测试（iperf3）=========="
# 需要远程服务器运行：iperf3 -s
SERVER_IP="192.168.1.100"
if ping -c 1 $SERVER_IP &>/dev/null; then
    echo "TCP带宽测试："
    iperf3 -c $SERVER_IP -t 10 -P 4 | grep sender
else
    echo "网络服务器不可达，跳过测试"
fi

echo -e "\n========== SPEC CPU2017（可选）=========="
# 需要购买并安装SPEC CPU2017
# runcpu --config=myconfig.cfg --threads=$CORES intrate fprate

echo -e "\n========== Geekbench 6（可选）=========="
# 下载并运行Geekbench
# ./geekbench6 --compute OpenCL
```

### 3.2 Python性能评估脚本

```python
#!/usr/bin/env python3
"""
硬件性能综合评估工具
"""

import subprocess
import time
import numpy as np
import multiprocessing as mp

def get_system_info():
    """获取系统信息"""
    print("=" * 60)
    print("系统硬件信息")
    print("=" * 60)

    # CPU信息
    try:
        with open('/proc/cpuinfo') as f:
            for line in f:
                if 'model name' in line:
                    print(f"CPU: {line.split(':')[1].strip()}")
                    break
    except:
        pass

    # 内存信息
    try:
        with open('/proc/meminfo') as f:
            for line in f:
                if 'MemTotal' in line:
                    mem_kb = int(line.split()[1])
                    print(f"内存: {mem_kb / 1024 / 1024:.1f} GB")
                    break
    except:
        pass

    # GPU信息
    try:
        result = subprocess.run(
            ['nvidia-smi', '--query-gpu=name', '--format=csv,noheader'],
            capture_output=True,
            text=True
        )
        if result.returncode == 0:
            print(f"GPU: {result.stdout.strip()}")
    except:
        pass

    print()

def benchmark_cpu_integer():
    """CPU整数运算性能"""
    print("=== CPU整数性能测试 ===")

    def worker():
        total = 0
        for i in range(10_000_000):
            total += i % 100
        return total

    # 单线程
    start = time.perf_counter()
    worker()
    single_time = time.perf_counter() - start

    # 多线程
    num_cores = mp.cpu_count()
    with mp.Pool(num_cores) as pool:
        start = time.perf_counter()
        pool.map(worker, range(num_cores))
        multi_time = time.perf_counter() - start

    print(f"单线程用时: {single_time:.3f} 秒")
    print(f"多线程用时 ({num_cores}核): {multi_time:.3f} 秒")
    print(f"并行效率: {single_time / multi_time / num_cores * 100:.1f}%")
    print()

def benchmark_cpu_float():
    """CPU浮点性能"""
    print("=== CPU浮点性能测试 ===")

    size = 8192
    iterations = 100

    A = np.random.rand(size, size).astype(np.float64)
    B = np.random.rand(size, size).astype(np.float64)

    # 预热
    C = np.dot(A, B)

    # 测试
    start = time.perf_counter()
    for _ in range(iterations):
        C = np.dot(A, B)
    elapsed = time.perf_counter() - start

    # 计算GFLOPS
    ops = 2 * size**3 * iterations  # 矩阵乘法运算量
    gflops = ops / elapsed / 1e9

    print(f"矩阵大小: {size}×{size}")
    print(f"迭代次数: {iterations}")
    print(f"总用时: {elapsed:.2f} 秒")
    print(f"浮点性能: {gflops:.1f} GFLOPS")
    print()

def benchmark_memory():
    """内存带宽测试"""
    print("=== 内存带宽测试 ===")

    size = 500 * 1024 * 1024  # 500M元素 = 4GB
    data = np.random.rand(size).astype(np.float64)

    # 顺序读取
    start = time.perf_counter()
    total = np.sum(data)
    elapsed = time.perf_counter() - start

    bandwidth = (size * 8) / elapsed / 1e9
    print(f"顺序读取带宽: {bandwidth:.2f} GB/s")

    # 顺序写入
    start = time.perf_counter()
    data[:] = 1.0
    elapsed = time.perf_counter() - start

    bandwidth = (size * 8) / elapsed / 1e9
    print(f"顺序写入带宽: {bandwidth:.2f} GB/s")

    # 拷贝
    dest = np.empty_like(data)
    start = time.perf_counter()
    np.copyto(dest, data)
    elapsed = time.perf_counter() - start

    bandwidth = (size * 8 * 2) / elapsed / 1e9
    print(f"内存拷贝带宽: {bandwidth:.2f} GB/s")
    print()

def benchmark_gpu():
    """GPU性能测试"""
    print("=== GPU性能测试 ===")

    try:
        import cupy as cp

        size = 16384
        A = cp.random.rand(size, size, dtype=cp.float32)
        B = cp.random.rand(size, size, dtype=cp.float32)

        # 预热
        C = cp.matmul(A, B)
        cp.cuda.Stream.null.synchronize()

        # 测试
        start = time.perf_counter()
        C = cp.matmul(A, B)
        cp.cuda.Stream.null.synchronize()
        elapsed = time.perf_counter() - start

        ops = 2 * size**3
        tflops = ops / elapsed / 1e12

        print(f"矩阵大小: {size}×{size}")
        print(f"FP32性能: {tflops:.2f} TFLOPS")
        print()

    except ImportError:
        print("未安装CuPy，跳过GPU测试")
        print()

def generate_score():
    """生成综合得分"""
    print("=== 综合性能评分 ===")

    # 这里可以根据各项测试结果计算综合分数
    # 暂时省略具体实现

    print("性能评估完成")
    print("=" * 60)

def main():
    """主函数"""
    get_system_info()
    benchmark_cpu_integer()
    benchmark_cpu_float()
    benchmark_memory()
    benchmark_gpu()
    generate_score()

if __name__ == "__main__":
    main()
```

---

## 4. 容量规划

### 4.1 容量规划方法

```
┌─────────────────────────────────────────────────────────────┐
│              容量规划流程                                     │
└─────────────────────────────────────────────────────────────┘

步骤1：收集基线数据
┌──────────────────────────────────────┐
│  监控指标（至少30天）:                │
│  ┌────────────────────────────────┐ │
│  │ CPU使用率                       │ │
│  │  - 平均值：40%                  │ │
│  │  - P95：70%                     │ │
│  │  - P99：85%                     │ │
│  │                                │ │
│  │ 内存使用率                      │ │
│  │  - 平均值：60%                  │ │
│  │  - P95：75%                     │ │
│  │  - P99：82%                     │ │
│  │                                │ │
│  │ 磁盘IOPS                        │ │
│  │  - 平均值：5K                   │ │
│  │  - 峰值：15K                    │ │
│  │                                │ │
│  │ 网络带宽                        │ │
│  │  - 平均值：1Gbps                │ │
│  │  - 峰值：5Gbps                  │ │
│  └────────────────────────────────┘ │
└──────────────────────────────────────┘

步骤2：预测增长趋势
┌──────────────────────────────────────┐
│  增长模型：                           │
│                                      │
│  线性增长：                           │
│    y = a + b×t                       │
│    示例：每月用户增长10%              │
│                                      │
│  指数增长：                           │
│    y = a × e^(b×t)                   │
│    示例：病毒式传播                   │
│                                      │
│  季节性波动：                         │
│    考虑周期性高峰（双11、黑五）       │
│                                      │
│  实际案例：                           │
│  ┌────────────────────────────────┐ │
│  │ 当前QPS：10,000                │ │
│  │ 月增长率：15%                   │ │
│  │ 6个月后预测：                   │ │
│  │   QPS = 10000 × 1.15^6 = 23K   │ │
│  │                                │ │
│  │ 峰值倍数：3倍                   │ │
│  │ 设计容量：23K × 3 = 69K QPS    │ │
│  └────────────────────────────────┘ │
└──────────────────────────────────────┘

步骤3：计算资源需求
┌──────────────────────────────────────┐
│  CPU需求计算：                        │
│  ┌────────────────────────────────┐ │
│  │ 当前：8核 @ 70% = 5.6核          │ │
│  │ 增长：2.3倍                     │ │
│  │ 需求：5.6 × 2.3 = 12.9核        │ │
│  │ 冗余：1.3倍                     │ │
│  │ 配置：12.9 × 1.3 = 16.8核      │ │
│  │ 选择：2×16核CPU（双路）         │ │
│  └────────────────────────────────┘ │
│                                      │
│  内存需求计算：                       │
│  ┌────────────────────────────────┐ │
│  │ 当前：64GB @ 75% = 48GB         │ │
│  │ 增长：2.3倍 = 110GB             │ │
│  │ 冗余：1.3倍 = 143GB             │ │
│  │ 选择：192GB（8×24GB）           │ │
│  └────────────────────────────────┘ │
│                                      │
│  存储需求计算：                       │
│  ┌────────────────────────────────┐ │
│  │ 当前数据：2TB                   │ │
│  │ 月增长：200GB                   │ │
│  │ 6个月：2TB + 1.2TB = 3.2TB     │ │
│  │ 冗余（RAID10）：2倍              │ │
│  │ 配置：4×2TB SSD                │ │
│  └────────────────────────────────┘ │
└──────────────────────────────────────┘

步骤4：成本优化
┌──────────────────────────────────────┐
│  优化策略：                           │
│  ┌────────────────────────────────┐ │
│  │ 1. 分层存储                     │ │
│  │    - 热数据：NVMe SSD          │ │
│  │    - 温数据：SATA SSD          │ │
│  │    - 冷数据：HDD/对象存储      │ │
│  │                                │ │
│  │ 2. 弹性扩展                     │ │
│  │    - 基础容量：满足P90需求      │ │
│  │    - 云burst：应对峰值         │ │
│  │                                │ │
│  │ 3. 资源复用                     │ │
│  │    - 虚拟化：提高利用率         │ │
│  │    - 容器化：快速部署           │ │
│  │                                │ │
│  │ 4. 预留采购                     │ │
│  │    - 保留20%扩展槽位            │ │
│  │    - 逐步增长，避免过度投资     │ │
│  └────────────────────────────────┘ │
└──────────────────────────────────────┘
```

---

## 5. 云vs自建TCO对比

### 5.1 TCO分析模型

```
┌─────────────────────────────────────────────────────────────┐
│              TCO对比（3年总拥有成本）                         │
└─────────────────────────────────────────────────────────────┘

自建服务器TCO（100台服务器）：
┌──────────────────────────────────────┐
│  初期投资（CapEx）:                   │
│  ┌────────────────────────────────┐ │
│  │ 硬件采购：                      │ │
│  │   100×$5,000 = $500,000        │ │
│  │                                │ │
│  │ 网络设备：                      │ │
│  │   交换机/路由器 = $50,000       │ │
│  │                                │ │
│  │ 机柜+PDU：                      │ │
│  │   10机柜 × $5,000 = $50,000    │ │
│  │                                │ │
│  │ UPS系统：                       │ │
│  │   双路UPS = $100,000           │ │
│  │                                │ │
│  │ 制冷设备：                      │ │
│  │   精密空调 = $80,000           │ │
│  │                                │ │
│  │ 小计：$780,000                 │ │
│  └────────────────────────────────┘ │
│                                      │
│  运营成本（OpEx，每年）:              │
│  ┌────────────────────────────────┐ │
│  │ 电费：                          │ │
│  │   100台 × 300W × 24h × 365天   │ │
│  │   × $0.10/kWh = $26,280/年     │ │
│  │                                │ │
│  │ 制冷电费：                      │ │
│  │   PUE 1.5 → 额外50%             │ │
│  │   $26,280 × 0.5 = $13,140/年   │ │
│  │                                │ │
│  │ 网络带宽：                      │ │
│  │   10Gbps专线 = $12,000/年      │ │
│  │                                │ │
│  │ 人力成本：                      │ │
│  │   2名工程师 × $80,000 = $160K  │ │
│  │                                │ │
│  │ 维保费用：                      │ │
│  │   硬件保修 = $50,000/年         │ │
│  │                                │ │
│  │ 年度小计：$261,420             │ │
│  │ 3年OpEx：$784,260              │ │
│  └────────────────────────────────┘ │
│                                      │
│  折旧：                               │
│  3年折旧（直线法）= $780,000 × 67% = $522,600│
│                                      │
│  3年总TCO：                           │
│  CapEx：$780,000                     │
│  OpEx：$784,260                      │
│  总计：$1,564,260                    │
│  单台成本：$15,643/台                 │
└──────────────────────────────────────┘

云服务TCO（等效100台虚拟机）：
┌──────────────────────────────────────┐
│  实例规格（AWS c5.4xlarge等效）:      │
│  - 16 vCPU                           │
│  - 32GB RAM                          │
│  - $0.68/小时（按需价格）             │
│                                      │
│  费用计算：                           │
│  ┌────────────────────────────────┐ │
│  │ 按需价格：                      │ │
│  │   100实例 × $0.68 × 24h × 365天│ │
│  │   × 3年 = $1,784,160           │ │
│  │                                │ │
│  │ 1年预留实例（-40%）:            │ │
│  │   $1,784,160 × 0.6 = $1,070K   │ │
│  │                                │ │
│  │ 3年预留实例（-60%）:            │ │
│  │   $1,784,160 × 0.4 = $713,664  │ │
│  │                                │ │
│  │ Savings Plan优化（-65%）:       │ │
│  │   $1,784,160 × 0.35 = $624,456 │ │
│  └────────────────────────────────┘ │
│                                      │
│  存储成本（100TB EBS）:               │
│  100TB × $0.10/GB/月 × 36月 = $360K │
│                                      │
│  网络成本（出站10TB/月）:             │
│  10TB × $0.09/GB × 36月 = $32,400   │
│                                      │
│  3年总TCO（Savings Plan）:           │
│  计算：$624,456                      │
│  存储：$360,000                      │
│  网络：$32,400                       │
│  总计：$1,016,856                    │
│  单实例成本：$10,169                 │
└──────────────────────────────────────┘

对比总结（3年）：
┌──────────────┬────────────┬────────────┐
│  项目        │  自建      │  云服务    │
├──────────────┼────────────┼────────────┤
│ 初期投资     │ $780,000   │ $0         │
│ 3年运营成本  │ $784,260   │ $1,016,856 │
│ 总TCO        │ $1,564,260 │ $1,016,856 │
│ 单位成本     │ $15,643    │ $10,169    │
├──────────────┼────────────┼────────────┤
│ 优势         │ 数据安全   │ 灵活弹性   │
│              │ 长期便宜   │ 无初期投资 │
├──────────────┼────────────┼────────────┤
│ 劣势         │ 初期投资大 │ 长期更贵   │
│              │ 运维复杂   │ 厂商锁定   │
└──────────────┴────────────┴────────────┘

决策建议：
┌──────────────────────────────────────┐
│  选择自建：                           │
│  - 规模大（500+服务器）               │
│  - 负载稳定可预测                     │
│  - 数据安全要求极高                   │
│  - 有专业运维团队                     │
│  - 使用周期长（5年+）                 │
│                                      │
│  选择云服务：                         │
│  - 初创公司                           │
│  - 负载波动大                         │
│  - 快速迭代需求                       │
│  - 全球分布式部署                     │
│  - 短期项目（<2年）                   │
│                                      │
│  混合云：                             │
│  - 核心业务自建                       │
│  - 突发流量云burst                    │
│  - 开发测试环境上云                   │
│  - 灾备部署在云                       │
└──────────────────────────────────────┘
```

---

## 6. 学习资源与总结

### 6.1 关键要点总结

```
┌─────────────────────────────────────────────────────────────┐
│                  硬件选型核心概念                             │
└─────────────────────────────────────────────────────────────┘

1. 选型框架
   ├─ 工作负载分析：计算/内存/I/O/GPU
   ├─ 性能vs成本：甜点区域
   ├─ 扩展性：垂直vs水平
   └─ 可靠性：SLA等级

2. 配置案例
   ├─ Web：多核CPU+大内存+网络
   ├─ 数据库：大缓存+高速存储+ECC
   ├─ AI训练：多GPU+NVLink+RDMA
   └─ AI推理：T4+INT8+低延迟

3. Benchmark
   ├─ SPEC CPU2017：CPU标准测试
   ├─ Sysbench：综合性能
   ├─ fio：存储IOPS
   └─ Geekbench：跨平台对比

4. 容量规划
   ├─ 基线数据：30天监控
   ├─ 增长预测：线性/指数模型
   ├─ 资源计算：峰值×冗余
   └─ 成本优化：分层+弹性

5. TCO分析
   ├─ 自建：初期高，长期低
   ├─ 云服务：按需付费，灵活
   ├─ 混合云：核心自建+弹性云
   └─ 决策因素：规模+稳定性+周期

6. 优化策略
   ├─ 超配比：虚拟化1:4-1:8
   ├─ 预留扩展：20%增长空间
   ├─ 分批采购：降低过度投资
   └─ 生命周期：3-5年更换
└─────────────────────────────────────────────────────────────┘
```

### 6.2 推荐资源

**硬件评测网站**：
- AnandTech：深度硬件评测
- Tom's Hardware：CPU/GPU对比
- ServeTheHome：服务器硬件
- STH：存储性能数据库

**Benchmark工具**：
- SPEC：工业标准测试套件
- Geekbench：跨平台性能测试
- Phoronix Test Suite：开源测试套件
- Passmark：综合硬件排名

**云服务商定价计算器**：
- AWS Calculator
- Azure Pricing Calculator
- GCP Pricing Calculator

---

**课程总结**：通过本Computer_Hardware模块的8个教程，你已经系统学习了从CPU架构到GPU计算，从存储设备到网络硬件，从电源管理到硬件选型的完整知识体系。这些知识将帮助你在实际工作中做出科学的硬件选型决策，优化系统性能和成本。

**文件大小**：约30KB
**最后更新**：2024年
