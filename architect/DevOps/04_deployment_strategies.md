# éƒ¨ç½²ç­–ç•¥

## ç›®å½•
- [éƒ¨ç½²ç­–ç•¥æ¦‚è§ˆ](#éƒ¨ç½²ç­–ç•¥æ¦‚è§ˆ)
- [è“ç»¿éƒ¨ç½²](#è“ç»¿éƒ¨ç½²)
- [é‡‘ä¸é›€å‘å¸ƒ](#é‡‘ä¸é›€å‘å¸ƒ)
- [æ»šåŠ¨æ›´æ–°](#æ»šåŠ¨æ›´æ–°)
- [A/Bæµ‹è¯•](#abæµ‹è¯•)
- [ç‰¹æ€§å¼€å…³](#ç‰¹æ€§å¼€å…³)
- [å®æˆ˜æ¡ˆä¾‹](#å®æˆ˜æ¡ˆä¾‹)

---

## éƒ¨ç½²ç­–ç•¥æ¦‚è§ˆ

### éƒ¨ç½²ç­–ç•¥å¯¹æ¯”

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    éƒ¨ç½²ç­–ç•¥å¯¹æ¯”çŸ©é˜µ                          â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ ç­–ç•¥       â”‚ å›æ»šé€Ÿåº¦ â”‚ èµ„æºæˆæœ¬ â”‚ é£é™©     â”‚  å¤æ‚åº¦       â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ è“ç»¿éƒ¨ç½²   â”‚ âš¡ï¸ ç§’çº§  â”‚ ğŸ’°ğŸ’°    â”‚ â­       â”‚  â­â­        â”‚
â”‚ é‡‘ä¸é›€     â”‚ âš¡ï¸ åˆ†é’Ÿ  â”‚ ğŸ’°       â”‚ â­â­     â”‚  â­â­â­      â”‚
â”‚ æ»šåŠ¨æ›´æ–°   â”‚ ğŸ¢ åˆ†é’Ÿ  â”‚ ğŸ’°       â”‚ â­â­â­   â”‚  â­          â”‚
â”‚ A/Bæµ‹è¯•    â”‚ âš¡ï¸ ç§’çº§  â”‚ ğŸ’°ğŸ’°    â”‚ â­       â”‚  â­â­â­â­    â”‚
â”‚ é‡å»º       â”‚ ğŸ¢ é•¿    â”‚ ğŸ’°       â”‚ â­â­â­â­ â”‚  â­          â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

å›¾ä¾‹:
âš¡ï¸ = å¿«é€Ÿ   ğŸ¢ = æ…¢é€Ÿ
ğŸ’° = ä½æˆæœ¬  ğŸ’°ğŸ’° = é«˜æˆæœ¬
â­ = ä½é£é™©  â­â­â­â­ = é«˜é£é™©
```

### éƒ¨ç½²æµç¨‹å¯è§†åŒ–

```
1. è“ç»¿éƒ¨ç½² (Blue-Green)
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  æ­¥éª¤1: è“è‰²(å½“å‰ç‰ˆæœ¬) + ç»¿è‰²(æ–°ç‰ˆæœ¬)   â”‚
â”‚  [è“ v1.0] â—€â”€â”€ 100% æµé‡               â”‚
â”‚  [ç»¿ v1.1] â—€â”€â”€ 0% æµé‡                 â”‚
â”‚                                         â”‚
â”‚  æ­¥éª¤2: åˆ‡æ¢æµé‡åˆ°ç»¿è‰²                  â”‚
â”‚  [è“ v1.0] â—€â”€â”€ 0% æµé‡                 â”‚
â”‚  [ç»¿ v1.1] â—€â”€â”€ 100% æµé‡               â”‚
â”‚                                         â”‚
â”‚  æ­¥éª¤3: ç§»é™¤è“è‰²ç¯å¢ƒ                    â”‚
â”‚  [ç»¿ v1.1] â—€â”€â”€ 100% æµé‡               â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

2. é‡‘ä¸é›€å‘å¸ƒ (Canary)
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  [v1.0] â—€â”€â”€ 90% æµé‡                    â”‚
â”‚  [v1.1] â—€â”€â”€ 10% æµé‡ (é‡‘ä¸é›€)          â”‚
â”‚            â†“ è§‚å¯ŸæŒ‡æ ‡                    â”‚
â”‚  [v1.0] â—€â”€â”€ 70% æµé‡                    â”‚
â”‚  [v1.1] â—€â”€â”€ 30% æµé‡                    â”‚
â”‚            â†“ ç»§ç»­è§‚å¯Ÿ                    â”‚
â”‚  [v1.0] â—€â”€â”€ 0% æµé‡                     â”‚
â”‚  [v1.1] â—€â”€â”€ 100% æµé‡                   â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

3. æ»šåŠ¨æ›´æ–° (Rolling)
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  [v1.0] [v1.0] [v1.0] [v1.0]           â”‚
â”‚    â†“                                    â”‚
â”‚  [v1.1] [v1.0] [v1.0] [v1.0]           â”‚
â”‚    â†“                                    â”‚
â”‚  [v1.1] [v1.1] [v1.0] [v1.0]           â”‚
â”‚    â†“                                    â”‚
â”‚  [v1.1] [v1.1] [v1.1] [v1.0]           â”‚
â”‚    â†“                                    â”‚
â”‚  [v1.1] [v1.1] [v1.1] [v1.1]           â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## è“ç»¿éƒ¨ç½²

### Kubernetes è“ç»¿éƒ¨ç½²

```yaml
# blue-deployment.yaml (å½“å‰ç‰ˆæœ¬)
apiVersion: apps/v1
kind: Deployment
metadata:
  name: myapp-blue
  namespace: production
spec:
  replicas: 3
  selector:
    matchLabels:
      app: myapp
      version: blue
  template:
    metadata:
      labels:
        app: myapp
        version: blue
    spec:
      containers:
      - name: myapp
        image: myapp:v1.0.0
        ports:
        - containerPort: 8080
        resources:
          requests:
            cpu: 100m
            memory: 128Mi
          limits:
            cpu: 500m
            memory: 512Mi

---
# green-deployment.yaml (æ–°ç‰ˆæœ¬)
apiVersion: apps/v1
kind: Deployment
metadata:
  name: myapp-green
  namespace: production
spec:
  replicas: 3
  selector:
    matchLabels:
      app: myapp
      version: green
  template:
    metadata:
      labels:
        app: myapp
        version: green
    spec:
      containers:
      - name: myapp
        image: myapp:v1.1.0
        ports:
        - containerPort: 8080
        resources:
          requests:
            cpu: 100m
            memory: 128Mi
          limits:
            cpu: 500m
            memory: 512Mi

---
# service.yaml
apiVersion: v1
kind: Service
metadata:
  name: myapp
  namespace: production
spec:
  type: LoadBalancer
  selector:
    app: myapp
    version: blue  # åˆ‡æ¢åˆ° green å®ç°è“ç»¿åˆ‡æ¢
  ports:
  - port: 80
    targetPort: 8080
```

### è“ç»¿éƒ¨ç½²è„šæœ¬

```bash
#!/bin/bash
# blue-green-deploy.sh

set -euo pipefail

NAMESPACE="production"
APP_NAME="myapp"
NEW_VERSION="v1.1.0"
CURRENT_COLOR=$(kubectl get svc ${APP_NAME} -n ${NAMESPACE} -o jsonpath='{.spec.selector.version}')
NEW_COLOR=$([ "$CURRENT_COLOR" = "blue" ] && echo "green" || echo "blue")

echo "ğŸš€ Starting Blue-Green Deployment"
echo "Current version: ${CURRENT_COLOR}"
echo "New version: ${NEW_COLOR}"

# 1. éƒ¨ç½²æ–°ç‰ˆæœ¬
echo "ğŸ“¦ Deploying ${NEW_COLOR} version..."
kubectl apply -f ${NEW_COLOR}-deployment.yaml

# 2. ç­‰å¾…æ–°ç‰ˆæœ¬å°±ç»ª
echo "â³ Waiting for ${NEW_COLOR} deployment to be ready..."
kubectl rollout status deployment/${APP_NAME}-${NEW_COLOR} -n ${NAMESPACE} --timeout=300s

# 3. å¥åº·æ£€æŸ¥
echo "ğŸ¥ Running health checks..."
REPLICAS=$(kubectl get deployment ${APP_NAME}-${NEW_COLOR} -n ${NAMESPACE} -o jsonpath='{.status.readyReplicas}')
if [ "$REPLICAS" -lt 3 ]; then
  echo "âŒ Health check failed: only $REPLICAS replicas ready"
  exit 1
fi

# 4. çƒŸé›¾æµ‹è¯•
echo "ğŸ’¨ Running smoke tests..."
POD_IP=$(kubectl get pod -n ${NAMESPACE} -l version=${NEW_COLOR} -o jsonpath='{.items[0].status.podIP}')
HEALTH_STATUS=$(kubectl run --rm -i --restart=Never curl-test --image=curlimages/curl:latest -- \
  curl -s -o /dev/null -w "%{http_code}" http://${POD_IP}:8080/health)

if [ "$HEALTH_STATUS" != "200" ]; then
  echo "âŒ Smoke test failed: HTTP $HEALTH_STATUS"
  exit 1
fi

# 5. åˆ‡æ¢æµé‡
echo "ğŸ”„ Switching traffic to ${NEW_COLOR}..."
kubectl patch service ${APP_NAME} -n ${NAMESPACE} -p "{\"spec\":{\"selector\":{\"version\":\"${NEW_COLOR}\"}}}"

# 6. ç›‘æ§æ–°ç‰ˆæœ¬
echo "ğŸ“Š Monitoring new version for 5 minutes..."
sleep 300

# 7. éªŒè¯æˆåŠŸ
ERROR_RATE=$(kubectl run --rm -i --restart=Never metrics-check --image=curlimages/curl:latest -- \
  curl -s http://prometheus:9090/api/v1/query --data-urlencode 'query=rate(http_requests_total{status=~"5.."}[5m])' \
  | jq -r '.data.result[0].value[1]' || echo "0")

if (( $(echo "$ERROR_RATE > 0.05" | bc -l) )); then
  echo "âš ï¸ High error rate detected, rolling back..."
  kubectl patch service ${APP_NAME} -n ${NAMESPACE} -p "{\"spec\":{\"selector\":{\"version\":\"${CURRENT_COLOR}\"}}}"
  exit 1
fi

# 8. æ¸…ç†æ—§ç‰ˆæœ¬
echo "ğŸ§¹ Cleaning up ${CURRENT_COLOR} deployment..."
kubectl scale deployment/${APP_NAME}-${CURRENT_COLOR} -n ${NAMESPACE} --replicas=0

echo "âœ… Blue-Green deployment completed successfully!"
```

---

## é‡‘ä¸é›€å‘å¸ƒ

### Argo Rollouts é‡‘ä¸é›€é…ç½®

```yaml
# rollout.yaml
apiVersion: argoproj.io/v1alpha1
kind: Rollout
metadata:
  name: myapp
  namespace: production
spec:
  replicas: 10
  revisionHistoryLimit: 3

  selector:
    matchLabels:
      app: myapp

  template:
    metadata:
      labels:
        app: myapp
    spec:
      containers:
      - name: myapp
        image: myapp:v1.1.0
        ports:
        - containerPort: 8080
        resources:
          requests:
            cpu: 100m
            memory: 128Mi

  strategy:
    canary:
      # é‡‘ä¸é›€æ­¥éª¤
      steps:
      - setWeight: 10        # 10% æµé‡åˆ°é‡‘ä¸é›€
      - pause: {duration: 5m}  # æš‚åœ5åˆ†é’Ÿè§‚å¯Ÿ

      - setWeight: 30        # å¢åŠ åˆ°30%
      - pause: {duration: 10m}

      - setWeight: 50        # å¢åŠ åˆ°50%
      - pause: {duration: 10m}

      - setWeight: 80        # å¢åŠ åˆ°80%
      - pause: {}            # æ‰‹åŠ¨å®¡æ‰¹

      # åˆ†ææ¨¡æ¿
      analysis:
        templates:
        - templateName: success-rate
        - templateName: latency
        startingStep: 2      # ä»ç¬¬2æ­¥å¼€å§‹åˆ†æ
        args:
        - name: service-name
          value: myapp

      # æµé‡è·¯ç”±
      trafficRouting:
        nginx:
          stableIngress: myapp-stable
          annotationPrefix: nginx.ingress.kubernetes.io
          additionalIngressAnnotations:
            canary-by-header: X-Canary
            canary-by-header-value: "true"

        # æˆ–ä½¿ç”¨ Istio
        istio:
          virtualService:
            name: myapp-vsvc
            routes:
            - primary

      # è‡ªåŠ¨æå‡
      autoPromotionEnabled: false
      autoPromotionSeconds: 0

      # åäº²å’Œæ€§
      antiAffinity:
        requiredDuringSchedulingIgnoredDuringExecution: {}

---
# analysis-template.yaml
apiVersion: argoproj.io/v1alpha1
kind: AnalysisTemplate
metadata:
  name: success-rate
spec:
  args:
  - name: service-name

  metrics:
  - name: success-rate
    interval: 1m
    count: 5
    successCondition: result >= 0.95
    failureLimit: 3
    provider:
      prometheus:
        address: http://prometheus:9090
        query: |
          sum(rate(
            http_requests_total{
              service="{{args.service-name}}",
              status!~"5.."
            }[5m]
          ))
          /
          sum(rate(
            http_requests_total{
              service="{{args.service-name}}"
            }[5m]
          ))

---
apiVersion: argoproj.io/v1alpha1
kind: AnalysisTemplate
metadata:
  name: latency
spec:
  args:
  - name: service-name

  metrics:
  - name: p95-latency
    interval: 1m
    count: 5
    successCondition: result <= 500
    failureLimit: 3
    provider:
      prometheus:
        address: http://prometheus:9090
        query: |
          histogram_quantile(0.95,
            sum(rate(
              http_request_duration_seconds_bucket{
                service="{{args.service-name}}"
              }[5m]
            )) by (le)
          ) * 1000
```

### Flagger è‡ªåŠ¨åŒ–é‡‘ä¸é›€

```yaml
# flagger-canary.yaml
apiVersion: flagger.app/v1beta1
kind: Canary
metadata:
  name: myapp
  namespace: production
spec:
  # ç›®æ ‡ Deployment
  targetRef:
    apiVersion: apps/v1
    kind: Deployment
    name: myapp

  # æœåŠ¡é…ç½®
  service:
    port: 80
    targetPort: 8080
    gateways:
    - myapp-gateway
    hosts:
    - myapp.example.com
    trafficPolicy:
      tls:
        mode: DISABLE

  # åˆ†æé…ç½®
  analysis:
    interval: 1m
    threshold: 5
    maxWeight: 50
    stepWeight: 10

    # æŒ‡æ ‡
    metrics:
    - name: request-success-rate
      thresholdRange:
        min: 99
      interval: 1m

    - name: request-duration
      thresholdRange:
        max: 500
      interval: 1m

    # Webhook æµ‹è¯•
    webhooks:
    - name: load-test
      url: http://flagger-loadtester/
      timeout: 5s
      metadata:
        type: cmd
        cmd: "hey -z 1m -q 10 -c 2 http://myapp-canary:80/"

    - name: acceptance-test
      url: http://flagger-loadtester/
      timeout: 10s
      metadata:
        type: bash
        cmd: |
          curl -s http://myapp-canary:80/health | grep -q "healthy"
```

---

## æ»šåŠ¨æ›´æ–°

### Kubernetes Deployment æ»šåŠ¨æ›´æ–°

```yaml
# deployment.yaml
apiVersion: apps/v1
kind: Deployment
metadata:
  name: myapp
  namespace: production
spec:
  replicas: 10

  # æ»šåŠ¨æ›´æ–°ç­–ç•¥
  strategy:
    type: RollingUpdate
    rollingUpdate:
      maxSurge: 2         # æœ€å¤šå¤š2ä¸ªPod
      maxUnavailable: 1   # æœ€å¤šä¸å¯ç”¨1ä¸ªPod

  minReadySeconds: 30     # Podå°±ç»ªåç­‰å¾…30ç§’
  revisionHistoryLimit: 10
  progressDeadlineSeconds: 600

  selector:
    matchLabels:
      app: myapp

  template:
    metadata:
      labels:
        app: myapp
    spec:
      containers:
      - name: myapp
        image: myapp:v1.1.0

        # æ¢é’ˆé…ç½®
        livenessProbe:
          httpGet:
            path: /health
            port: 8080
          initialDelaySeconds: 30
          periodSeconds: 10
          timeoutSeconds: 5
          successThreshold: 1
          failureThreshold: 3

        readinessProbe:
          httpGet:
            path: /ready
            port: 8080
          initialDelaySeconds: 10
          periodSeconds: 5
          timeoutSeconds: 3
          successThreshold: 1
          failureThreshold: 3

        # ä¼˜é›…å…³é—­
        lifecycle:
          preStop:
            exec:
              command: ["/bin/sh", "-c", "sleep 15"]

      # Podåäº²å’Œæ€§
      affinity:
        podAntiAffinity:
          preferredDuringSchedulingIgnoredDuringExecution:
          - weight: 100
            podAffinityTerm:
              labelSelector:
                matchExpressions:
                - key: app
                  operator: In
                  values:
                  - myapp
              topologyKey: kubernetes.io/hostname

      terminationGracePeriodSeconds: 30
```

### æ»šåŠ¨æ›´æ–°è„šæœ¬

```bash
#!/bin/bash
# rolling-update.sh

set -euo pipefail

NAMESPACE="production"
DEPLOYMENT="myapp"
NEW_IMAGE="myapp:v1.1.0"

echo "ğŸš€ Starting Rolling Update"

# 1. æ›´æ–°é•œåƒ
echo "ğŸ“¦ Updating image to ${NEW_IMAGE}..."
kubectl set image deployment/${DEPLOYMENT} \
  myapp=${NEW_IMAGE} \
  -n ${NAMESPACE} \
  --record

# 2. ç›‘æ§æ›´æ–°è¿›åº¦
echo "â³ Monitoring rollout progress..."
kubectl rollout status deployment/${DEPLOYMENT} -n ${NAMESPACE} --timeout=600s

# 3. éªŒè¯æ›´æ–°
READY_REPLICAS=$(kubectl get deployment ${DEPLOYMENT} -n ${NAMESPACE} \
  -o jsonpath='{.status.readyReplicas}')
DESIRED_REPLICAS=$(kubectl get deployment ${DEPLOYMENT} -n ${NAMESPACE} \
  -o jsonpath='{.spec.replicas}')

if [ "$READY_REPLICAS" != "$DESIRED_REPLICAS" ]; then
  echo "âŒ Rollout failed: ${READY_REPLICAS}/${DESIRED_REPLICAS} replicas ready"

  echo "ğŸ”™ Rolling back..."
  kubectl rollout undo deployment/${DEPLOYMENT} -n ${NAMESPACE}
  kubectl rollout status deployment/${DEPLOYMENT} -n ${NAMESPACE}
  exit 1
fi

echo "âœ… Rolling update completed successfully!"

# 4. æŸ¥çœ‹å†å²
kubectl rollout history deployment/${DEPLOYMENT} -n ${NAMESPACE}
```

---

## A/Bæµ‹è¯•

### Istio VirtualService A/Bæµ‹è¯•

```yaml
# virtualservice.yaml
apiVersion: networking.istio.io/v1beta1
kind: VirtualService
metadata:
  name: myapp
  namespace: production
spec:
  hosts:
  - myapp.example.com

  gateways:
  - myapp-gateway

  http:
  # A/Bæµ‹è¯•è§„åˆ™
  - match:
    - headers:
        user-agent:
          regex: ".*Mobile.*"
    route:
    - destination:
        host: myapp
        subset: version-b
      weight: 100

  # åŸºäºCookie
  - match:
    - headers:
        cookie:
          regex: "^(.*;)?experiment=b(;.*)?$"
    route:
    - destination:
        host: myapp
        subset: version-b
      weight: 100

  # åŸºäºç”¨æˆ·ID(Header)
  - match:
    - headers:
        x-user-id:
          regex: "^[0-9]*[02468]$"  # å¶æ•°ç”¨æˆ·ID
    route:
    - destination:
        host: myapp
        subset: version-b
      weight: 100

  # é»˜è®¤è·¯ç”±
  - route:
    - destination:
        host: myapp
        subset: version-a
      weight: 90
    - destination:
        host: myapp
        subset: version-b
      weight: 10

---
# destinationrule.yaml
apiVersion: networking.istio.io/v1beta1
kind: DestinationRule
metadata:
  name: myapp
  namespace: production
spec:
  host: myapp

  trafficPolicy:
    connectionPool:
      tcp:
        maxConnections: 100
      http:
        http1MaxPendingRequests: 50
        http2MaxRequests: 100
        maxRequestsPerConnection: 2

    loadBalancer:
      simple: LEAST_REQUEST

    outlierDetection:
      consecutive5xxErrors: 5
      interval: 30s
      baseEjectionTime: 30s
      maxEjectionPercent: 50

  subsets:
  - name: version-a
    labels:
      version: v1.0.0

  - name: version-b
    labels:
      version: v1.1.0
```

---

## ç‰¹æ€§å¼€å…³

### ç‰¹æ€§å¼€å…³å®ç°

```python
# feature_flags.py
from typing import Dict, Any
import redis
import json

class FeatureFlags:
    def __init__(self, redis_url: str):
        self.redis = redis.from_url(redis_url)
        self.cache = {}

    def is_enabled(self, feature: str, context: Dict[str, Any] = None) -> bool:
        """æ£€æŸ¥ç‰¹æ€§æ˜¯å¦å¯ç”¨"""
        # å°è¯•ä»ç¼“å­˜è·å–
        if feature in self.cache:
            config = self.cache[feature]
        else:
            # ä»Redisè·å–
            config_json = self.redis.get(f"feature:{feature}")
            if not config_json:
                return False

            config = json.loads(config_json)
            self.cache[feature] = config

        # æ£€æŸ¥å…¨å±€å¼€å…³
        if not config.get('enabled', False):
            return False

        # å¦‚æœæ²¡æœ‰ä¸Šä¸‹æ–‡,è¿”å›å…¨å±€çŠ¶æ€
        if not context:
            return config.get('percentage', 100) == 100

        # æ£€æŸ¥ç”¨æˆ·ç™½åå•
        if context.get('user_id') in config.get('whitelist', []):
            return True

        # æ£€æŸ¥ç”¨æˆ·é»‘åå•
        if context.get('user_id') in config.get('blacklist', []):
            return False

        # æ£€æŸ¥ç¯å¢ƒ
        if config.get('environments') and \
           context.get('environment') not in config.get('environments', []):
            return False

        # ç™¾åˆ†æ¯”ç°åº¦
        percentage = config.get('percentage', 100)
        if percentage < 100:
            user_id = context.get('user_id', '')
            hash_value = hash(f"{feature}:{user_id}") % 100
            return hash_value < percentage

        return True

    def get_variant(self, feature: str, context: Dict[str, Any] = None) -> str:
        """è·å–ç‰¹æ€§å˜ä½“"""
        if not self.is_enabled(feature, context):
            return 'control'

        config = self.cache.get(feature, {})
        variants = config.get('variants', {})

        if not variants:
            return 'treatment'

        # åŸºäºç”¨æˆ·IDçš„ä¸€è‡´æ€§å“ˆå¸Œ
        user_id = context.get('user_id', '') if context else ''
        hash_value = hash(f"{feature}:{user_id}") % 100

        cumulative = 0
        for variant, weight in variants.items():
            cumulative += weight
            if hash_value < cumulative:
                return variant

        return 'control'

# ä½¿ç”¨ç¤ºä¾‹
flags = FeatureFlags('redis://localhost:6379')

# åº”ç”¨ä»£ç ä¸­
def process_payment(user_id: str, amount: float):
    context = {
        'user_id': user_id,
        'environment': 'production'
    }

    if flags.is_enabled('new_payment_flow', context):
        # æ–°æ”¯ä»˜æµç¨‹
        return process_payment_v2(user_id, amount)
    else:
        # æ—§æ”¯ä»˜æµç¨‹
        return process_payment_v1(user_id, amount)

def show_ui():
    variant = flags.get_variant('checkout_redesign', {'user_id': user_id})

    if variant == 'variant_a':
        return render_template('checkout_v1.html')
    elif variant == 'variant_b':
        return render_template('checkout_v2.html')
    else:
        return render_template('checkout_default.html')
```

### ç‰¹æ€§å¼€å…³é…ç½®

```json
{
  "new_payment_flow": {
    "enabled": true,
    "percentage": 20,
    "environments": ["production"],
    "whitelist": ["user123", "user456"],
    "blacklist": [],
    "description": "æ–°æ”¯ä»˜æµç¨‹ç°åº¦å‘å¸ƒ"
  },
  "checkout_redesign": {
    "enabled": true,
    "percentage": 50,
    "variants": {
      "variant_a": 25,
      "variant_b": 25,
      "control": 50
    },
    "description": "ç»“ç®—é¡µé¢A/Bæµ‹è¯•"
  }
}
```

---

## å®æˆ˜æ¡ˆä¾‹

### ç»¼åˆéƒ¨ç½²ç­–ç•¥

```yaml
# ç”Ÿäº§ç¯å¢ƒéƒ¨ç½²ç­–ç•¥ç»„åˆ
apiVersion: argoproj.io/v1alpha1
kind: Rollout
metadata:
  name: myapp-production
spec:
  replicas: 20

  strategy:
    canary:
      # ç¬¬ä¸€é˜¶æ®µ: é‡‘ä¸é›€(5%)
      steps:
      - setWeight: 5
      - pause: {duration: 10m}
      - analysis:
          templates:
          - templateName: success-rate
          - templateName: latency

      # ç¬¬äºŒé˜¶æ®µ: æ‰©å¤§åˆ°20%
      - setWeight: 20
      - pause: {duration: 20m}
      - analysis:
          templates:
          - templateName: success-rate
          - templateName: latency

      # ç¬¬ä¸‰é˜¶æ®µ: 50% (æ‰‹åŠ¨å®¡æ‰¹)
      - setWeight: 50
      - pause: {}  # æ‰‹åŠ¨å®¡æ‰¹

      # ç¬¬å››é˜¶æ®µ: å®Œå…¨åˆ‡æ¢
      - setWeight: 100

      # è“ç»¿åˆ‡æ¢
      trafficRouting:
        nginx:
          stableIngress: myapp

      # åäº²å’Œæ€§ç¡®ä¿åˆ†æ•£éƒ¨ç½²
      antiAffinity:
        requiredDuringSchedulingIgnoredDuringExecution:
          labelSelector:
            matchLabels:
              app: myapp
          topologyKey: kubernetes.io/hostname
```

---

## æ€»ç»“

### éƒ¨ç½²ç­–ç•¥é€‰æ‹©æŒ‡å—

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚          éƒ¨ç½²ç­–ç•¥é€‰æ‹©å†³ç­–æ ‘                    â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                â”‚
â”‚  å…³é”®ç³»ç»Ÿ?                                     â”‚
â”‚    â”œâ”€ æ˜¯ â†’ è“ç»¿éƒ¨ç½² (é›¶åœæœº)                  â”‚
â”‚    â””â”€ å¦                                       â”‚
â”‚         â”‚                                      â”‚
â”‚         â””â”€ éœ€è¦æ¸è¿›å¼éªŒè¯?                     â”‚
â”‚              â”œâ”€ æ˜¯ â†’ é‡‘ä¸é›€å‘å¸ƒ               â”‚
â”‚              â””â”€ å¦ â†’ æ»šåŠ¨æ›´æ–°                 â”‚
â”‚                                                â”‚
â”‚  éœ€è¦A/Bæµ‹è¯•?                                  â”‚
â”‚    â””â”€ æ˜¯ â†’ Istio + ç‰¹æ€§å¼€å…³                   â”‚
â”‚                                                â”‚
â”‚  èµ„æºå—é™?                                     â”‚
â”‚    â””â”€ æ˜¯ â†’ æ»šåŠ¨æ›´æ–°                           â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### å…³é”®è¦ç‚¹

1. **è“ç»¿éƒ¨ç½²**: å¿«é€Ÿå›æ»š,é€‚åˆå…³é”®ç³»ç»Ÿ
2. **é‡‘ä¸é›€**: æ¸è¿›å¼éªŒè¯,é™ä½é£é™©
3. **æ»šåŠ¨æ›´æ–°**: èŠ‚çœèµ„æº,é€‚åˆæ—¥å¸¸å‘å¸ƒ
4. **A/Bæµ‹è¯•**: ä¸šåŠ¡éªŒè¯,éœ€è¦æµé‡æ§åˆ¶
5. **ç‰¹æ€§å¼€å…³**: ä»£ç çº§æ§åˆ¶,æœ€çµæ´»

### ä¸‹ä¸€æ­¥å­¦ä¹ 
- [05_release_management.md](05_release_management.md) - ç‰ˆæœ¬ç®¡ç†
