# äº‘è®¾è®¡æ¨¡å¼

## ç›®å½•
- [è®¾è®¡æ¨¡å¼æ¦‚è§ˆ](#è®¾è®¡æ¨¡å¼æ¦‚è§ˆ)
- [å¯é æ€§æ¨¡å¼](#å¯é æ€§æ¨¡å¼)
- [æ€§èƒ½æ¨¡å¼](#æ€§èƒ½æ¨¡å¼)
- [å¯æ‰©å±•æ€§æ¨¡å¼](#å¯æ‰©å±•æ€§æ¨¡å¼)
- [æ•°æ®ç®¡ç†æ¨¡å¼](#æ•°æ®ç®¡ç†æ¨¡å¼)
- [å®‰å…¨æ¨¡å¼](#å®‰å…¨æ¨¡å¼)

---

## è®¾è®¡æ¨¡å¼æ¦‚è§ˆ

### äº‘è®¾è®¡æ¨¡å¼åˆ†ç±»

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚              äº‘è®¾è®¡æ¨¡å¼å…¨æ™¯å›¾                          â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                        â”‚
â”‚  ğŸ›¡ï¸  å¯é æ€§æ¨¡å¼ (Reliability)                         â”‚
â”‚     â”œâ”€ Retry (é‡è¯•)                                   â”‚
â”‚     â”œâ”€ Circuit Breaker (æ–­è·¯å™¨)                       â”‚
â”‚     â”œâ”€ Bulkhead (èˆ±å£éš”ç¦»)                            â”‚
â”‚     â””â”€ Health Endpoint Monitoring (å¥åº·æ£€æŸ¥)          â”‚
â”‚                                                        â”‚
â”‚  âš¡ æ€§èƒ½æ¨¡å¼ (Performance)                            â”‚
â”‚     â”œâ”€ Cache-Aside (æ—è·¯ç¼“å­˜)                         â”‚
â”‚     â”œâ”€ CQRS (è¯»å†™åˆ†ç¦»)                                â”‚
â”‚     â”œâ”€ Static Content Hosting (é™æ€å†…å®¹æ‰˜ç®¡)          â”‚
â”‚     â””â”€ Throttling (é™æµ)                              â”‚
â”‚                                                        â”‚
â”‚  ğŸ“ˆ å¯æ‰©å±•æ€§æ¨¡å¼ (Scalability)                        â”‚
â”‚     â”œâ”€ Queue-Based Load Leveling (é˜Ÿåˆ—å‰Šå³°)          â”‚
â”‚     â”œâ”€ Auto-Scaling (è‡ªåŠ¨æ‰©å±•)                        â”‚
â”‚     â”œâ”€ Competing Consumers (ç«äº‰æ¶ˆè´¹è€…)               â”‚
â”‚     â””â”€ Sharding (åˆ†ç‰‡)                                â”‚
â”‚                                                        â”‚
â”‚  ğŸ’¾ æ•°æ®ç®¡ç†æ¨¡å¼ (Data Management)                    â”‚
â”‚     â”œâ”€ Event Sourcing (äº‹ä»¶æº¯æº)                      â”‚
â”‚     â”œâ”€ Saga (é•¿äº‹åŠ¡)                                  â”‚
â”‚     â”œâ”€ Materialized View (ç‰©åŒ–è§†å›¾)                  â”‚
â”‚     â””â”€ Database per Service (æ¯æœåŠ¡ä¸€ä¸ªæ•°æ®åº“)        â”‚
â”‚                                                        â”‚
â”‚  ğŸ”’ å®‰å…¨æ¨¡å¼ (Security)                               â”‚
â”‚     â”œâ”€ Federated Identity (è”åˆèº«ä»½)                 â”‚
â”‚     â”œâ”€ Gatekeeper (å®ˆé—¨å‘˜)                            â”‚
â”‚     â”œâ”€ Valet Key (ä»£å®¢é’¥åŒ™)                           â”‚
â”‚     â””â”€ Token-Based Authentication (ä»¤ç‰Œè®¤è¯)          â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## å¯é æ€§æ¨¡å¼

### 1. Retry Pattern (é‡è¯•æ¨¡å¼)

**é—®é¢˜**ï¼šç½‘ç»œæŠ–åŠ¨æˆ–ä¸´æ—¶æ•…éšœå¯¼è‡´è¯·æ±‚å¤±è´¥

**è§£å†³æ–¹æ¡ˆ**ï¼šè‡ªåŠ¨é‡è¯•å¤±è´¥çš„æ“ä½œ

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚          é‡è¯•ç­–ç•¥å¯¹æ¯”                  â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                        â”‚
â”‚  1. ç«‹å³é‡è¯• (Immediate Retry)        â”‚
â”‚     è¯·æ±‚ â”€Xâ”€â–¶ ç«‹å³é‡è¯• â”€Xâ”€â–¶ ç«‹å³é‡è¯• â”‚
â”‚     é€‚ç”¨: ç¬æ—¶æ•…éšœ                     â”‚
â”‚                                        â”‚
â”‚  2. å›ºå®šé—´éš” (Fixed Interval)         â”‚
â”‚     è¯·æ±‚ â”€Xâ”€â–¶ ç­‰1ç§’ â”€â–¶ é‡è¯•          â”‚
â”‚     é€‚ç”¨: ä¸€èˆ¬åœºæ™¯                     â”‚
â”‚                                        â”‚
â”‚  3. æŒ‡æ•°é€€é¿ (Exponential Backoff)    â”‚
â”‚     è¯·æ±‚ â”€Xâ”€â–¶ ç­‰1ç§’ â”€Xâ”€â–¶ ç­‰2ç§’       â”‚
â”‚           â”€Xâ”€â–¶ ç­‰4ç§’ â”€Xâ”€â–¶ ç­‰8ç§’      â”‚
â”‚     é€‚ç”¨: é˜²æ­¢æœåŠ¡é›ªå´© â­              â”‚
â”‚                                        â”‚
â”‚  4. éšæœºæŠ–åŠ¨ (Jitter)                 â”‚
â”‚     åœ¨é€€é¿æ—¶é—´åŸºç¡€ä¸Šå¢åŠ éšæœºå€¼         â”‚
â”‚     é¿å…é‡è¯•é£æš´                       â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

**Python å®ç°**ï¼š
```python
# retry_pattern.py
import time
import random
import logging
from functools import wraps
from typing import Type, Tuple

logger = logging.getLogger(__name__)

def retry_with_exponential_backoff(
    max_retries: int = 3,
    base_delay: float = 1.0,
    max_delay: float = 60.0,
    exponential_base: float = 2.0,
    jitter: bool = True,
    exceptions: Tuple[Type[Exception], ...] = (Exception,)
):
    """
    æŒ‡æ•°é€€é¿é‡è¯•è£…é¥°å™¨

    å‚æ•°:
        max_retries: æœ€å¤§é‡è¯•æ¬¡æ•°
        base_delay: åŸºç¡€å»¶è¿Ÿï¼ˆç§’ï¼‰
        max_delay: æœ€å¤§å»¶è¿Ÿï¼ˆç§’ï¼‰
        exponential_base: æŒ‡æ•°åŸºæ•°
        jitter: æ˜¯å¦æ·»åŠ éšæœºæŠ–åŠ¨
        exceptions: éœ€è¦é‡è¯•çš„å¼‚å¸¸ç±»å‹
    """
    def decorator(func):
        @wraps(func)
        def wrapper(*args, **kwargs):
            retries = 0

            while True:
                try:
                    return func(*args, **kwargs)

                except exceptions as e:
                    retries += 1

                    if retries > max_retries:
                        logger.error(
                            f"âŒ {func.__name__} å¤±è´¥ (å·²é‡è¯• {max_retries} æ¬¡): {e}"
                        )
                        raise

                    # è®¡ç®—å»¶è¿Ÿæ—¶é—´
                    delay = min(
                        base_delay * (exponential_base ** (retries - 1)),
                        max_delay
                    )

                    # æ·»åŠ éšæœºæŠ–åŠ¨ï¼ˆé¿å…é‡è¯•é£æš´ï¼‰
                    if jitter:
                        delay = delay * (0.5 + random.random())

                    logger.warning(
                        f"âš ï¸  {func.__name__} å¤±è´¥ï¼Œ{delay:.2f}ç§’åç¬¬{retries}æ¬¡é‡è¯•: {e}"
                    )

                    time.sleep(delay)

        return wrapper
    return decorator

# ä½¿ç”¨ç¤ºä¾‹
import requests
from requests.exceptions import RequestException

@retry_with_exponential_backoff(
    max_retries=5,
    base_delay=1.0,
    exceptions=(RequestException,)
)
def call_external_api(url: str):
    """è°ƒç”¨å¤–éƒ¨ API"""
    response = requests.get(url, timeout=5)
    response.raise_for_status()
    return response.json()

# æµ‹è¯•
try:
    data = call_external_api("https://api.example.com/data")
    print("âœ… æˆåŠŸ:", data)
except RequestException as e:
    print("âŒ æœ€ç»ˆå¤±è´¥:", e)
```

### 2. Circuit Breaker Pattern (æ–­è·¯å™¨æ¨¡å¼)

**é—®é¢˜**ï¼šä¸‹æ¸¸æœåŠ¡æ•…éšœå¯¼è‡´çº§è”å¤±è´¥

**è§£å†³æ–¹æ¡ˆ**ï¼šå¿«é€Ÿå¤±è´¥ï¼Œé¿å…æ— è°“é‡è¯•

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚              æ–­è·¯å™¨çŠ¶æ€æœº                          â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                    â”‚
â”‚           æˆåŠŸæ¬¡æ•°è¾¾åˆ°é˜ˆå€¼                         â”‚
â”‚      â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                    â”‚
â”‚      â”‚                      â”‚                     â”‚
â”‚      â”‚         â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚                    â”‚
â”‚      â””â”€â”€â”€â”€â”€â”€â”€â”€â–¶â”‚  Closed  â”‚â—€â”˜                    â”‚
â”‚      è¶…æ—¶å¤ä½   â”‚  (å…³é—­)  â”‚                      â”‚
â”‚                â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”˜                       â”‚
â”‚                     â”‚ å¤±è´¥ç‡è¶…è¿‡é˜ˆå€¼               â”‚
â”‚                     â–¼                              â”‚
â”‚                â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                       â”‚
â”‚           â”Œâ”€â”€â”€â–¶â”‚  Open    â”‚                       â”‚
â”‚  å¤±è´¥     â”‚    â”‚  (æ‰“å¼€)  â”‚                       â”‚
â”‚           â”‚    â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”˜                       â”‚
â”‚           â”‚         â”‚ è¶…æ—¶å                      â”‚
â”‚           â”‚         â–¼                              â”‚
â”‚           â”‚    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                       â”‚
â”‚           â””â”€â”€â”€â”€â”‚Half-Open â”‚                       â”‚
â”‚                â”‚ (åŠå¼€)   â”‚                       â”‚
â”‚                â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                       â”‚
â”‚                                                    â”‚
â”‚  Closed:   æ­£å¸¸è½¬å‘è¯·æ±‚                           â”‚
â”‚  Open:     ç›´æ¥è¿”å›é”™è¯¯ï¼ˆå¿«é€Ÿå¤±è´¥ï¼‰               â”‚
â”‚  Half-Open: å°è¯•æ€§è½¬å‘ï¼Œæµ‹è¯•æœåŠ¡æ˜¯å¦æ¢å¤          â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

**Python å®ç°**ï¼š
```python
# circuit_breaker.py
import time
import threading
from enum import Enum
from functools import wraps
from collections import deque

class CircuitState(Enum):
    CLOSED = "closed"       # æ­£å¸¸çŠ¶æ€
    OPEN = "open"           # æ–­å¼€çŠ¶æ€
    HALF_OPEN = "half_open" # åŠå¼€çŠ¶æ€

class CircuitBreaker:
    """æ–­è·¯å™¨å®ç°"""

    def __init__(
        self,
        failure_threshold: int = 5,      # å¤±è´¥é˜ˆå€¼
        recovery_timeout: float = 60.0,  # æ¢å¤è¶…æ—¶ï¼ˆç§’ï¼‰
        expected_exception: Type[Exception] = Exception,
        name: str = None
    ):
        self.failure_threshold = failure_threshold
        self.recovery_timeout = recovery_timeout
        self.expected_exception = expected_exception
        self.name = name or "CircuitBreaker"

        # çŠ¶æ€
        self.state = CircuitState.CLOSED
        self.failure_count = 0
        self.last_failure_time = None
        self.success_count = 0

        # çº¿ç¨‹é”
        self._lock = threading.Lock()

        # å¤±è´¥æ—¶é—´çª—å£ï¼ˆç”¨äºç»Ÿè®¡å¤±è´¥ç‡ï¼‰
        self.failure_window = deque(maxlen=100)

    def call(self, func, *args, **kwargs):
        """æ‰§è¡Œå‡½æ•°è°ƒç”¨"""
        with self._lock:
            # æ£€æŸ¥æ˜¯å¦éœ€è¦ä» OPEN åˆ‡æ¢åˆ° HALF_OPEN
            if self.state == CircuitState.OPEN:
                if time.time() - self.last_failure_time >= self.recovery_timeout:
                    self.state = CircuitState.HALF_OPEN
                    self.success_count = 0
                    print(f"ğŸ”„ {self.name}: OPEN -> HALF_OPEN")
                else:
                    raise CircuitBreakerError(
                        f"æ–­è·¯å™¨æ‰“å¼€ï¼Œæ‹’ç»è¯·æ±‚ï¼ˆ{self.recovery_timeout}ç§’åè‡ªåŠ¨æ¢å¤ï¼‰"
                    )

        # å°è¯•æ‰§è¡Œå‡½æ•°
        try:
            result = func(*args, **kwargs)
            self._on_success()
            return result

        except self.expected_exception as e:
            self._on_failure()
            raise

    def _on_success(self):
        """æˆåŠŸå›è°ƒ"""
        with self._lock:
            self.failure_count = 0

            if self.state == CircuitState.HALF_OPEN:
                self.success_count += 1
                # è¿ç»­æˆåŠŸ3æ¬¡ï¼Œå…³é—­æ–­è·¯å™¨
                if self.success_count >= 3:
                    self.state = CircuitState.CLOSED
                    print(f"âœ… {self.name}: HALF_OPEN -> CLOSED (æœåŠ¡æ¢å¤)")

    def _on_failure(self):
        """å¤±è´¥å›è°ƒ"""
        with self._lock:
            self.failure_count += 1
            self.last_failure_time = time.time()
            self.failure_window.append(time.time())

            # HALF_OPEN çŠ¶æ€ä¸‹å¤±è´¥ï¼Œç«‹å³æ‰“å¼€æ–­è·¯å™¨
            if self.state == CircuitState.HALF_OPEN:
                self.state = CircuitState.OPEN
                print(f"âŒ {self.name}: HALF_OPEN -> OPEN (æœåŠ¡ä»æœªæ¢å¤)")

            # CLOSED çŠ¶æ€ä¸‹å¤±è´¥æ¬¡æ•°è¶…è¿‡é˜ˆå€¼
            elif self.state == CircuitState.CLOSED:
                if self.failure_count >= self.failure_threshold:
                    self.state = CircuitState.OPEN
                    print(f"ğŸš¨ {self.name}: CLOSED -> OPEN (å¤±è´¥æ¬¡æ•°: {self.failure_count})")

    def __call__(self, func):
        """è£…é¥°å™¨ç”¨æ³•"""
        @wraps(func)
        def wrapper(*args, **kwargs):
            return self.call(func, *args, **kwargs)
        return wrapper

class CircuitBreakerError(Exception):
    """æ–­è·¯å™¨é”™è¯¯"""
    pass

# ä½¿ç”¨ç¤ºä¾‹
@CircuitBreaker(
    failure_threshold=3,
    recovery_timeout=10.0,
    expected_exception=RequestException,
    name="ExternalAPI"
)
def call_flaky_service():
    """è°ƒç”¨ä¸ç¨³å®šçš„æœåŠ¡"""
    response = requests.get("https://flaky-api.com/data", timeout=2)
    response.raise_for_status()
    return response.json()

# æµ‹è¯•æ–­è·¯å™¨
for i in range(10):
    try:
        result = call_flaky_service()
        print(f"è°ƒç”¨ {i+1}: æˆåŠŸ")
    except CircuitBreakerError as e:
        print(f"è°ƒç”¨ {i+1}: æ–­è·¯å™¨é˜»æ­¢ - {e}")
    except RequestException as e:
        print(f"è°ƒç”¨ {i+1}: æœåŠ¡å¤±è´¥ - {e}")

    time.sleep(1)
```

### 3. Bulkhead Pattern (èˆ±å£éš”ç¦»æ¨¡å¼)

**é—®é¢˜**ï¼šå•ä¸ªèµ„æºè€—å°½å½±å“æ•´ä¸ªç³»ç»Ÿ

**è§£å†³æ–¹æ¡ˆ**ï¼šèµ„æºéš”ç¦»ï¼Œé˜²æ­¢çº§è”å¤±è´¥

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚              èˆ±å£éš”ç¦»æ¶æ„                          â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                    â”‚
â”‚  æ— éš”ç¦»ï¼ˆæ³°å¦å°¼å…‹å·ï¼‰      æœ‰éš”ç¦»ï¼ˆç°ä»£é‚®è½®ï¼‰     â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”      â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚  â”‚                  â”‚      â”‚ ğŸš¢ æœåŠ¡A (20çº¿ç¨‹)â”‚  â”‚
â”‚  â”‚  å…±äº«çº¿ç¨‹æ±       â”‚      â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤  â”‚
â”‚  â”‚  (100çº¿ç¨‹)       â”‚      â”‚ ğŸš¢ æœåŠ¡B (30çº¿ç¨‹)â”‚  â”‚
â”‚  â”‚                  â”‚      â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤  â”‚
â”‚  â”‚  ä¸€ä¸ªæœåŠ¡é˜»å¡    â”‚      â”‚ ğŸš¢ æœåŠ¡C (50çº¿ç¨‹)â”‚  â”‚
â”‚  â”‚  â†“               â”‚      â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â”‚  â”‚  å…¨éƒ¨çº¿ç¨‹è€—å°½ ğŸ’€ â”‚      å•ä¸ªæœåŠ¡æ•…éšœä¸å½±å“å…¶ä»– â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                            â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

**Python å®ç°**ï¼š
```python
# bulkhead_pattern.py
import concurrent.futures
from functools import wraps

class Bulkhead:
    """èˆ±å£éš”ç¦»ï¼šé™åˆ¶å¹¶å‘æ‰§è¡Œæ•°"""

    def __init__(self, max_concurrent: int, name: str = "Bulkhead"):
        self.max_concurrent = max_concurrent
        self.name = name
        self.executor = concurrent.futures.ThreadPoolExecutor(
            max_workers=max_concurrent,
            thread_name_prefix=name
        )

    def __call__(self, func):
        @wraps(func)
        def wrapper(*args, **kwargs):
            try:
                future = self.executor.submit(func, *args, **kwargs)
                return future.result()
            except concurrent.futures.ThreadPoolExecutor as e:
                raise BulkheadFullError(
                    f"{self.name} èµ„æºæ± å·²æ»¡ (max={self.max_concurrent})"
                )
        return wrapper

class BulkheadFullError(Exception):
    pass

# ä½¿ç”¨ç¤ºä¾‹ï¼šä¸ºä¸åŒæœåŠ¡åˆ†é…ç‹¬ç«‹èµ„æºæ± 
payment_service_pool = Bulkhead(max_concurrent=10, name="PaymentService")
email_service_pool = Bulkhead(max_concurrent=5, name="EmailService")
analytics_pool = Bulkhead(max_concurrent=20, name="Analytics")

@payment_service_pool
def process_payment(amount):
    """æ”¯ä»˜æœåŠ¡ï¼ˆå…³é”®æœåŠ¡ï¼Œç‹¬ç«‹æ± ï¼‰"""
    time.sleep(2)  # æ¨¡æ‹Ÿæ…¢æ“ä½œ
    return f"Payment ${amount} processed"

@email_service_pool
def send_email(to, subject):
    """é‚®ä»¶æœåŠ¡ï¼ˆéå…³é”®ï¼Œå°æ± ï¼‰"""
    time.sleep(5)  # æ¨¡æ‹Ÿå¾ˆæ…¢çš„æ“ä½œ
    return f"Email sent to {to}"

@analytics_pool
def log_analytics(event):
    """åˆ†ææœåŠ¡ï¼ˆå¤§é‡å¹¶å‘ï¼Œå¤§æ± ï¼‰"""
    time.sleep(0.1)
    return f"Event logged: {event}"

# å³ä½¿é‚®ä»¶æœåŠ¡é˜»å¡ï¼ˆ5ç§’ï¼‰ï¼Œæ”¯ä»˜æœåŠ¡ä»å¯æ­£å¸¸å·¥ä½œ
```

---

## æ€§èƒ½æ¨¡å¼

### 4. Cache-Aside Pattern (æ—è·¯ç¼“å­˜)

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚              Cache-Aside æµç¨‹                      â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                    â”‚
â”‚  è¯»å–æµç¨‹:                                         â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”  1. æŸ¥è¯¢ç¼“å­˜   â”Œâ”€â”€â”€â”€â”€â”€â”€â”               â”‚
â”‚  â”‚ åº”ç”¨ â”‚â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¶â”‚ Cache â”‚               â”‚
â”‚  â””â”€â”€â”€â”¬â”€â”€â”˜                â””â”€â”€â”€â”¬â”€â”€â”€â”˜               â”‚
â”‚      â”‚                       â”‚                    â”‚
â”‚      â”‚ 2. ç¼“å­˜æœªå‘½ä¸­ (miss)  â”‚                    â”‚
â”‚      â”‚                       â”‚                    â”‚
â”‚      â”‚  3. æŸ¥è¯¢æ•°æ®åº“  â”Œâ”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”              â”‚
â”‚      â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¶â”‚ Database â”‚              â”‚
â”‚      â”‚                 â””â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”˜              â”‚
â”‚      â”‚ 4. è¿”å›æ•°æ®           â”‚                    â”‚
â”‚      â—€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                    â”‚
â”‚      â”‚                                            â”‚
â”‚      â”‚  5. å†™å…¥ç¼“å­˜    â”Œâ”€â”€â”€â”€â”€â”€â”€â”                 â”‚
â”‚      â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¶â”‚ Cache â”‚                 â”‚
â”‚                        â””â”€â”€â”€â”€â”€â”€â”€â”˜                  â”‚
â”‚                                                    â”‚
â”‚  å†™å…¥æµç¨‹:                                         â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”  1. å†™æ•°æ®åº“  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”             â”‚
â”‚  â”‚ åº”ç”¨ â”‚â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¶â”‚ Database â”‚             â”‚
â”‚  â””â”€â”€â”€â”¬â”€â”€â”˜                â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜             â”‚
â”‚      â”‚                                            â”‚
â”‚      â”‚  2. åˆ é™¤ç¼“å­˜    â”Œâ”€â”€â”€â”€â”€â”€â”€â”                 â”‚
â”‚      â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¶â”‚ Cache â”‚ (å¤±æ•ˆ)          â”‚
â”‚                        â””â”€â”€â”€â”€â”€â”€â”€â”˜                  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

**Python å®ç°**ï¼š
```python
# cache_aside.py
import redis
import json
import hashlib
from functools import wraps
from typing import Optional, Callable

class CacheAside:
    """æ—è·¯ç¼“å­˜è£…é¥°å™¨"""

    def __init__(
        self,
        redis_client: redis.Redis,
        ttl: int = 3600,
        key_prefix: str = "cache"
    ):
        self.redis = redis_client
        self.ttl = ttl
        self.key_prefix = key_prefix

    def _generate_cache_key(self, func_name: str, args, kwargs) -> str:
        """ç”Ÿæˆç¼“å­˜é”®"""
        # å°†å‚æ•°åºåˆ—åŒ–ä¸ºå­—ç¬¦ä¸²
        params_str = json.dumps({
            'args': args,
            'kwargs': kwargs
        }, sort_keys=True)

        # MD5 å“ˆå¸Œ
        hash_value = hashlib.md5(params_str.encode()).hexdigest()

        return f"{self.key_prefix}:{func_name}:{hash_value}"

    def __call__(self, func: Callable):
        @wraps(func)
        def wrapper(*args, **kwargs):
            # 1. ç”Ÿæˆç¼“å­˜é”®
            cache_key = self._generate_cache_key(func.__name__, args, kwargs)

            # 2. å°è¯•ä»ç¼“å­˜è¯»å–
            cached_value = self.redis.get(cache_key)
            if cached_value:
                print(f"âœ… ç¼“å­˜å‘½ä¸­: {cache_key}")
                return json.loads(cached_value)

            print(f"âŒ ç¼“å­˜æœªå‘½ä¸­: {cache_key}")

            # 3. ç¼“å­˜æœªå‘½ä¸­ï¼Œæ‰§è¡Œå‡½æ•°
            result = func(*args, **kwargs)

            # 4. å†™å…¥ç¼“å­˜
            self.redis.setex(
                cache_key,
                self.ttl,
                json.dumps(result, default=str)
            )

            return result

        return wrapper

# ä½¿ç”¨ç¤ºä¾‹
redis_client = redis.Redis(host='localhost', port=6379, db=0)
cache = CacheAside(redis_client, ttl=600)

@cache
def get_user_profile(user_id: int):
    """ä»æ•°æ®åº“è·å–ç”¨æˆ·èµ„æ–™ï¼ˆæ…¢æ“ä½œï¼‰"""
    print(f"  ğŸ“Š æŸ¥è¯¢æ•°æ®åº“: user_id={user_id}")
    time.sleep(2)  # æ¨¡æ‹Ÿæ•°æ®åº“æŸ¥è¯¢
    return {
        'user_id': user_id,
        'name': f'User {user_id}',
        'email': f'user{user_id}@example.com'
    }

def update_user_profile(user_id: int, data: dict):
    """æ›´æ–°ç”¨æˆ·èµ„æ–™"""
    # 1. æ›´æ–°æ•°æ®åº“
    print(f"  ğŸ’¾ æ›´æ–°æ•°æ®åº“: user_id={user_id}")
    # db.users.update({'user_id': user_id}, data)

    # 2. åˆ é™¤ç¼“å­˜ï¼ˆCache Invalidationï¼‰
    cache_key = f"cache:get_user_profile:{user_id}"
    redis_client.delete(cache_key)
    print(f"  ğŸ—‘ï¸  åˆ é™¤ç¼“å­˜: {cache_key}")

# æµ‹è¯•
print("ç¬¬1æ¬¡è°ƒç”¨ï¼ˆç¼“å­˜æœªå‘½ä¸­ï¼‰:")
profile = get_user_profile(123)  # 2ç§’

print("\nç¬¬2æ¬¡è°ƒç”¨ï¼ˆç¼“å­˜å‘½ä¸­ï¼‰:")
profile = get_user_profile(123)  # <1ms

print("\næ›´æ–°èµ„æ–™:")
update_user_profile(123, {'name': 'New Name'})

print("\nç¬¬3æ¬¡è°ƒç”¨ï¼ˆç¼“å­˜å·²å¤±æ•ˆï¼‰:")
profile = get_user_profile(123)  # 2ç§’
```

### 5. CQRS Pattern (å‘½ä»¤æŸ¥è¯¢èŒè´£åˆ†ç¦»)

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚              CQRS æ¶æ„                             â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                    â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”                                      â”‚
â”‚  â”‚  å®¢æˆ·ç«¯ â”‚                                      â”‚
â”‚  â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”˜                                      â”‚
â”‚       â”‚                                            â”‚
â”‚  â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€           â”‚
â”‚       â”‚                                            â”‚
â”‚  â”Œâ”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”          â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”      â”‚
â”‚  â”‚   å‘½ä»¤ API   â”‚          â”‚   æŸ¥è¯¢ API    â”‚      â”‚
â”‚  â”‚  (å†™æ“ä½œ)    â”‚          â”‚  (è¯»æ“ä½œ)     â”‚      â”‚
â”‚  â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜          â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”˜      â”‚
â”‚       â”‚                            â”‚               â”‚
â”‚  â”Œâ”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”          â”Œâ”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”      â”‚
â”‚  â”‚  å†™æ•°æ®åº“    â”‚          â”‚  è¯»æ•°æ®åº“     â”‚      â”‚
â”‚  â”‚  (PostgreSQL)â”‚â”€äº‹ä»¶åŒæ­¥â”€â–¶â”‚  (ES/MongoDB)â”‚      â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜          â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜      â”‚
â”‚   æ ‡å‡†åŒ–å­˜å‚¨                   ä¼˜åŒ–æŸ¥è¯¢             â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

**å®ç°ç¤ºä¾‹** (è§ä¸‹é¡µ)

---

## æ€»ç»“

### æ¨¡å¼é€‰æ‹©çŸ©é˜µ

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚   åœºæ™¯       â”‚  æ¨èæ¨¡å¼ â”‚  å¤æ‚åº¦    â”‚  æ”¶ç›Š    â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ API è°ƒç”¨å¤±è´¥ â”‚  Retry    â”‚  ä½ â­     â”‚  é«˜      â”‚
â”‚ æœåŠ¡é›ªå´©     â”‚  Circuit  â”‚  ä¸­ â­â­   â”‚  æé«˜    â”‚
â”‚ èµ„æºéš”ç¦»     â”‚  Bulkhead â”‚  ä¸­ â­â­   â”‚  é«˜      â”‚
â”‚ æ•°æ®åº“å‹åŠ›   â”‚  Cache    â”‚  ä½ â­     â”‚  æé«˜    â”‚
â”‚ è¯»å†™åˆ†ç¦»     â”‚  CQRS     â”‚  é«˜ â­â­â­ â”‚  ä¸­      â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### ä¸‹ä¸€æ­¥å­¦ä¹ 

- [04_multi_cloud.md](04_multi_cloud.md) - å¤šäº‘ä¸æ··åˆäº‘
- [05_cost_optimization.md](05_cost_optimization.md) - æˆæœ¬ä¼˜åŒ–
